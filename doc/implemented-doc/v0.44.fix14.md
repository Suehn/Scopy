# v0.44.fix14

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Dedup：修复“文本去重不准确”导致的重复条目问题，重点覆盖 RTF/HTML 等富文本在不同复制来源下 payload 波动但主文本一致的场景。

### Why

- v0.md 3.2 明确文本去重应基于“标准化后的字符串（去首尾空白、统一换行）”。
- 实际上 RTF/HTML 的原始 payload 常包含可变 metadata（如样式/导出细节/编码差异），即使用户复制到的可见文本完全相同，其二进制内容也可能不同；若直接对 payload 计算 `contentHash`，就会出现“看起来一样但 hash 不同 → 去重失败 → 列表重复”的现象（与截图反馈一致）。

### Result

- RTF/HTML 的 `contentHash` 改为基于 `plainText`（标准化主文本）计算，避免 payload 波动造成重复入库。
- 文本标准化补强：新增 Unicode 行分隔符、NBSP、BOM 的归一化，减少“肉眼一致但 hash 不同”的边界。
- 新增回归测试覆盖上述场景，防止回归。

---

## 📂 核心改动

- `Scopy/Services/ClipboardMonitor.swift`
  - `rtf/html` 的 `contentHash` 改为基于 `plainText` 计算（payload 仅用于存储/恢复，不参与文本去重）。
  - `normalizeText` 扩展：支持 U+2028/U+2029/U+0085 → `\n`，NBSP → 空格，BOM 清理。
- `ScopyTests/ClipboardMonitorTests.swift`
  - 新增 RTF/HTML payload 不同但 `plainText` 相同的 `contentHash` 一致性测试。
  - 新增 Unicode 换行/NBSP/BOM 标准化测试。

---

## ✅ 测试

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`：Executed 236 tests, 7 skipped, 0 failures

