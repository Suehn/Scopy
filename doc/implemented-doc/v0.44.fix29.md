# v0.44.fix29

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Preview：Markdown/LaTeX 渲染导出 PNG 更可靠：表格按可用宽度缩放避免截断；支持“仅导出到剪贴板 / 导出并写入历史”两种按钮；导出尺寸上限更新（短边 ≤1500px，长边 ≤65536px）。

### Why

- 现网导出在少数场景出现“白图/空白”与“表格缩放后仍轻微截断”，本质上来自：渲染/样式应用尚未稳定就 snapshot，以及 `zoom`/亚像素 rounding 在 WKWebView snapshot 下的不确定性。
- 用户需要明确区分“导出只是临时复制”与“导出应当被 Scopy 记录”的语义。

### Result

- Export 渲染链路改为显式等待：markdown 渲染完成 + export-mode CSS 生效（`#content` opacity）+（如有）首次 KaTeX 完成，再执行 snapshot，避免白图。
- Export 表格适配改为 wrapper + `transform: scale(...)`（不再依赖 `zoom`），并用 `getBoundingClientRect()` 校正 subpixel rounding，降低“缩放后仍被截断”的概率。
- UI：导出按钮拆分为两枚（入历史 / 仅复制）；Exact(Fts) 排序切换按钮改为立即触发搜索，分页请求也携带 `sortMode`；主窗口默认宽度轻微收窄。

---

## 🏗️ 实现路线

1. 调整导出专用渲染器 `MarkdownExportRenderer`：在 snapshot 前显式等待渲染/样式稳定，并在 resize 后二次 table-fit+测量。
2. 调整 HTML export-mode：table 用 wrapper+transform 缩放；加入 overflow 诊断函数；移除 `zoom` 路径。
3. UI 拆分导出按钮并补齐 Service API（支持“仅复制/是否入历史”）。
4. 修复 FTS 排序切换触发与分页携带参数，避免“按钮看起来不生效”。
5. 更新/补齐单测与 release tooling（fix tag 的版本 bump）。

---

## 📂 核心改动

- `Scopy/Views/History/MarkdownHTMLRenderer.swift`：export-mode 表格缩放改为 wrapper+transform；新增 `__scopyMathRendered/__scopyHasMath`；新增 `__scopyExportHasHorizontalOverflow()`。
- `Scopy/Views/History/MarkdownPreviewWebView.swift`：新增 `MarkdownExportRenderer` 并加强导出 ready waits（markdown/CSS/math）；resize 后二次 fit+测量。
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`：导出按钮拆分为“入历史/仅复制”两枚，并改走 `MarkdownExportRenderer`。
- `Scopy/Domain/Protocols/ClipboardServiceProtocol.swift` / `Scopy/Application/ClipboardService.swift` / `Scopy/Services/ClipboardMonitor.swift`：支持 `recordInHistory` 语义。
- `Scopy/Observables/HistoryViewModel.swift`：FTS sort toggle 立即触发搜索 + `loadMore()` 携带 `sortMode`。
- `scripts/release/bump-version.sh`：支持 `vX.Y.fixN` 的 patch bump。
- `ScopyTests/MarkdownExportSizingTests.swift`：导出尺寸 clamp 回归。

---

## 🎯 关键指标

- 单元测试：`make test-unit` ✅（Executed 224 tests, 1 skipped，0 failures；2025-12-18）
- UI 测试：本次未重新验证（环境可能触发系统权限弹窗导致 flaky）

---

## 📊 当前状态

- 单元测试：`make test-unit` ✅
- Strict Concurrency：未运行（如需：`make test-strict`）

---

## 🔮 遗留与后续

- 若仍遇到“导出表格偶发截断”，建议补充一组可复现样例（markdown 原文 + 导出容器宽度），便于把 overflow 诊断收敛为自动重试/自适应 margin 的硬门槛。
- 若要把“导出不空白”变成 CI 硬门槛，需要解决测试宿主下 WebKit 进程权限限制（目前单测环境无法稳定跑 WKWebView snapshot）。
