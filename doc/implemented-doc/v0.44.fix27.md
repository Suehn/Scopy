# v0.44.fix27

> çŠ¶æ€ï¼šâœ…

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Feat/Previewï¼šhover Markdown/LaTeX é¢„è§ˆå³ä¸Šè§’æ–°å¢ â€œExport PNGâ€ æŒ‰é’®ï¼Œä¸€é”®å¯¼å‡ºåˆ°å‰ªè´´æ¿ï¼ˆæˆåŠŸ/å¤±è´¥åé¦ˆ 1.5s è‡ªåŠ¨æ¢å¤ï¼‰ã€‚
- Fix/Exportï¼šå¯¼å‡º PNG å›ºå®šå®½ 1080pxï¼Œé«˜åº¦æŒ‰å†…å®¹åŠ¨æ€è‡ªé€‚åº”ï¼›é•¿å†…å®¹é‡‡ç”¨åˆ†ç‰‡ snapshot å¹¶æ‹¼æ¥ä¸ºå•å¼ é•¿å›¾ã€‚
- Fix/Exportï¼šå®½è¡¨æ ¼ä¼˜å…ˆå°‘æ¢è¡Œï¼ˆno-wrap + è½»é‡ç¼©æ”¾ï¼‰ï¼Œç¼©æ”¾è¿‡å°åˆ™å›é€€æ¢è¡Œå¸ƒå±€ï¼›å¯¼å‡ºæœ«å°¾è‡ªåŠ¨è£å‰ªå¤šä½™ç™½åº•ã€‚
- Fix/Previewï¼šè¡¨æ ¼å°½é‡å°‘æ¢è¡Œï¼ˆæ¨ªå‘æ»šåŠ¨ï¼‰ï¼›ATX æ ‡é¢˜ç¼ºç©ºæ ¼ï¼ˆ`##æ ‡é¢˜`ï¼‰è‡ªåŠ¨æ ‡å‡†åŒ–ä¸º `## æ ‡é¢˜`ï¼Œæ¢å¤å¤šçº§æ ‡é¢˜å¯è¯»æ€§ã€‚
- Testï¼šæ–°å¢ Export PNG UI testsï¼ˆå°ºå¯¸/è¡¨æ ¼/å‰ªè´´æ¿/åº•éƒ¨ç©ºç™½ç­‰ï¼‰ä¸æ ‡é¢˜è§„èŒƒåŒ–å›å½’æµ‹è¯•ã€‚

### Why

- é¢„è§ˆå†…å®¹ç»å¸¸éœ€è¦â€œå¸¦æ ¼å¼â€ç²˜è´´åˆ°å…¶ä»– Appï¼›PNG æ˜¯è·¨åº”ç”¨æœ€ç¨³å®šçš„è½½ä½“ã€‚
- WebKit æ¸²æŸ“/æµ‹é‡åœ¨é•¿å†…å®¹ä¸å®½è¡¨æ ¼åœºæ™¯ä¸‹å®¹æ˜“å‡ºç°ï¼šé«˜åº¦æµ‹é‡åå·®ã€åº•éƒ¨å¼‚å¸¸ç•™ç™½ã€è¡¨æ ¼è¿‡åº¦æ¢è¡Œæˆ–ç¼©æ”¾è¿‡å¤´ï¼Œéœ€è¦ä»¥å¯è§‚æµ‹ä¸å¯å›å½’çš„æ–¹å¼æ”¶æ•›ã€‚
- éƒ¨åˆ† Markdown æ¥æºä¸ä¸¥æ ¼éµå¾ª CommonMarkï¼ˆå¦‚ `##æ ‡é¢˜`ï¼‰ï¼Œä¼šå¯¼è‡´æ ‡é¢˜è¢«å½“ä½œæ™®é€šæ–‡æœ¬ï¼Œå±‚çº§â€œçœ‹èµ·æ¥ä¸€æ ·â€ã€‚

### Result

- å¯¼å‡ºæ›´ç¨³ï¼šçŸ­å†…å®¹ä¸ paddedã€é•¿å†…å®¹å¯å¯¼å‡ºä¸ºå•å¼ é•¿å›¾ã€å®½è¡¨æ ¼æ›´å°‘æ¢è¡Œä¸”ä¸ä¼šè¿‡åº¦ç¼©å°ã€åº•éƒ¨ç™½åº•å°¾å·´è¢«è£å‰ªã€‚
- é¢„è§ˆæ›´ä¸€è‡´ï¼šæ ‡é¢˜å±‚çº§æ›´æ˜ç¡®ï¼Œè¡¨æ ¼æ›´å°‘æ¢è¡Œï¼Œä¸”ä¸å½±å“é Markdown é¢„è§ˆä¸ç°æœ‰åŠŸèƒ½ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Views/History/MarkdownExportService.swift`
  - ç¦»å± WKWebView æ¸²æŸ“ + åŠ¨æ€é«˜åº¦æµ‹é‡ + tile snapshot æ‹¼æ¥ + ç™½åº•è£å‰ªã€‚
  - è¡¨æ ¼ç¼©æ”¾/æ¢è¡Œç­–ç•¥ä¸ `SCOPY_EXPORT_TABLE_METRICS_PATH` è¯Šæ–­è¾“å‡ºã€‚
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`
  - é¢„è§ˆå³ä¸Šè§’ Export æŒ‰é’®ä¸çŠ¶æ€åé¦ˆï¼›å¯¼å‡ºå›ºå®šç›®æ ‡å®½ 1080pxã€‚
- `Scopy/Views/History/HoverPreviewModel.swift`
  - å¢åŠ å¯¼å‡ºçŠ¶æ€å­—æ®µï¼ˆ`isExporting` / `exportSuccess` / `exportFailed` / `exportErrorMessage`ï¼‰ã€‚
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`
  - ATX heading è§„èŒƒåŒ–ï¼ˆ`##æ ‡é¢˜` -> `## æ ‡é¢˜`ï¼‰ï¼›è¡¨æ ¼ CSS è°ƒæ•´ï¼ˆæ¨ªå‘æ»šåŠ¨ã€å°½é‡å°‘æ¢è¡Œï¼‰ã€‚
- `Scopy/AppDelegate.swift`
  - `--uitesting` ä¸‹æ”¯æŒè‡ªåŠ¨å¯¼å‡ºä¸å¯¼å‡º harness windowï¼ˆç”¨äºç¨³å®šç«¯åˆ°ç«¯æµ‹è¯•ï¼‰ã€‚
- `Scopy/Services/MockClipboardService.swift`
  - å¢åŠ  UI å¯¼å‡ºéªŒè¯ç”¨ Markdown æ ·ä¾‹ï¼ˆ`SCOPY_EXPORT_TEST_MARKDOWN`ï¼‰ã€‚
- `ScopyTests/MarkdownExportServiceTests.swift`
  - PNG å†™å…¥ pasteboard å›å½’ã€‚
- `ScopyTests/MarkdownMathRenderingTests.swift`
  - æ–°å¢ ATX heading è§„èŒƒåŒ–å›å½’ã€‚
- `ScopyUITests/ExportMarkdownPNGUITests.swift`
  - å¯¼å‡ºç«¯åˆ°ç«¯è¦†ç›–ï¼ˆå®½åº¦/é«˜åº¦/è¡¨æ ¼/å‰ªè´´æ¿/åº•éƒ¨ç©ºç™½/æŒ‰é’®è§¦å‘ç­‰ï¼‰ã€‚
- `ScopyUITests/Fixtures/temp.txt`
  - çœŸå®è¡¨æ ¼å¤¹å…·ç”¨äºå›å½’ã€‚

---

## ğŸ¯ æµ‹è¯•

- å•æµ‹ï¼š`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/MarkdownExportServiceTests`ï¼šâœ…
- å•æµ‹ï¼š`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/MarkdownMathRenderingTests/testMarkdownRendererNormalizesATXHeadingsWithoutSpaceOutsideCodeBlocks`ï¼šâœ…
- UI testsï¼ˆå¯¼å‡ºä¸“ç”¨ï¼‰ï¼š`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyUITests/ExportMarkdownPNGUITests`ï¼šâœ…

---

## ğŸ”® é—ç•™ä¸åç»­

- å¯¼å‡ºé•¿å›¾å­˜åœ¨åƒç´ /å†…å­˜ä¸Šé™ï¼›å½“å‰ä¼šåœ¨å¿…è¦æ—¶æŒ‰åƒç´ é¢„ç®—ç¼©å°å…¨å±€å­—å·ä»¥ä¿æŒå•å¼ å›¾å¯¼å‡ºæˆåŠŸã€‚è‹¥æœªæ¥éœ€è¦â€œä¿æŒå­—å· + å¤šå¼ åˆ†æ®µå¯¼å‡ºâ€ï¼Œå¯åœ¨ Settings å¢åŠ ç­–ç•¥å¼€å…³ã€‚
