# v0.23 - æ·±åº¦ä»£ç å®¡æŸ¥ä¿®å¤

**æ—¥æœŸ**: 2025-12-11

---

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“

### What
åŸºäºæ·±åº¦ä»£ç å®¡æŸ¥ï¼Œä¿®å¤ 13 ä¸ªç¨³å®šæ€§ã€æ€§èƒ½å’Œä»£ç è´¨é‡é—®é¢˜ï¼Œæ¶µç›– P0 åˆ° P3 ä¼˜å…ˆçº§ã€‚

### Why
- ä¹‹å‰å¤šæ¬¡ä¿®å¤åä»å­˜åœ¨æ½œåœ¨é—®é¢˜
- `nonisolated(unsafe)` å­˜åœ¨æ•°æ®ç«äº‰é£é™©
- ç¼“å­˜å®ç°è¿èƒŒä¼˜åŒ–åˆè¡·
- å¼ºåˆ¶è§£åŒ…å¯èƒ½å¯¼è‡´å´©æºƒ

### Result
- **161/161 æµ‹è¯•é€šè¿‡** (1 skipped)
- æ¶ˆé™¤æ‰€æœ‰ P0/P1 é—®é¢˜
- ä»£ç è´¨é‡æ˜¾è‘—æå‡

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. **P0-1**: ä½¿ç”¨ actor æ›¿ä»£ `nonisolated(unsafe)` é™æ€å±æ€§
2. **P0-2**: ä¿®å¤ relativeTime ç¼“å­˜å®ç°ï¼Œåœ¨é”å¤–è·å–æ—¶é—´æˆ³
3. **P1-1**: ç§»é™¤ SearchService ä¸­çš„å¼ºåˆ¶è§£åŒ…
4. **P1-2**: ç®€åŒ– ClipboardMonitor ä»»åŠ¡é˜Ÿåˆ—åŒæ­¥é€»è¾‘
5. **P2**: æ”¹è¿›æ•°æ®åº“æ¢å¤é€»è¾‘ã€æ—¥å¿—å¼‚æ­¥å†™å…¥ã€ç§»é™¤é˜»å¡ç­‰å¾…
6. **P3**: æ·»åŠ é”™è¯¯æ—¥å¿—ã€ä¿®å¤ var/let é—®é¢˜

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

### æ–°å¢æ–‡ä»¶
| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `Scopy/Services/ThumbnailGenerationTracker.swift` | ç¼©ç•¥å›¾ç”ŸæˆçŠ¶æ€è·Ÿè¸ª actor |

### ä¿®æ”¹æ–‡ä»¶
| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `RealClipboardService.swift` | ä½¿ç”¨ actor æ›¿ä»£ nonisolated(unsafe) |
| `HistoryListView.swift` | ä¿®å¤ relativeTime ç¼“å­˜å®ç° |
| `SearchService.swift` | ç§»é™¤å¼ºåˆ¶è§£åŒ…ï¼Œä½¿ç”¨ guard let |
| `ClipboardMonitor.swift` | ç®€åŒ–ä»»åŠ¡é˜Ÿåˆ—åŒæ­¥é€»è¾‘ |
| `StorageService.swift` | æ·»åŠ  isDatabaseCorrupted æ ‡å¿—ã€é”™è¯¯æ—¥å¿— |
| `HotKeyService.swift` | æ—¥å¿—å†™å…¥æ”¹ä¸ºå¼‚æ­¥é˜Ÿåˆ— |
| `AppState.swift` | ä¿ç•™ loadMore ç­‰å¾…é€»è¾‘ |
| `ClipboardServiceProtocol.swift` | var æ”¹ä¸º let |

---

## ğŸ¯ å…³é”®ä¿®å¤è¯¦æƒ…

### P0-1: nonisolated(unsafe) æ•°æ®ç«äº‰
**é—®é¢˜**: `thumbnailGenerationInProgress` ä½¿ç”¨ `nonisolated(unsafe)` æ ‡è®°ï¼Œè™½æœ‰é”ä¿æŠ¤ä½†å­˜åœ¨é£é™©ã€‚

**ä¿®å¤**: åˆ›å»º `ThumbnailGenerationTracker` actorï¼Œåˆ©ç”¨ Swift å¹¶å‘æ¨¡å‹ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚

```swift
// æ–°å¢ actor
actor ThumbnailGenerationTracker {
    static let shared = ThumbnailGenerationTracker()
    private var inProgress = Set<String>()

    func tryMarkInProgress(_ contentHash: String) -> Bool { ... }
    func markCompleted(_ contentHash: String) { ... }
}
```

### P0-2: relativeTime ç¼“å­˜å®ç°é—®é¢˜
**é—®é¢˜**: åœ¨é”å†…åˆ›å»º `Date()` å¯¹è±¡ï¼Œè¿èƒŒç¼“å­˜ä¼˜åŒ–åˆè¡·ã€‚

**ä¿®å¤**: åœ¨é”å¤–è·å–æ—¶é—´æˆ³ï¼Œé”å†…åªåšæ¯”è¾ƒå’Œæ›´æ–°ã€‚

```swift
// ä¿®å¤å‰ï¼šé”å†…åˆ›å»º Date
let currentTimestamp = Date().timeIntervalSince1970  // åœ¨é”å†…

// ä¿®å¤åï¼šé”å¤–è·å–æ—¶é—´æˆ³
let currentTimestamp = Date().timeIntervalSince1970  // åœ¨é”å¤–
let now = Self.relativeTimeLock.withLock { ... }
```

### P1-1: SearchService å¼ºåˆ¶è§£åŒ…
**é—®é¢˜**: `searchFuzzy` å’Œ `searchFuzzyPlus` ä½¿ç”¨ `db!` å¼ºåˆ¶è§£åŒ…ã€‚

**ä¿®å¤**: ä½¿ç”¨ `guard let db = db else { throw ... }` æ¨¡å¼ã€‚

### P1-2: ClipboardMonitor ä»»åŠ¡é˜Ÿåˆ—åŒæ­¥
**é—®é¢˜**: `processingQueue` å’Œ `taskIDMap` åŒæ­¥é€»è¾‘å¤æ‚ï¼Œä½¿ç”¨ `===` æ¯”è¾ƒ Task å¯¼è‡´ç¼–è¯‘é”™è¯¯ã€‚

**ä¿®å¤**: ç®€åŒ–ä¸º taskIDMap ä½œä¸ºå”¯ä¸€æ•°æ®æºï¼ŒprocessingQueue ä» taskIDMap é‡å»ºã€‚

### P2: æ—¥å¿—å¼‚æ­¥å†™å…¥
**é—®é¢˜**: HotKeyService æ—¥å¿—å†™å…¥åœ¨é”å†…æ‰§è¡Œæ–‡ä»¶ I/Oï¼Œå¯èƒ½é˜»å¡è°ƒç”¨çº¿ç¨‹ã€‚

**ä¿®å¤**: ä½¿ç”¨ä¸²è¡Œ DispatchQueue å¼‚æ­¥å†™å…¥ã€‚

### P2: æ•°æ®åº“æ¢å¤çŠ¶æ€
**é—®é¢˜**: æ•°æ®åº“æ¢å¤å¤±è´¥åä¸Šå±‚æ— æ³•æ„ŸçŸ¥ã€‚

**ä¿®å¤**: æ·»åŠ  `isDatabaseCorrupted` æ ‡å¿—ã€‚

---

## ğŸ¯ å…³é”®æŒ‡æ ‡

### æµ‹è¯•ç»“æœ
- **å•å…ƒæµ‹è¯•**: 161/161 passed (1 skipped)
- **ç¼–è¯‘**: Debug âœ…
- **æ— æ–°å¢è­¦å‘Š**

### ä¿®å¤ç»Ÿè®¡
| ä¼˜å…ˆçº§ | æ•°é‡ | çŠ¶æ€ |
|--------|------|------|
| P0 ä¸¥é‡ | 2 | âœ… å·²ä¿®å¤ |
| P1 é«˜ | 2 | âœ… å·²ä¿®å¤ |
| P2 ä¸­ | 4 | âœ… å·²ä¿®å¤ |
| P3 ä½ | 3 | âœ… å·²ä¿®å¤ |

---

## ğŸ“Š å½“å‰çŠ¶æ€

```
âœ… ç¼–è¯‘é€šè¿‡
âœ… 161/161 æµ‹è¯•é€šè¿‡
âœ… æ— æ•°æ®ç«äº‰é£é™©
âœ… æ— å¼ºåˆ¶è§£åŒ…
âœ… æ—¥å¿—ä¸é˜»å¡ä¸»çº¿ç¨‹
```

---

## ğŸ”® é—ç•™ä¸åç»­

### å·²è§£å†³
- [x] nonisolated(unsafe) æ•°æ®ç«äº‰é£é™©
- [x] relativeTime ç¼“å­˜å®ç°é—®é¢˜
- [x] SearchService å¼ºåˆ¶è§£åŒ…
- [x] ClipboardMonitor ä»»åŠ¡é˜Ÿåˆ—åŒæ­¥
- [x] æ—¥å¿—å†™å…¥é˜»å¡
- [x] æ•°æ®åº“æ¢å¤çŠ¶æ€ä¸å¯è§

### å¯é€‰ä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
- [ ] ç¼©ç•¥å›¾ç¼“å­˜ LRU æ”¹ç”¨ O(1) å®ç°ï¼ˆå½“å‰ O(n) å¯¹ 1000 é¡¹å½±å“ä¸å¤§ï¼‰
- [ ] é…ç½®å¸¸é‡æå–åˆ°è®¾ç½®ï¼ˆcacheDuration, shortQueryCacheSizeï¼‰

---

**ç»´æŠ¤è€…**: Claude Code
**æœ€åæ›´æ–°**: 2025-12-11
