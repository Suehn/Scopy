# v0.31 - vNext 重构：Persistence actor + SQLite 边界收口

**日期**: 2025-12-13

---

## 一页纸总结

### What

- 新增 `Scopy/Infrastructure/Persistence/*`：`SQLiteConnection`（封装语句/绑定/step）、`SQLiteMigrations`（`PRAGMA user_version`）、`SQLiteClipboardRepository`（actor，统一 DB 归属）。
- `StorageService` 移除 SQLite 直接访问与 `OpaquePointer` 暴露，DB CRUD/统计/清理改为转调 repository；并将若干 DB 相关 API 改为 `async`。
- `SearchService` 不再持有/接收 sqlite 连接指针，改为通过 repository 执行 FTS/过滤/ID 回表等 DB 读取（服务层不再 `import SQLite3`）。

### Why

- 修复 vNext 重构的核心根因之一：SQLite 连接归属不清、`OpaquePointer` 跨组件/跨线程共享导致的稳定性与性能抖动风险。
- 为后续 Phase 3（Search actor + 只读连接分离 + 去 GCD）打下可迁移的 persistence 基座。

### Result

- `OpaquePointer` 仅存在于 `Scopy/Infrastructure/Persistence/*`，服务层不再直接触碰 SQLite 指针/API。
- `make test-unit` 通过（53 tests passed，1 perf skipped），行为保持兼容。

---

## 核心实现

### Persistence actor

- `Scopy/Infrastructure/Persistence/SQLiteConnection.swift`：封装 open/exec/prepare/bind/step/column 读取与 statement 生命周期管理。
- `Scopy/Infrastructure/Persistence/SQLiteMigrations.swift`：基于 `PRAGMA user_version` 的 schema 初始化与迁移入口。
- `Scopy/Infrastructure/Persistence/SQLiteClipboardRepository.swift`：actor 统一 DB 访问（CRUD/统计/FTS/cleanup 计划与批量删除事务）。
- `Scopy/Infrastructure/Persistence/ClipboardStoredItem.swift`：DB 行模型（供 Storage/Search 内部使用）。

### StorageService 收口

- `Scopy/Services/StorageService.swift`：
  - 移除 SQLite3 依赖与 `database` 暴露；DB 操作统一转调 `SQLiteClipboardRepository`。
  - `getOriginalImageData(for:)` 改为 `async`，在需要时从 DB 回表补齐 `rawData`。
  - 清理/统计相关 DB 调用改为 `async`，并保持文件系统清理逻辑不变。

### SearchService 去 sqlite 指针

- `Scopy/Services/SearchService.swift`：移除 `setDatabase` 与 `OpaquePointer` 路径，FTS/过滤/回表等改走 repository。
- `Scopy/Services/RealClipboardService.swift`：装配改为 `SearchService(repository: storage.repository)`，并适配 `StorageService` 的 `async` API。

---

## 修改文件列表（核心）

- `Scopy/Infrastructure/Persistence/ClipboardStoredItem.swift`
- `Scopy/Infrastructure/Persistence/SQLiteConnection.swift`
- `Scopy/Infrastructure/Persistence/SQLiteMigrations.swift`
- `Scopy/Infrastructure/Persistence/SQLiteClipboardRepository.swift`
- `Scopy/Services/StorageService.swift`
- `Scopy/Services/SearchService.swift`
- `Scopy/Services/RealClipboardService.swift`
- `ScopyTests/*`（适配 async API 与新装配方式）

---

## 测试

- 单元测试: `make test-unit` **53 tests passed** (1 perf skipped)

---

## 遗留与后续

- Phase 3：将 Search 收敛为 `Infrastructure/Search/SearchEngineImpl` actor，并引入独立只读连接（读写分离），替换当前 `runOnQueueWithTimeout` 的 GCD 取消语义。

