# v0.39 - Phase 6 收口：Strict Concurrency 回归（Swift 6）+ perf 用例稳定性

**日期**: 2025-12-13

---

## 一页纸总结

### What

- **Strict Concurrency（Swift 6）回归跑通**：修复 `Sendable`/隔离边界问题（UI/MainActor、actor/test captures、UI tests）。
- **HotKeyService 更稳**：统一收口静态共享状态，Carbon 回调只做“查 handler + 节流 + hop 到 MainActor 执行”。
- **perf 用例更稳定**：`testSearchPerformance10kItems` 改为 50 个样本（10 轮 × 5 queries），降低一次性抖动导致的 P95 误报。

### Why

- Swift 6 的严格并发规则会把“以前能跑但不安全”的写法直接升级为编译期失败（尤其是 test 代码与全局闭包捕获）。
- 需要一个可重复的并发回归门槛，确保后续重构不再引入隐性竞态。

### Result

- `SWIFT_STRICT_CONCURRENCY=complete` + `SWIFT_TREAT_WARNINGS_AS_ERRORS=YES` 下，`ScopyTests` 通过（无并发相关 warnings）。
- 单测/性能/TSan 维持通过；关键性能指标无回归（见下方数据）。

---

## 核心实现

### Strict Concurrency：隔离边界收口

- UI 缓存/展示辅助收口为 `@MainActor`：
  - `IconService`、`ThumbnailCache`、`ClipboardItemDisplayText`
  - View 内异步缩略图加载函数显式 `@MainActor`
- 修复 `Sendable` 捕获：
  - XCTest async `setUp/tearDown` 移除不必要的 `super` 调用（避免非 Sendable capture）
  - TaskGroup/Task/DispatchQueue 闭包不再捕获 `self` 或可变局部变量
  - UI tests 统一 `@MainActor` + async `setUp/tearDown`

### HotKeyService：共享状态更明确

- 静态共享状态通过 `NSLock` 包裹成单一 `SharedState`（handlers/eventHandlerRef/lastFire/nextHotKeyID）。
- Carbon 事件回调里读取 handler 后通过 `Task { @MainActor in ... }` 执行，避免跨线程触达 UI。

### perf：P95 采样更稳

- `testSearchPerformance10kItems` 采样从 5 → 50（10 rounds × 5 queries），输出 `Samples` 便于审计。

---

## 修改文件列表（核心）

- `Scopy/AppDelegate.swift`
- `Scopy/Infrastructure/Caching/IconService.swift`
- `Scopy/Infrastructure/Caching/ThumbnailCache.swift`
- `Scopy/Presentation/ClipboardItemDisplayText.swift`
- `Scopy/Services/HotKeyService.swift`
- `Scopy/Services/StorageService.swift`
- `Scopy/Services/ClipboardMonitor.swift`
- `Scopy/Views/SettingsView.swift`
- `Scopy/Views/History/HistoryItemThumbnailView.swift`
- `Scopy/Views/History/HistoryItemView.swift`
- `ScopyTests/*`
- `ScopyUITests/*`
- `.gitignore`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- 性能测试：`make test-perf` **22 tests passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)
- Thread Sanitizer：`make test-tsan` **132 tests passed** (1 skipped)
- Strict Concurrency（ScopyTests）：`xcodebuild test -only-testing:ScopyTests SWIFT_STRICT_CONCURRENCY=complete SWIFT_TREAT_WARNINGS_AS_ERRORS=YES` **166 tests passed** (7 skipped)

### 性能（Debug / `make test-perf` 单次运行）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 4.66ms
  - Fuzzy 10k items P95 ≈ 45.63ms（Samples: 50）
  - Disk 25k fuzzy P95 ≈ 55.89ms
  - Bulk insert 1000 items ≈ 54.96ms（≈18,195 items/s）
  - Fetch recent (50 items) avg ≈ 0.07ms
  - Regex 20k items P95 ≈ 3.04ms
  - Mixed content disk search（single run, after warmup）≈ 4.06ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ Strict Concurrency（ScopyTests）
- ⏳ 热键自查：`/tmp/scopy_hotkey.log`（本版本改动 HotKeyService 线程语义，建议人工自查一次）

---

## 遗留与后续

- （可选）继续拆分 `AppState`（History/Settings ViewModel），缩小 Observation 半径（见 `doc/review/review-v0.3.md` Phase 5）。
- （可选）把 Strict Concurrency 命令固化到 CI/Makefile，作为长期回归门槛。

