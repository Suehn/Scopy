# v0.29 - æ¸è¿›æœç´¢å…¨é‡æ ¡å‡† + å†…å­˜/æ¸²æŸ“/å­˜å‚¨æ€§èƒ½ä¼˜åŒ–

**æ—¥æœŸ**: 2025-12-12

---

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“

### What
- **æ¸è¿›å¼å…¨é‡æ¨¡ç³Šæœç´¢**ï¼šå·¨å¤§å€™é€‰é›†é¦–å±å…ˆèµ° FTS é¢„ç­›å¿«é€Ÿå“åº”ï¼Œåå°å¼ºåˆ¶å…¨é‡ fuzzy/fuzzyPlus æ ¡å‡†ï¼Œä¿è¯æœ€ç»ˆç»“æœé›¶æ¼å¬å›ã€æ’åºä¸€è‡´ã€‚
- **æœç´¢åˆ†é¡µä¸€è‡´æ€§è¡¥å¼º**ï¼šé¢„ç­›é¦–å±åç”¨æˆ·ç«‹å³æ»šåŠ¨æ—¶ï¼Œ`loadMore` å…ˆè§¦å‘ä¸€æ¬¡å…¨é‡æ ¡å‡†å†åˆ†é¡µï¼Œé¿å…â€œå‰é¢ç›¸å…³ã€åé¢å¼±ç›¸å…³/é”™åºâ€çš„ä½“éªŒã€‚
- **P1/P2 æ€§èƒ½æ”¶æ•›**ï¼šå…¨é‡æ¨¡ç³Šç´¢å¼•å†…å­˜ç¼©å‡ã€å¤–éƒ¨å†™å…¥åå°åŒ–ã€Observation/ç¼“å­˜é”ç«äº‰ä¼˜åŒ–ã€‚

### Why
- v0.28 çš„è‡ªé€‚åº” FTS é¢„ç­›è§£å†³äº† 50k/75k é¦–å±æ€§èƒ½ï¼Œä½†**é¦–å±é¢„ç­›ä¸åç»­å…¨é‡åˆ†é¡µçš„æ’åºåŸŸä¸åŒ**ï¼Œç”¨æˆ·å¿«é€Ÿæ»šåŠ¨æ—¶ä¼šçœ‹åˆ°å¼±ç›¸å…³é¡¹æå‰å‡ºç°ã€‚
- å…¨é‡ç´¢å¼•ä¿ç•™ `plainText`+`plainTextLower` åŒä»½é•¿æ–‡æœ¬é©»ç•™ï¼Œè§„æ¨¡åŒ–ä¸‹å†…å­˜ä»æœ‰æ”¾å¤§ã€‚
- ä¸»çº¿ç¨‹ä»æ‰¿æ‹…å¤§å†…å®¹å¤–éƒ¨æ–‡ä»¶å†™å…¥ã€æ‰‹å†™ LRU é”ç«äº‰ã€`AppState` è§‚å¯Ÿé¢åå¤§ç­‰ P1/P2 é£é™©ç‚¹ã€‚

### Result
- **é¦–å±ä»ä¿æŒé¢„ç­›æé€Ÿè¿”å›**ï¼Œéšåè‡ªåŠ¨æ ¡å‡†ä¸ºå…¨é‡ fuzzy/fuzzyPlusï¼›å³ä¾¿ç”¨æˆ·æŠ¢å…ˆ `loadMore`ï¼Œåˆ—è¡¨ä¹Ÿä¼šåœ¨åå°è‡ªåŠ¨å¯¹é½ä¸ºâ€œå…¨é‡ + æ­£ç¡®æ’åºâ€ã€‚
- å…¨é‡ç´¢å¼•å†…å­˜ä¸‹é™ï¼ˆä¸å†åŒä»½æ–‡æœ¬é©»ç•™ï¼‰ï¼Œæ»šåŠ¨/æœç´¢ä¸»çº¿ç¨‹æ›´ç¨³å®šï¼Œå¤§å†…å®¹å¤åˆ¶æ›´å¹³æ»‘ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒå®ç°

### 1) æ¸è¿›å¼å…¨é‡æ ¡å‡†ï¼ˆé¦–å±é¢„ç­› + åå° refineï¼‰

**æ–‡ä»¶**ï¼š`Scopy/Services/SearchService.swift`ã€`Scopy/Observables/AppState.swift`

- `SearchRequest.forceFullFuzzy`ï¼šæ ‡è®°æ˜¯å¦ç¦ç”¨é¦–å±é¢„ç­›ã€‚
- é¢„ç­›è§¦å‘èŒƒå›´æ‰©å±•è‡³ **fuzzy / fuzzyPlus å•è¯æŸ¥è¯¢**ï¼š
  - ä»…å½“ `offset==0`ã€ASCII å•è¯ã€å€™é€‰ â‰¥20k æ—¶è§¦å‘ã€‚
  - è¿”å› `total=-1` è¡¨ç¤ºé¦–å±æ¥è‡ªé¢„ç­›ã€‚
- `AppState.search`ï¼š
  - å½“ `total=-1` æ—¶ï¼Œå»¶è¿Ÿ 250ms åœ¨åå°å‘èµ·åŒ query çš„ `forceFullFuzzy=true` refineã€‚
  - refine å®Œæˆåæ›¿æ¢é¦–å±ç»“æœä¸ºå…¨é‡ fuzzy/fuzzyPlusã€‚

### 2) é¢„ç­›é¦–å±ä¸åˆ†é¡µä¸€è‡´æ€§

**æ–‡ä»¶**ï¼š`Scopy/Observables/AppState.swift`

- è‹¥å½“å‰æœç´¢æ¨¡å¼ä¸º fuzzy/fuzzyPlus ä¸” `totalCount==-1`ï¼ˆé¢„ç­›é¦–å±ä»æœªæ ¡å‡†ï¼‰ï¼š
  - `loadMore` ä¸å†ç›´æ¥åˆ†é¡µè¿½åŠ ï¼›
  - è€Œæ˜¯å…ˆå‘èµ·ä¸€æ¬¡ `offset=0, limit=loadedCount+50, forceFullFuzzy=true` çš„å…¨é‡æ ¡å‡†ï¼Œ
  - ç”¨å…¨é‡æ’åºåŸŸé‡å»ºå‰ N æ¡åå†ç»§ç»­æ­£å¸¸åˆ†é¡µã€‚

### 3) P1/P2 æ€§èƒ½æ”¶æ•›

**æ–‡ä»¶**ï¼š`Scopy/Services/SearchService.swift`ã€`Scopy/Services/StorageService.swift`ã€`Scopy/Views/HistoryListView.swift`ã€`Scopy/Observables/AppState.swift`

- **å…¨é‡ç´¢å¼•å†…å­˜ç¼©å‡**ï¼š
  - `IndexedItem` å»æ‰ `plainText`ï¼Œä»…ä¿ç•™ `plainTextLower` ä¸å¿…è¦å…ƒæ•°æ®ï¼›
  - æœç´¢åˆ†é¡µç»“æœæŒ‰ `id` å›è¡¨è·å–å®Œæ•´ `StoredItem`ã€‚
- **å¤–éƒ¨å†™å…¥åå°åŒ–**ï¼š
  - `StorageService.upsertItem` æ”¹ä¸º `async`ï¼›
  - å¤§å†…å®¹å¤–éƒ¨æ–‡ä»¶å†™å…¥ç”¨ `Task.detached(.utility)` æ‰§è¡Œï¼Œä¸»çº¿ç¨‹åªå†™ DB å…ƒä¿¡æ¯ã€‚
- **æ¸²æŸ“/ç¼“å­˜ç»†èŠ‚ä¼˜åŒ–**ï¼š
  - `HistoryItemView` çš„ icon/thumbnail ç¼“å­˜æ”¹ç”¨ `NSCache` æ›¿ä»£æ‰‹å†™ LRUï¼Œé™ä½é”ç«äº‰ã€‚
  - `AppState` å¯¹ `service`ã€ç¼“å­˜ä¸ Task å¼•ç”¨åŠ  `@ObservationIgnored`ï¼Œç¼©å°é‡ç»˜åŠå¾„ã€‚
- **SQLite housekeeping æŠ‘åˆ¶ç£ç›˜æŠ–åŠ¨**ï¼š
  - `incremental_vacuum` ä»…åœ¨ WAL >128MB æ—¶æ‰§è¡Œã€‚

---

## âœ… ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

- `Scopy/Services/SearchService.swift`
- `Scopy/Services/StorageService.swift`
- `Scopy/Services/RealClipboardService.swift`
- `Scopy/Observables/AppState.swift`
- `Scopy/Protocols/ClipboardServiceProtocol.swift`
- `Scopy/Views/HistoryListView.swift`
- `ScopyTests/*`ï¼ˆAppState/Storage/Search/Perf/Concurrencyï¼‰
- `doc/implemented-doc/v0.29.md`

---

## ğŸ§ª æµ‹è¯• & æ€§èƒ½

- `make test-unit` âœ… **52 tests passed** (1 perf skipped)
- `make test-perf` âœ… **22/22 passedï¼ˆå«é‡è½½ï¼‰**

**æ€§èƒ½å®æµ‹ï¼ˆApple Silicon, macOS 14, Debug, `make test-perf`ï¼‰**ï¼š
- Fuzzy 5k items P95 â‰ˆ 4.91ms
- Fuzzy 10k items P95 â‰ˆ 42.74ms
- Disk 25k fuzzy P95 â‰ˆ 42.30ms
- Heavy Disk 50k fuzzy P95 â‰ˆ 81.24ms
- Ultra Disk 75k fuzzy P95 â‰ˆ 122.17ms

---

## ğŸ”® é—ç•™ä¸åç»­

- å…¨é‡æ¨¡ç³Šç´¢å¼•çš„ postings â€œç©ºæ´æ¯”ä¾‹â€è¿‡é«˜æ—¶å¯åšä¸€æ¬¡åå°é‡å»ºï¼ˆP2ï¼‰ã€‚
- SearchService æœªæ¥å¯ actor åŒ–ç»Ÿä¸€å¹¶å‘è¯­ä¹‰ï¼ˆP1ï¼‰ã€‚

---

**ç»´æŠ¤è€…**: Codex CLI  
**æœ€åæ›´æ–°**: 2025-12-12

