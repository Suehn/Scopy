# v0.43.10 - Dev/Quality：测试隔离 + 性能用例更贴近实际（fuzzyPlus/cold/service path）

**日期**: 2025-12-14

---

## 一页纸总结

### What

- **测试隔离**：`ClipboardMonitor` 支持注入 pasteboard/polling interval；Integration/Monitor 测试改用 unique pasteboard，避免污染系统剪贴板。
- **集成测试提速**：用异步轮询替代固定 `sleep`，并确保逐条写入都被 monitor 捕获（避免漏采）。
- **搜索性能用例更贴近实际**：
  - perf 用例默认使用 `fuzzyPlus`（与 Settings 默认一致）。
  - 增加 cold start 指标（首次 fuzzyPlus 触发全量索引构建）。
  - 增加端到端 service-path 磁盘搜索基线（包含 DTO 转换/actor hop）。
- **测试工作流优化**：Makefile `setup` 增加 XcodeGen 输入签名缓存，避免每次测试都重写 `project.pbxproj`；`make test-unit`/`make test-strict` 默认跳过重用例（Integration/Performance）。
- **Strict Concurrency 兼容**：`SettingsStore` 新增 `init(suiteName:)`，用于测试隔离 settings（避免跨 actor 传递 `UserDefaults`）。

### Why

- 集成/剪贴板相关测试之前使用 `NSPasteboard.general`，会影响开发时真实剪贴板，并且依赖较长的固定 `sleep`，导致**慢且不稳定**。
- perf 用例之前主测 `fuzzy` 并且显式 warmup，和实际默认 `fuzzyPlus` + 首次索引构建（cold start）的体感不一致，导致“**测试结果偏乐观**”。
- Makefile 每次运行测试都会 `xcodegen generate`，会重写 `Scopy.xcodeproj/project.pbxproj` 并增加 rebuild 概率，影响迭代效率。
- Swift 6 Strict 下，跨 actor 传递 `UserDefaults` 会触发 Sendable 错误；测试需要一个不跨 actor 传参的隔离方式。

### Result

- 关键回归通过：
  - `make test-unit`：**137 passed**, 1 skipped（138 total）
  - `make test-integration`：**12 passed**
  - `make test-perf`：**17 passed**, 6 skipped（23 total；heavy 需 `RUN_HEAVY_PERF_TESTS=1`）
  - `make test-tsan`：**137 passed**, 1 skipped（138 total）
  - `make test-strict`：**137 passed**, 1 skipped（138 total；默认 skip Integration/Performance 的运行，但仍编译覆盖）
- perf 数值新增/更贴近真实路径：默认 `fuzzyPlus` + cold start + service-path 端到端基线。

---

## 实现路线

1. `ClipboardMonitor`：增加可注入 pasteboard/polling interval 的初始化能力，并贯穿 copy/read/monitor 全路径。
2. `ClipboardServiceFactory`：暴露测试注入参数（monitor pasteboard / polling interval / settings store）。
3. Integration/Monitor tests：切换到 unique pasteboard，并用 `waitForConditionAsync` 轮询替代固定 `sleep`。
4. Performance tests：
   - 主用例改用 `fuzzyPlus`（与默认模式一致）。
   - 补充 cold start 指标与 service-path 磁盘搜索基线。
5. Makefile：引入 `scripts/xcodegen-generate-if-needed.sh`，基于输入签名缓存跳过无意义的 xcodegen 重写。
6. `SettingsStore`：新增 `init(suiteName:)`，用于 Strict 下测试隔离。

---

## 核心改动

- `Scopy/Services/ClipboardMonitor.swift`
- `Scopy/Application/ClipboardService.swift`
- `Scopy/Services/RealClipboardService.swift`
- `Scopy/Infrastructure/Settings/SettingsStore.swift`
- `ScopyTests/ClipboardMonitorTests.swift`
- `ScopyTests/IntegrationTests.swift`
- `ScopyTests/PerformanceTests.swift`
- `ScopyTests/Helpers/XCTestExtensions.swift`
- `Makefile`
- `scripts/xcodegen-generate-if-needed.sh`

---

## 关键指标

### 测试

- 单元测试：`make test-unit`（137 passed, 1 skipped）
- 集成测试：`make test-integration`（12 passed；无系统剪贴板污染）
- 性能测试：`make test-perf`（17 passed, 6 skipped）
- Thread Sanitizer：`make test-tsan`（137 passed, 1 skipped）
- Strict Concurrency：`make test-strict`（137 passed, 1 skipped）

### 性能（Debug / `make test-perf` 单次运行）

- 环境：MacBook Air（Mac15,12, 24 GB）/ macOS 15.7.2（24G325）/ arm64 / 2025-12-14
- 电源：Low Power Mode disabled（`pmset -g` 显示 `lowpowermode 0`）
- 关键结果：
  - Bulk insert 1000 items ≈ 62.75ms（≈15,935 items/s）
  - Fetch recent (50 items) avg ≈ 0.07ms
  - Regex 20k items P95 ≈ 3.32ms
  - Search cold start 10k (fuzzyPlus) ≈ 132.50ms；steady P95 ≈ 54.00ms（Samples: 50）
  - Search cold start 5k (fuzzyPlus) ≈ 37.43ms；steady P95 ≈ 5.78ms
  - Disk cold start 25k (fuzzyPlus) ≈ 710.09ms；steady P95 ≈ 63.07ms（Samples: 60）
  - Service-path disk 10k cold start (fuzzyPlus) ≈ 255.02ms；steady P95 ≈ 48.86ms（Samples: 50）
  - Mixed content disk search（single run）≈ 4.75ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-integration`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 若要进一步提升 perf 用例对“真实 UI 负载”的贴近程度，可考虑引入可控的“后台噪声”模拟（如同时 ingest/thumbnail 任务），并将其作为可选的 `RUN_HEAVY_PERF_TESTS` 分组用例。

