# v0.44.fix2

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Preview：减少 `$` 误判（货币/变量/日志）导致的 Markdown+KaTeX 错误启用；并对 hover Markdown 预览的尺寸上报与归一化链路做等价的轻量提速。

### Why

- 现实剪贴板内容里 `$` 高概率用于**货币**或**shell 变量**（如 `$HOME`），旧逻辑只要出现两个 `$` 就视为“包含数学公式”，会把纯文本错误走 WebView 渲染管线，带来不必要的成本与潜在样式差异。
- Markdown 预览的尺寸上报会在 burst（字体 ready / ResizeObserver / load）时产生多次调度；虽然最终尺寸去抖了，但仍有额外 rAF/消息尝试开销。

### Result

- 只在检测到成对 `$...$`（或 `$$` / `\\(`/`\\[` / LaTeX 环境 / 已知命令）时才启用 math 渲染，显著降低纯文本误判。
- 同帧内合并尺寸上报调度；并在无 TeX 信号时跳过归一化扫描，hover 预览更省 CPU（渲染结果不变）。

---

## 🏗️ 实现路线

1. 收敛 `MarkdownDetector.containsMath`：用“成对 `$...$`”替代“两个 `$`”的粗判定，并保留原有 `$$`/环境/命令的快捷判定。
2. 为 Markdown 预览尺寸上报加入同帧合并（`pendingRAF`），减少 burst 场景的重复调度。
3. 为 `MathProtector` / `LaTeXInlineTextNormalizer` 增加 fast-path，避免无关输入的扫描。
4. 补齐回归测试：货币/变量/不闭合 `$`（负向）与 `$d$`（正向）。

---

## 📂 核心改动

- `Scopy/Views/History/MarkdownDetector.swift`：修复 `$` 误判逻辑（只认成对 `$...$`）。
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`：尺寸上报调度同帧合并（`pendingRAF`）。
- `Scopy/Views/History/MathProtector.swift`：无 `$`/`\\` 时 fast-path。
- `Scopy/Views/History/LaTeXInlineTextNormalizer.swift`：无相关命令时 fast-path。
- `ScopyTests/MarkdownDetectorTests.swift`：新增检测回归测试覆盖。

---

## 🎯 关键指标

- **测试**：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`
  - Executed 218 tests, 7 skipped, 0 failures
- **环境**：Apple M3 / 24GB；macOS 15.7.2（24G325）；Xcode 16.3（16E140）
- **调度上限（JS）**：`scheduleReportHeight()` 同一帧内最多只会挂起 1 次 rAF（≤60Hz 级别），避免 burst 场景重复调度。

---

## 📊 当前状态

- 单元测试：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests` ✅
- Debug 构建：`./deploy.sh --no-launch` ✅（本地自查）

---

## 🔮 遗留与后续

- 若需要进一步降低误判：可在 `$...$` 判定中加入更强“数学信号”过滤（如包含 `\\`/`_`/`^`/数字/操作符），但这会改变部分边界输入的行为，需要以用户样例驱动决定。
