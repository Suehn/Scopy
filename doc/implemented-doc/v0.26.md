# v0.26 - P0 性能优化：热路径清理节流 + 缩略图异步加载 + 短词全量模糊搜索去噪

**日期**: 2025-12-12

---

## 📌 一页纸总结

### What
- 针对 `doc/review/performance-review-v0.25.md` 中的两个 P0 性能热点落地优化：
  1. **新条目写入热路径 O(N) 清理** → 改为防抖+节流的分级清理。
  2. **列表滚动时主线程缩略图磁盘 I/O** → 改为后台异步读取+主线程赋值。
- **短词（≤2 字符）全量模糊搜索去噪**：仍覆盖全量历史，但改为连续子串语义，避免 subsequence 弱匹配噪音。

### Why
- 复制/入库属于用户最敏感的热路径，任何 O(N) 维护都会在 10k+ 历史下显著拖慢写入和 UI。
- List 滚动的冷启动缩略图读取在 MainActor 同步执行会掉帧，用户可感知。
- 极短 query 全量 subsequence 会产生大量低相关命中，影响“准确/有用”的体验。

### Result
- **写入延迟显著下降**：孤立文件扫描与 vacuum 从每次复制移除，按分钟/小时低频运行。
- **滚动更流畅**：缩略图冷加载不再阻塞主线程。
- **短词搜索更“准确”**：不会在后续分页中出现大量弱相关老记录，同时仍是全量历史搜索。

---

## 🏗️ 核心实现

### 1) 热路径清理节流（StorageService / RealClipboardService）

**文件**：
- `Scopy/Services/StorageService.swift`
- `Scopy/Services/RealClipboardService.swift`

**改动**：
- `StorageService.performCleanup` 增加 `CleanupMode`：
  - `.light`：只做按条数/时间/空间的必要裁剪，不做 `incremental_vacuum` 与 `cleanupOrphanedFiles`。
  - `.full`：保持原完整清理逻辑。
- `RealClipboardService` 不再在 `handleNewContent` 每次复制后直接清理：
  - 新增 `scheduleCleanup()` 防抖（2s）合并连续复制。
  - `runCleanupIfNeeded()` 节流：
    - 轻量清理 ≥60s 执行一次；
    - 全量清理 ≥1h 执行一次（含 orphan + vacuum）。
  - `stop()` 时取消未完成的清理任务，避免退出竞态。

**效果原理**：
热路径只做 O(1) upsert + 索引增量更新；O(N) orphan 扫描与 vacuum 挪到低频任务。

### 2) 缩略图异步加载（HistoryItemView）

**文件**：`Scopy/Views/HistoryListView.swift`

**改动**：
- `getCachedThumbnail` 只读内存缓存，不再做磁盘读取。
- 行 `.task(id: thumbnailPath)` 触发后台读取：
  - `Task.detached` 读取 `Data(contentsOf:)`（utility QoS）。
  - 回到 `MainActor` 创建 `NSImage` 并写入 LRU 缓存与 `@State loadedThumbnail`。

**效果原理**：
主线程只做轻量 state 更新；磁盘 I/O 与冷解码不阻塞滚动。

### 3) 短词全量模糊搜索去噪（SearchService）

**文件**：`Scopy/Services/SearchService.swift`

**改动**：
- `fuzzyMatchScore` 对 `queryLower.count <= 2` 使用 **连续子串语义**：
  - 若 `textLower` 包含该子串，按出现位置给分；
  - 否则视为不匹配。
- `query.count > 2` 仍使用原 **顺序 subsequence** 语义，保证全量模糊搜索准确性与召回。

**效果原理**：
短词不再把全库“弱匹配”都拉出来；但仍在全量历史上筛选与排序。

---

## ✅ 修改文件列表

- `Scopy/Services/StorageService.swift`
  - `CleanupMode` + 轻量/全量分级清理。
- `Scopy/Services/RealClipboardService.swift`
  - 防抖/节流清理调度，热路径去 O(N)。
- `Scopy/Views/HistoryListView.swift`
  - 缩略图后台加载 + MainActor 赋值。
- `Scopy/Services/SearchService.swift`
  - 短词连续子串语义去噪 + ASCII 子串 fast‑path。
- `ScopyTests/PerformanceTests.swift`
  - Fuzzy 性能测试预热全量索引，避免把首次构建成本计入稳态 P95。

---

## 🧪 测试

- `make test-unit` ✅ **51 tests passed**（1 perf skipped）
- `make test-perf` ✅ 非 heavy 场景通过；50k/75k 磁盘极限用例在 Debug 环境仍高于目标，后续继续优化。

---

**维护者**: Claude Code  
**最后更新**: 2025-12-12

