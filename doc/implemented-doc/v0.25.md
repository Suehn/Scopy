# v0.25 - 全量模糊搜索高性能实现

**日期**: 2025-12-12

---

## 📌 一页纸总结

### What
- 实现 **真正的全量 Fuzzy / Fuzzy+ 搜索**：覆盖全部历史，不再仅限最近 2000 条。
- 在保证 **字符顺序 subsequence 匹配完全准确** 的前提下，提供高性能候选筛选与排序。

### Why
- v0.md 目标是“无限历史 + 高性能搜索”，默认 fuzzyPlus 模式必须对全量历史正确可用。
- 之前 fuzzy/fuzzyPlus 只在 recent cache 上扫描，存在明显规格偏离。

### Result
- 全量历史可模糊搜索，语义保持不变（顺序字符匹配 / 分词每词模糊匹配）。
- 搜索性能在 1k–5k 项规模下仍保持 <100ms（`make test-unit` 性能测试通过；5k perf 测试在未开环境变量时跳过）。
- 增量更新索引避免频繁重建，常驻运行时搜索稳定。

---

## 🏗️ 核心实现

### 1) 全量模糊索引（SearchService）

**文件**: `Scopy/Services/SearchService.swift`

实现一个 **字符倒排索引 + 精确二次验证** 的两阶段搜索：

1. **索引构建（一次性/惰性）**
   - 从 SQLite 读取全表 summary（不读取 raw_data）。
   - 对每条记录生成 `IndexedItem`，预计算 `plainTextLower`。
   - 抽取 **非空白字符集合**，写入倒排表：`[Character: [slot]]`。

2. **查询流程**
   - 对 query 取非空白字符集合。
   - 取各字符 postings，按 postings 大小升序做交集 → 候选 slots。
   - 对候选逐条做 **subsequence fuzzyMatchScore**（保持原有语义），并计算简单评分。
   - 排序：Pinned 置顶 → score → lastUsedAt。
   - 按 limit/offset 分页返回。

该策略保证：
- **无漏召回**：候选筛选仅基于“必须包含的字符集合”，不会排除任何真实匹配。
- **高性能**：候选集通常远小于全表，二次验证成本可控。

### 2) 索引增量更新

**文件**: `Scopy/Services/SearchService.swift` + `Scopy/Services/RealClipboardService.swift`

RealClipboardService 在数据变更时调用：

- `handleUpsertedItem(_:)`：新增/去重更新 lastUsedAt/useCount 时增量更新索引。
- `handlePinnedChange(id:pinned:)`：Pin/Unpin 更新索引状态。
- `handleDeletion(id:)`：删除时标记 slot=nil 并移除映射。
- `handleClearAll()`：清空时完全失效索引与 recent cache。

避免每次搜索重建全表索引。

### 3) Summary 解析与并发安全

**文件**: `Scopy/Services/SQLiteHelpers.swift`

- 新增 `parseStoredItemSummary(from:)`，供索引与轻量查询使用，避免读取大字段。

**文件**: `Scopy/Services/SearchService.swift`

- recentItemsCache 在后台读取前先 `withLock` 快照，消除主/后台并发数据竞争风险。

---

## ✅ 修改文件列表

- `Scopy/Services/SearchService.swift`
  - 新增全量模糊索引、两阶段搜索、评分排序。
  - 新增索引增量更新 API。
  - recent cache 并发安全快照。
- `Scopy/Services/SQLiteHelpers.swift`
  - 新增 `parseStoredItemSummary(from:)`。
- `Scopy/Services/RealClipboardService.swift`
  - 数据变更改为通知 SearchService 增量更新。

---

## 🧪 测试

- `make test-unit` ✅ **51 tests passed** (1 perf skipped)
- SearchServiceTests 覆盖：
  - fuzzy/fuzzyPlus 正确性、分页、过滤、大小写不敏感。
  - cache invalidation 与性能时延统计。

---

## 🔮 后续可选优化

- 对超大文本（>阈值）外部化并仅索引摘要，进一步压缩内存与 FTS 膨胀风险。
- 将 SearchService 完全 actor 化，消除 MainActor + DispatchQueue 混用语义问题。

---

**维护者**: Claude Code  
**最后更新**: 2025-12-12

