# v0.16.2 - Pin 指示器修复 + Pinned 区域可折叠

**日期**: 2025-11-29
**类型**: Bug 修复 + UX 改进
**前置版本**: v0.16.1

---

## 📌 一页纸总结

### What
1. 修复 Pin 指示器显示不正确的 bug
2. 修复缓存失效问题
3. 新增 Pinned 区域可折叠功能
4. 修复文本预览最后一行截断问题

### Why
- Pin 后项目在 Pinned 区域但没有显示左侧高亮竖线和右侧图钉图标
- `items` 数组修改操作不触发 `didSet`，导致缓存没有失效
- Pin 太多时需要滚动才能看到 Recent 区域
- 文本预览弹窗高度不够，最后一行被截断

### Result
- Pin/Unpin 后指示器正确显示
- 缓存在所有修改操作后正确失效
- 点击 "Pinned · N" 标题可折叠/展开
- 文本预览完整显示，支持滚动
- 测试 161/161 通过

---

## 🏗️ 实现路线

1. 分析 Pin 指示器 bug 根因
2. 新增 `ClipboardItemDTO.withPinned()` 方法
3. 修改 `handleEvent(.itemPinned/.itemUnpinned)` 直接更新 `items` 数组
4. 新增 `invalidatePinnedCache()` 方法
5. 在所有修改 `items` 数组的地方调用缓存失效
6. 新增 `isPinnedCollapsed` 状态
7. 修改 `SectionHeader` 支持折叠
8. 修改 Pinned 区域使用可折叠 Header
9. 修复 `textPreviewView` 布局约束，添加 `.fixedSize()` 和增加高度

---

## 📂 核心改动

| 文件 | 修改内容 |
|------|---------|
| `ClipboardServiceProtocol.swift` | 新增 `withPinned()` 方法 |
| `AppState.swift` | 修复 `handleEvent`，新增 `invalidatePinnedCache()` 和 `isPinnedCollapsed` |
| `HistoryListView.swift` | `SectionHeader` 支持折叠，Pinned 区域可折叠，文本预览高度修复 |

### 关键代码

#### ClipboardItemDTO.withPinned()

```swift
func withPinned(_ pinned: Bool) -> ClipboardItemDTO {
    ClipboardItemDTO(
        id: id,
        type: type,
        contentHash: contentHash,
        plainText: plainText,
        appBundleID: appBundleID,
        createdAt: createdAt,
        lastUsedAt: lastUsedAt,
        isPinned: pinned,
        sizeBytes: sizeBytes,
        thumbnailPath: thumbnailPath,
        storageRef: storageRef
    )
}
```

#### handleEvent(.itemPinned/.itemUnpinned)

```swift
case .itemPinned(let id):
    if let index = items.firstIndex(where: { $0.id == id }) {
        items[index] = items[index].withPinned(true)
        invalidatePinnedCache()
    }
case .itemUnpinned(let id):
    if let index = items.firstIndex(where: { $0.id == id }) {
        items[index] = items[index].withPinned(false)
        invalidatePinnedCache()
    }
```

#### SectionHeader 折叠支持

```swift
private struct SectionHeader: View {
    var isCollapsible: Bool = false
    var isCollapsed: Bool = false
    var onToggle: (() -> Void)? = nil

    var body: some View {
        HStack {
            if isCollapsible {
                Image(systemName: isCollapsed ? "chevron.right" : "chevron.down")
            }
            Text("\(title) · \(count)")
            // ...
        }
        .onTapGesture {
            if isCollapsible { onToggle?() }
        }
    }
}
```

---

## 🎯 关键指标

### 测试结果

| 指标 | 结果 |
|------|------|
| 单元测试 | 161/161 passed (1 skipped) |
| 构建 | Debug ✅ |
| 部署 | /Applications/Scopy.app ✅ |

### Bug 验证

| Bug | 验证步骤 | 预期结果 |
|-----|---------|---------|
| Pin 指示器 | Pin 一个项目 | 左侧竖线 + 右侧图钉显示 |
| 缓存失效 | 复制新内容 | 列表正确更新 |
| 折叠功能 | 点击 Pinned 标题 | 区域折叠/展开 |

---

## 📊 当前状态

```
✅ Bug 修复：Pin 指示器显示不正确
✅ Bug 修复：缓存失效问题
✅ 新功能：Pinned 区域可折叠
✅ 测试通过：161/161
✅ 已部署：/Applications/Scopy.app
```

---

## 🔮 遗留与后续

### 本版本完成
- Pin 指示器正确显示
- 缓存失效机制完善
- Pinned 区域可折叠
- 文本预览高度修复

### 后续建议
- 考虑持久化折叠状态（重启后保持）
- 考虑添加折叠动画
