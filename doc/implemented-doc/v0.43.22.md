# v0.43.22 — UX/Preview：Markdown 渲染 hover 预览（KaTeX 公式）+ 安全/高性能

**日期**：2025-12-15

## 📌 一页纸总结（What / Why / Result）

### What

- Hover 文本预览：检测到 Markdown（含公式分隔符）时，改用 Markdown 渲染预览。
- 渲染引擎：`Down`（cmark）将 Markdown 转为 **safe HTML**（抑制 raw HTML/unsafe links）。
- 公式支持：内置 KaTeX（含 auto-render），支持 `$...$` / `$$...$$` / `\\(...\\)` / `\\[...\\]`。
- 兼容性增强：对“无分隔符的 TeX 片段”（例如 `(\mathcal{U})`）做轻量归一化，自动补齐 `$...$`；并内置 `mhchem`（`\ce{...}`）。
- 兼容性增强（关键）：对 **已存在 `$...$`** 的内容，在 Markdown → HTML 前先用占位符保护，避免 `_/*` 等符号被 Markdown 解析为强调导致 KaTeX 无法识别；渲染后再回填（HTML-escaped）。
- 兼容性增强（PDF/Word 抽取常见问题）：
  - 修复相邻 inline 数学片段导致的 `$$` 伪 display delimiter（例如 `$\\mathbf{b}$$\\in$`、`$\\Delta^{m}$$,`），避免 KaTeX auto-render 误判并“吞掉后续内容”。
  - 修复 `\\quad $\\mathbf{b}` 这类“数学内部插入的 stray `$`”，尽量把碎片合并回同一条数学表达式。
  - 若 inline math 内出现 `&`（列分隔符）但缺失环境，自动升级为 `$$\\begin{aligned}...\\end{aligned}$$` 以提升兼容性。
  - 支持跨行 display math：`$$` 换行包裹（`$$\\n...\\n$$`）会在 Markdown 解析前被保护，避免被误解析为 code block，从而能被 KaTeX 正常渲染。
- 安全与性能：
- 预览 HTML 走 `WKWebView`（non-persistent data store），并通过 CSP + rule list 阻断网络。
- Markdown 渲染在后台执行 + `NSCache` 缓存（按 `contentHash`），并对超大文本做 hard cap（避免卡顿，当前上限 200k UTF-16）。
  - 兼容性增强（关键修复）：CSP 允许 `file:` 加载本地 KaTeX 资源（仍禁止 http/https），并在页面 `didFinish` 时做一次兜底 `renderMathInElement`，避免 WebKit 时序差导致“公式不渲染”。

### Why

- 剪贴板里常见 Markdown（README/笔记/Issue/PR 描述），纯文本 hover 预览可读性不足。
- 公式是高频内容（技术笔记/论文/课程作业），需要“能看得懂”的 hover 预览，同时必须不牺牲滚动与 hover 首帧体验。

### Result

- Hover 首帧依旧快速显示文本；若识别为 Markdown，会在后台渲染并自动切换为渲染预览（含公式）。
- 预览默认不出网；粘贴板内容中的链接不会跳转/打开，避免安全风险与网络抖动。

---

## 🏗️ 实现路线

1. 增加 Markdown 快速检测（含数学分隔符优先）。
2. Markdown → safe HTML（`DownOptions.safe + .smart`），包装成自包含 HTML 文档并添加 CSP。
   - 对“loose LaTeX”做归一化：避开 fenced/inline code，仅对短片段补齐 `$...$`（性能/误判可控）。
   - 对 `$...$` / `$$...$$` / `\\(...\\)` / `\\[...\\]` / `\\begin{...}` 环境做保护：避免 Markdown emphasis 把公式拆成多个 DOM text node。
3. vendoring KaTeX 资源到 App bundle（`Scopy/Resources/MarkdownPreview`），用 baseURL 加载本地资源。
4. `WKWebView` 侧增加网络拦截（content rule list + navigation policy）。
5. hover 渲染链路：主线程先显示纯文本，再异步补齐 HTML；按 `contentHash` 缓存渲染结果。

---

## 📂 核心改动

- `Scopy/Views/History/HistoryItemView.swift`：hover 文本预览链路增加 Markdown 检测、异步渲染与缓存。
- `Scopy/Views/History/HoverPreviewModel.swift`：新增 Markdown 预览字段（`isMarkdown` / `markdownHTML`）。
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`：在 hover popover 中切换 `NSTextView` 与 `WKWebView`。
- `Scopy/Views/History/MarkdownDetector.swift`：Markdown/公式检测（轻量启发式）。
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`：safe HTML 渲染 + CSP + KaTeX auto-render glue。
- `Scopy/Views/History/MarkdownPreviewCache.swift`：`NSCache`（count + cost limit）。
- `Scopy/Views/History/MarkdownPreviewWebView.swift`：`WKWebView`（non-persistent + network block）。
- `Scopy/Resources/MarkdownPreview/*`：KaTeX 静态资源（CSS/JS/fonts）。
- `project.yml`：引入 `Down` SwiftPM；App/Test 资源目录；SwiftPM `.bundle` staging 脚本。
- `Makefile`：Strict Concurrency 回归命令兼容 SwiftPM 依赖（避免与 `-suppress-warnings` 冲突）。

---

## 🎯 关键指标

**测试环境**：Apple M3（24 GB） / macOS 15.7.2（24G325） / arm64 / Debug / 2025-12-16

- 单元测试：`make test-unit` **151 passed** (1 skipped)
- Strict Concurrency：`make test-strict` **151 passed** (1 skipped)
- 性能测试：`make test-perf` **23 passed** (6 skipped)
- Release 构建/部署：`./deploy.sh release` ✅（`/Applications/Scopy.app`）

---

## 📊 当前状态（快速检查）

- ✅ Markdown hover 预览：列表/标题/代码块/链接等常见语法可读性提升
- ✅ 公式：KaTeX auto-render（inline/display）可用
- ✅ 安全：safe HTML + CSP + WK 规则阻断网络/跳转
- ✅ 性能：异步渲染 + 缓存；超大文本不会触发重渲染

---

## 🔮 遗留与后续

- Markdown 检测仍为启发式：可考虑在设置里加开关/阈值，或对误判场景继续收敛。
- 预览 CSS 可进一步与 Scopy 主题对齐（code block、blockquote、table 等）。
