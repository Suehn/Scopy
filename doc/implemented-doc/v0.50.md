# v0.50

## 📌 一页纸总结（What / Why / Result）

### What

- Release：重构导出图片链路——在 Markdown/LaTeX hover 预览中提供一键 “Export PNG”，把渲染结果（白底黑字）写入剪贴板；同时补齐长内容、宽表格与底部空白等边界处理与回归测试。

### Why

- 预览内容经常需要跨应用“带格式”粘贴；PNG 是最稳定的载体。
- WebKit snapshot 在长内容与宽表格场景下容易出现：高度测量偏差、底部异常留白、表格过度换行或缩放过头，需要以可观测与可回归的方式收敛。

### Result

- Export：固定宽 `1080px`、高度按内容动态测量；长内容自动分片 snapshot 并拼接为单张长图；表格按可读性自适应缩放/换行；导出结果做底部白边裁剪。
- Preview：ATX 标题缺空格（`##标题`）自动标准化为 `## 标题`；表格改为横向滚动以减少换行。
- Tests：新增 Export PNG 单测 + 端到端 UI tests，覆盖尺寸/表格/剪贴板/底部空白等关键路径。

### Fixes（post-release）

- 后续修复详见 `v0.50.fix2`。

---

## 🏗️ 实现路线

1. 抽离导出核心到 `MarkdownExportService`，用离屏 `WKWebView` 做确定性布局与渲染。
2. 增加渲染稳定等待与高度测量：短内容优先单次 snapshot，超长内容回退 tiled snapshot + 拼接。
3. 表格导出策略：优先 no-wrap + 缩放，过小则回退换行；支持输出 table metrics 便于诊断与回归。
4. 补齐 UI 导出状态机与 UI 测试基础设施（自定义 pasteboard/harness window），确保端到端可回归。

---

## 📂 核心改动

- `Scopy/Views/History/MarkdownExportService.swift`
  - 离屏 WKWebView 渲染 + 动态高度测量 + tile snapshot 拼接 + 白底裁剪；导出路径默认阻断网络请求。
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`
  - hover 预览右上角 Export 按钮与状态反馈；导出固定目标宽 1080px。
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`
  - ATX heading 规范化（`##标题` -> `## 标题`）；表格样式调整（横向滚动、尽量少换行）。
- `Scopy/Views/History/MarkdownPreviewWebView.swift`
  - 预览/导出渲染一致性收敛，导出不再依赖“可见区域 snapshot”。
- `Scopy/AppDelegate.swift`
  - `--uitesting` 下导出链路可观测性增强（导出 harness + 自动触发入口），仅用于测试回归。
- `ScopyTests/MarkdownExportServiceTests.swift`
- `ScopyUITests/ExportMarkdownPNGUITests.swift`

---

## 🎯 关键指标

- 导出目标宽度：`1080px`（按屏幕 `backingScaleFactor` 计算 layout points）
- 导出安全性：导出专用 WebView 默认阻断网络请求（避免外链资源拉取）

---

## 📊 当前状态

- 单元测试：`make test-unit` Executed 220 tests, 1 skipped, 0 failures
- UI 测试：本机 UI automation 未就绪（Timed out while enabling automation mode），未复验
- Release 构建：待 tag `v0.50` 推送后由 GitHub Actions `Build and Release` 自动构建 DMG 并更新 Homebrew tap

---

## 🔮 遗留与后续

- 超长内容仍受像素/内存上限约束；当前策略会在必要时按像素预算缩放全局字号以保证“单张图导出成功”。如需保持字号，后续可考虑“多张分段导出”并提供策略开关。
