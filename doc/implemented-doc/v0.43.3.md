# v0.43.3 - Fix/Perf：短词搜索全量校准恢复 + 高速滚动进一步降载

**日期**: 2025-12-14

---

## 一页纸总结

### What

- **短词搜索“先快后准”**：短词（≤2）fuzzy/fuzzyPlus 首屏仍走 recent cache 快速返回，但将结果标记为预筛（`total = -1`），并支持 `forceFullFuzzy=true` 走全量 full-index 搜索，允许 UI 在后台渐进 refine 到全量精确结果。
- **分页一致性修复**：当处于预筛（`total = -1`）时，`loadMore()` 会先强制 full-fuzzy 拉取前 N 条再分页，避免“永远停留在 cache 子集”的不全量问题。
- **滚动期更彻底降载**：滚动期间直接忽略 hover 事件并清理悬停状态；键盘选中动画在滚动时禁用；缩略图 placeholder 在滚动时不再启动 `.task`（减少任务创建与主线程负担）。

### Why

- v0.43.2 的短词 cache 优化在某些路径下会“锁死”全量搜索：短词始终落在 recent cache，且 UI refine/paging 在短词场景不会触发 `forceFullFuzzy` 校准，导致全量召回失效。
- Low Power Mode 下，滚动过程中额外的 hover 处理、动画与任务创建会放大掉帧体感；需要进一步收敛“滚动期间的非必要工作”。

### Result

- **搜索**：短词搜索先快速展示近期结果，随后自动校准到全量结果（保持最终精度）。
- **交互**：快速滚动更稳，滚动期间的 UI 噪声（hover/任务/动画）进一步降低。
- **回归通过**：
  - `make test-unit`：53 passed, 1 skipped（54 total）
  - `make test-perf`：16 passed, 6 skipped（22 total；heavy 需 `RUN_HEAVY_PERF_TESTS=1`）
  - `make test-tsan`：132 passed, 1 skipped（133 total）
  - `make test-strict`：160 passed, 7 skipped（167 total）

---

## 实现路线

1. `SearchEngineImpl`：短词 cache 返回改为“预筛语义”（`total=-1`），并在 `forceFullFuzzy=true` 时走 full index 全量搜索。
2. `HistoryViewModel`：短词也允许后台 refine；预筛状态下 `loadMore()` 不再要求 query 长度≥3 才触发 full-fuzzy 校准。
3. `HistoryItemView/HistoryItemThumbnailView`：滚动期直接 early-return hover；滚动期禁用键盘选中动画；滚动期不启动缩略图加载任务。
4. `SearchServiceTests`：补充短词全量校准回归测试（`forceFullFuzzy` 对短词必须生效）。

---

## 核心改动

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
- `Scopy/Observables/HistoryViewModel.swift`
- `Scopy/Views/History/HistoryItemView.swift`
- `Scopy/Views/History/HistoryItemThumbnailView.swift`
- `ScopyTests/SearchServiceTests.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit`（53 passed, 1 skipped）
- 性能测试：`make test-perf`（16 passed, 6 skipped）
- Thread Sanitizer：`make test-tsan`（132 passed, 1 skipped）
- Strict Concurrency：`make test-strict`（160 passed, 7 skipped）

### 性能（Debug / `make test-perf` 单次运行）

- 环境：MacBook Air（Apple M3, 24 GB）/ macOS 15.7.2（24G325）/ arm64 / 2025-12-14
- 电源：Low Power Mode enabled（`pmset -g` 显示 `lowpowermode 1`）
- 关键结果：
  - Fuzzy 5k items P95 ≈ 9.09ms
  - Fuzzy 10k items P95 ≈ 81.33ms（Samples: 50；Low Power Mode 下测试阈值放宽至 300ms）
  - Disk 25k fuzzy P95 ≈ 108.45ms（Samples: 50）
  - Bulk insert 1000 items ≈ 85.31ms（≈11,721 items/s）
  - Fetch recent (50 items) avg ≈ 0.11ms
  - Regex 20k items P95 ≈ 5.54ms
  - Mixed content disk search（single run）≈ 7.59ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 短词（尤其 1 字符）全量 refine 的触发策略可继续迭代（例如更长 idle delay、或只在用户停止输入后触发），在“最终精度”与“低功耗实时交互”之间做更细的平衡。
- 若需要从原理上量化 UI 滚动性能，建议建立可重复的 UI baseline（Instruments: Core Animation / Time Profiler），并把关键数据写入 `doc/profile/`。

