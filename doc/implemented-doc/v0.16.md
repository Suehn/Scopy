# v0.16 - 稳定性与性能增强（Pinned 排序一致性、后台 I/O、并发安全）

## 📌 一页纸总结
- **What**: 修复审计中的 P0/P1 稳定性问题（强制解包、流关闭、任务泄漏、Pinned 排序一致性），降低主线程阻塞（外部存储统计、孤儿清理、文件删除、缩略图清理），补齐复合索引。
- **Why**: 保证在高负载下搜索/清理/启动更加稳定，UI 保持响应；排序与 v0 规范一致（Pinned 置顶）。
- **Result**: 主线程阻塞路径后台化，搜索排序一致性提升；新增索引与缓存失效机制，降低重复计算。

## 🏗️ 实现路线
1) 搜索稳定性与排序一致性：强制解包修复、结构化并发超时、Pinned 优先排序、缓存结果排序、O(n) removeLast 优化。  
2) 存储安全与后台化：外部大小统计与缩略图清理后台执行，文件删除异步化，复合索引补齐，除零/溢出防护。  
3) 事件与状态安全：Clipboard 流关闭检查、AppState 任务清理、格式化防负数、Pinned 缓存。  
4) 实施文档：更新 README/CHANGELOG/DEPLOYMENT/v0-supplement，记录改动与待测项。

## 📂 核心改动
- `Scopy/Services/SearchService.swift`  
  - mainStmt 强制解包→安全访问；Pinned 优先排序（FTS ORDER BY is_pinned DESC + 稳定顺序）；缓存结果排序；结构化并发超时；removeLast O(n)→prefix。
- `Scopy/Services/ClipboardMonitor.swift`  
  - 添加 `isContentStreamFinished` 守卫，stop/deinit 设置，yield 前检查；`isEmpty` 去除强制解包。
- `Scopy/Services/StorageService.swift`  
  - `getTotalSize` 溢出保护；外部存储统计/缩略图统计后台化；文件删除异步化；缩略图尺寸校验；外部大小缓存 TTL 180s；新增 `idx_type_recent` 复合索引。
- `Scopy/Services/RealClipboardService.swift`  
  - 孤儿清理改为后台；复制更新 usage 失败日志；存储统计 await 后台计算。
- `Scopy/Observables/AppState.swift`  
  - pinned/unpinned 缓存 + 失效；格式化防负数；stop 清理所有任务。
- `doc/dev-doc/v0-supplement.md`  
  - 新增补充设计（稳定性/性能）存档。
- 版本文档与索引更新：`doc/implemented-doc/README.md`、`doc/implemented-doc/CHANGELOG.md`、`DEPLOYMENT.md`。

## 🎯 关键指标（本次实测）
- 单测：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests` **161/161 通过，1 跳过（需 RUN_PERF_TESTS）**
- 性能（节选，详见 `doc/profile/v0.16-profile.md`）：
  - Search 5k P95 4.15ms；10k P95 4.85ms；25k 磁盘 24.92ms；50k 磁盘 51.74ms；75k 磁盘 112.49ms
  - Cleanup 50k 270.67ms；External Cleanup 10k 303.59ms；Inline Cleanup 10k P95 61.11ms
  - Bulk Insert 1000/33.31ms；Fetch Recent 0.06ms/次；First Screen Load P95 0.07ms
  - Memory Stability：500 迭代 +0.3MB；External Storage Stress 清理 3.94ms

## 📊 当前状态
- 功能：与 v0 规范一致，无行为变更。  
- 搜索：Pinned 排序与空查询一致性。  
- 后台化：外部大小/缩略图统计、孤儿清理、文件删除均移出主线程。  
- 并发：搜索超时结构化，流关闭守卫到位。

## 🔮 遗留与后续
- 补充性能数据：运行性能测试集，更新 `DEPLOYMENT.md` 与 `doc/profile/` 对比文档。  
- 若要彻底消除清理阻塞，可进一步将 cleanup 全链路 async 化并加回压策略。  
- 监控与日志：可为 try? 路径补充统一日志前缀，便于定位。
