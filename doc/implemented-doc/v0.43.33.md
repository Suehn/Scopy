# v0.43.33（Preview：动态高度更准确更稳定）

日期：2025-12-16

## 背景

Markdown/LaTeX hover 预览中，部分场景下预览框高度明显偏小（内容高度未接近上限时仍需要滚动才能看全）。

根因是 WKWebView 上报的 `scrollHeight` 是 CSS 像素（逻辑像素），此前错误地按 `devicePixelRatio` 进行了二次缩放，导致在 Retina 屏幕上高度大幅低估。

## 变更

- **高度上报修复**：不再对 `scrollHeight` 做 `devicePixelRatio` 归一化，直接按 CSS 像素上报给 SwiftUI 作为 point 使用（Retina 下不再低估）。
- **高度同步更稳**：
  - 使用 `ResizeObserver` 监听 `#content` 尺寸变化（Markdown 渲染、KaTeX 渲染、图片加载等）。
  - 等待 `document.fonts.ready` 后再次上报（KaTeX 字体加载后行高变化更准确）。
  - `window.load` 后补一次上报（避免最后一批资源加载导致的滞后）。
- **回归测试**：新增断言，防止未来再次引入 `devicePixelRatio` 缩放导致高度回退。

## 测试

- Release 构建：
  - `xcodebuild build -scheme Scopy -configuration Release -destination 'platform=macOS'`
- 定向单测：
  - `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/KaTeXRenderToStringTests -only-testing:ScopyTests/MarkdownMathRenderingTests`

## 修改文件

- `Scopy/Views/History/MarkdownHTMLRenderer.swift`
- `ScopyTests/KaTeXRenderToStringTests.swift`
- `doc/implemented-doc/README.md`
- `doc/implemented-doc/CHANGELOG.md`

