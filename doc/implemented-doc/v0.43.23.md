# v0.43.23 â€” Fix/Previewï¼šMarkdown hover é¢„è§ˆç¨³å®šæ€§ + è¡¨æ ¼ + å…¬å¼å…¼å®¹æ€§å¢å¼º

**æ—¥æœŸ**ï¼š2025-12-16

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- **ä¿®å¤ hover é¢„è§ˆå´©æºƒ**ï¼š`MarkdownHTMLRenderer` ä¸å†ç”¨ `NSJSONSerialization` ç”Ÿæˆ JS å­—é¢é‡ï¼ˆä¼šå¯¹ top-level fragment æŠ› `NSException`ï¼‰ï¼Œæ”¹ä¸º `JSONEncoder` è¾“å‡ºç¨³å®šçš„ JSON å­—é¢é‡ã€‚
- **Markdown è¡¨æ ¼æ”¯æŒ**ï¼šHover é¢„è§ˆçš„ Markdown æ¸²æŸ“ä» `Down(cmark)` åˆ‡åˆ° `WKWebView` å†…ç½® `markdown-it`ï¼ˆ`html:false` / `linkify:false`ï¼‰ï¼Œæ”¯æŒ pipe table ç­‰å¸¸è§è¯­æ³•ã€‚
- **å…¬å¼å…¼å®¹æ€§å¢å¼º**ï¼š
  - å…¼å®¹â€œæ–¹æ‹¬å· display å—â€ï¼š`[\n...\n]` å½’ä¸€åŒ–ä¸º `$$\n...\n$$`ã€‚
  - å…¼å®¹å¤šè¡Œ LaTeX ç¯å¢ƒå—ï¼š`\\begin{equation} ... \\end{equation}`ï¼ˆä»¥åŠ `align/aligned/cases`ï¼‰æŒ‰å—ä¿æŠ¤ï¼Œé¿å…è¢« Markdown åˆ†æ®µå¯¼è‡´ KaTeX delimiter è·¨ DOM èŠ‚ç‚¹å¤±æ•ˆã€‚
  - å…¼å®¹â€œæ—  `$` çš„æ‹¬å·å…¬å¼â€ï¼šå¯¹ `(...)` / `ï¼ˆ...ï¼‰` / `[...]` / `ã€...ã€‘` ä¸­çš„ TeX ç‰‡æ®µè‡ªåŠ¨åŒ…è£¹ä¸º `$\\left(...\\right)$` / `$\\left[...\\right]$`ã€‚
  - é¿å…äºŒæ¬¡åŒ…è£¹ï¼šå¯¹å·²åœ¨ `$...$` å†…çš„å†…å®¹ä¸å†åš â€œstandalone commandâ€ è‡ªåŠ¨è¡¥é½ï¼Œé¿å…å‡ºç°ä¸é…å¯¹çš„ `$` å¯¼è‡´åªæ¸²æŸ“ä¸€åŠã€‚
  - å…¼å®¹ set notationï¼šå¯¹ `={i\\mid ...}` è¿™ç±»å¸¸è§å†™æ³•è‡ªåŠ¨å½’ä¸€åŒ–ä¸º `=\\{i\\mid ...\\}`ï¼Œé¿å… `{}` è¢« KaTeX å½“ä½œåˆ†ç»„è€Œâ€œæ‹¬å·ä¸è§â€ã€‚
  - å…¼å®¹â€œè½¬ä¹‰å­—ç¬¦ä¸²â€æ¥æºï¼šæ•°å­¦ç‰‡æ®µå†…å°† `\\command` å½’ä¸€åŒ–ä¸º `\command`ï¼ˆä»…å¯¹ `\\` åç´§è·Ÿå­—æ¯çš„åœºæ™¯ç”Ÿæ•ˆï¼‰ï¼Œå°½é‡è¿˜åŸçœŸå® TeX å‘½ä»¤ã€‚
- **èµ„æºæ‰“åŒ…ä¿®å¤**ï¼šæ–°å¢æ„å»ºé˜¶æ®µæŠŠ `Scopy/Resources/MarkdownPreview` ä»¥ç›®å½•ç»“æ„å¤åˆ¶åˆ° app bundleï¼ˆé¿å…è¢«èµ„æºæ‹·è´é˜¶æ®µæ‰å¹³åŒ–å¯¼è‡´è„šæœ¬/å­—ä½“æ— æ³•æŒ‰ç›¸å¯¹è·¯å¾„åŠ è½½ï¼‰ã€‚
- **LaTeX æ–‡æœ¬å¯è¯»æ€§**ï¼šè½»é‡æ”¯æŒ `\\section/\\subsection/\\subsubsection` è½¬ä¸º Markdown æ ‡é¢˜ï¼ˆä»…æŒ‰è¡Œé¦–åŒ¹é…ï¼Œé¿å…è¯¯ä¼¤ï¼‰ã€‚

### Why

- ç”¨æˆ·åé¦ˆï¼šhover é¢„è§ˆè§¦å‘å´©æºƒã€`$...$` / `$$...$$` å…¬å¼ä¸æ¸²æŸ“ã€è¡¨æ ¼ä¸æ¸²æŸ“ï¼Œä¸”å­˜åœ¨å¤šç§â€œéæ ‡å‡†ä½†å¸¸è§â€çš„å…¬å¼å†™æ³•ï¼ˆæ¥è‡ªè®ºæ–‡/PDF/ä»£ç å­—ç¬¦ä¸²è½¬ä¹‰ï¼‰ã€‚

### Result

- Hover é¢„è§ˆä¸å†å› æ¸²æŸ“å™¨å´©æºƒè€Œé€€å‡ºã€‚
- KaTeX / auto-render / mhchem / markdown-it å‡å¯ä» app bundle çš„ `MarkdownPreview/` ç›®å½•æŒ‰ç›¸å¯¹è·¯å¾„åŠ è½½ï¼›`$` / `$$` / `$$\n...\n$$` åŠå¸¸è§å˜ä½“æ›´ç¨³å®šå¯ç”¨ã€‚
- Pipe table ç­‰ Markdown è¡¨æ ¼åœ¨ hover é¢„è§ˆä¸­å¯è¯»æ€§æ˜¾è‘—æå‡ã€‚

---

## ğŸ—ï¸ å®ç°è¦ç‚¹

1. **æ¸²æŸ“ç­–ç•¥**ï¼šé¦–å¸§ä»èµ°çº¯æ–‡æœ¬ï¼›æ£€æµ‹åˆ° Markdown/å…¬å¼ååœ¨åå°ç”Ÿæˆ HTMLï¼Œå¹¶å‘½ä¸­ç¼“å­˜ï¼ˆæŒ‰ `contentHash`ï¼‰ã€‚
2. **å®‰å…¨ç­–ç•¥**ï¼š
   - `WKWebView` ä½¿ç”¨ non-persistent data storeã€‚
   - CSP é»˜è®¤ `default-src 'none'`ï¼Œä»…æ”¾è¡Œ `file:` / `data:` æœ¬åœ°èµ„æºã€‚
   - `WKContentRuleList` é˜»æ–­ `http/https`ï¼Œå¹¶åœ¨ navigation policy ä¸­å–æ¶ˆé“¾æ¥è·³è½¬ã€‚
3. **å…¬å¼é²æ£’æ€§**ï¼š
   - Markdown æ¸²æŸ“å‰å¯¹æ•°å­¦ç‰‡æ®µåšå ä½ç¬¦ä¿æŠ¤ï¼Œé¿å… emphasis/inline parsing æ‰“ç¢ text nodeã€‚
   - å½’ä¸€åŒ– `[\n...\n]` display å—ä¸ `\\command` è½¬ä¹‰å‘½ä»¤ã€‚
4. **èµ„æºå¯é æ€§**ï¼š
   - `project.yml` æ–°å¢ `postBuildScripts`ï¼š`Stage MarkdownPreview Assets`ï¼Œå°† `Scopy/Resources/MarkdownPreview` å¤åˆ¶åˆ° `Scopy.app/Contents/Resources/MarkdownPreview`ã€‚

---

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶

- `Scopy/Views/History/MarkdownHTMLRenderer.swift`
- `Scopy/Views/History/MathNormalizer.swift`
- `Scopy/Views/History/MathProtector.swift`
- `project.yml`
- `ScopyTests/MarkdownMathRenderingTests.swift`
- `Scopy/Resources/MarkdownPreview/contrib/markdown-it.min.js`

---

## âœ… æµ‹è¯•ä¸æ„å»º

**æµ‹è¯•ç¯å¢ƒ**ï¼šApple M3ï¼ˆ24 GBï¼‰ / macOS 15.7.2ï¼ˆ24G325ï¼‰ / Debug / 2025-12-16

- å•å…ƒæµ‹è¯•ï¼š`make test-unit`ï¼ˆExecuted 158 tests, 1 skipped, 0 failuresï¼‰
- Strict Concurrencyï¼š`make test-strict`ï¼ˆExecuted 158 tests, 1 skipped, 0 failuresï¼‰
- æ€§èƒ½æµ‹è¯•ï¼š`make test-perf`ï¼ˆExecuted 23 tests, 6 skipped, 0 failuresï¼‰
- Release æ„å»ºï¼š`xcodebuild build -scheme Scopy -configuration Release -destination 'platform=macOS'` âœ…
