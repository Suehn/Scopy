# v0.32 - vNext 重构：Search actor + 只读连接分离 + 去 GCD

**日期**: 2025-12-13

---

## 一页纸总结

### What

- 新增 `Scopy/Infrastructure/Search/SearchEngineImpl.swift`（actor）：搜索逻辑迁入 actor，内部自持 **只读 SQLite 连接**（`busy_timeout` + `query_only`），不再依赖 `DispatchQueue`。
- 删除旧的 `Scopy/Services/SearchService.swift`，并在 `RealClipboardService` 中完成装配替换。
- 更新测试：多连接场景统一改为 **shared in-memory DB URI**（`file:...mode=memory&cache=shared`），并适配 `SearchEngineImpl` 的 actor API。
- 性能测试修正：
  - `RUN_HEAVY_PERF_TESTS` 改为“显式开启才跑”；
  - 磁盘 perf 用例清理时确保先关闭连接，避免 SQLite `vnode unlinked while in use` 警告。

### Why

- 修复 vNext 重构的核心根因之一：搜索层此前依赖 `@MainActor + DispatchQueue` 绕隔离，超时/取消语义不可预测。
- 落地“读写连接分离”的 SQLite 访问模型：写入走 `SQLiteClipboardRepository` actor，搜索走独立只读连接，减少锁争用与尾部抖动。

### Result

- 机械约束达成：
  - `DispatchQueue(label: "com.scopy.search") / runOnQueue*` 清零；
  - `sqlite3_*` 仅存在于 `Scopy/Infrastructure/Persistence/*`。
- `make test-unit` 通过（53 tests passed，1 skipped）。
- `make test-perf` 通过（22 tests passed，6 skipped；heavy 场景需 `RUN_HEAVY_PERF_TESTS=1`）。

---

## 核心实现

### Search actor

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
  - Search API：`search(request:) async throws -> SearchResult`
  - 只读连接：通过 `SQLiteConnection.openFlags(..., readOnly: true)` 打开独立连接并设置 `PRAGMA query_only/busy_timeout`。
  - 渐进 refine 语义保持：`total == -1` 代表 total 不准确（兼容 `AppState` 的 refine 逻辑）。
  - 取消/超时：长循环中加入 `Task.checkCancellation()`；首建全量索引允许更长 timeout（30s），避免大库 warmup 被 5s 误杀。

### RealClipboardService 装配更新

- `Scopy/Services/RealClipboardService.swift`
  - `SearchEngineImpl(dbPath: storage.databaseFilePath)` 装配，并在 `start()` 中 `await search.open()`。
  - `handleUpsertedItem/handleDeletion/handlePinnedChange` 等更新为 actor 调用（`await`）。

---

## 修改文件列表（核心）

- 新增：`Scopy/Infrastructure/Search/SearchEngineImpl.swift`
- 修改：`Scopy/Infrastructure/Persistence/SQLiteConnection.swift`
- 修改：`Scopy/Services/RealClipboardService.swift`
- 修改：`ScopyTests/SearchServiceTests.swift`
- 修改：`ScopyTests/PerformanceTests.swift`
- 修改：`ScopyTests/ConcurrencyTests.swift`
- 修改：`ScopyTests/ResourceCleanupTests.swift`
- 删除：`Scopy/Services/SearchService.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- 性能测试：`make test-perf` **22 tests passed** (6 skipped)

### 性能（Debug / `make test-perf`）

- 环境：Apple M3 / macOS 15.7.2 / arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 4.85ms
  - Fuzzy 10k items P95 ≈ 45.07ms
  - Disk 25k fuzzy P95 ≈ 57.28ms

---

## 遗留与后续

- Phase 4：引入 `ClipboardService` actor（Application 层门面），并纯化事件语义（clearAll 不再复用 `.settingsChanged`）。
- Phase 5：Presentation 收口（缓存单一入口 + 巨型 View 拆分）。

