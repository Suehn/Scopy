# v0.50.fix2

> 状态：✅
> 说明：因远端 `v0.50.fix1` tag 冲突，改用 `v0.50.fix2` 重新发布（内容一致）。

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Export：超宽表格导出 PNG 时设置最小缩放比例 0.35；若需更小则固定 0.35 并启用换行，避免不可读/截断。
- Fix/Preview：hover 预览图片缓存与质量策略收敛，后台解码改为 Sendable 传递。
- Fix/Test：性能测试跳过场景不再触发 tearDown 崩溃；导出 UI 测试优先点击可访问按钮。
- Fix/Quality：移除无意义的 WKWebView downcast；并发计数器封装以消除 Swift 6 警告。

### Why

- 极端宽表格在纯缩放策略下会缩得过小，阅读困难；需要“最小缩放 + 换行”兜底。
- 性能测试跳过时仍会进入 tearDown，需保证资源释放逻辑安全。
- 持续清理编译警告，降低 Swift 6 迁移成本。

### Result

- 表格导出既不截断也不过度缩小，极端宽表格可读性提升。
- 性能测试在跳过时不再 crash，测试更稳。
- 编译警告减少，代码更干净。

---

## 📂 核心改动

- `Scopy/Views/History/MarkdownExportService.swift`
  - 表格导出：缩放比例 < 0.35 时固定为 0.35 并启用换行。
- `Scopy/Views/History/HistoryItemView.swift`
  - hover 预览图片解码采用 Sendable 包装，避免跨线程警告。
- `Scopy/Views/History/HoverPreviewImageCache.swift`
- `Scopy/Views/History/HoverPreviewImageQualityPolicy.swift`
  - 预览缓存与质量策略抽离。
- `Scopy/Views/History/MarkdownPreviewWebView.swift`
  - 移除无意义 WKWebView downcast。
- `ScopyTests/PerformanceTests.swift`
  - skip 后 tearDown 安全释放。
- `ScopyTests/ReviewFix24Tests.swift`
  - 并发计数器封装，清理 Swift 6 警告。
- `ScopyUITests/ExportMarkdownPNGUITests.swift`
  - 导出 UI 测试优先点击可访问按钮。

---

## 🎯 测试

- Release 构建：`xcodebuild build -scheme Scopy -configuration Release MARKETING_VERSION=0.50 CURRENT_PROJECT_VERSION=185` ✅
- 单元测试：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests` ✅（Executed 260 tests, 25 skipped, 0 failures）

---

## 🔮 遗留与后续

- UI tests 未复验（本机 UI automation 未就绪时需跳过）。
