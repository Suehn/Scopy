# v0.43.27 â€” Refactor/Previewï¼šé¢„è§ˆæ¸²æŸ“å®ç°æ”¶æ•›ï¼ˆç¯å¢ƒ SSOT + è½»é‡å·¥å…·å¤ç”¨ï¼‰+ KaTeX è¯­æ³•å›å½’æµ‹è¯•

**æ—¥æœŸ**ï¼š2025-12-16

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- **æ¸²æŸ“è§„åˆ™å•ä¸€çœŸæºï¼ˆSSOTï¼‰**ï¼š
  - æ–°å¢ `MathEnvironmentSupport`ï¼Œé›†ä¸­ç»´æŠ¤ KaTeX auto-render çš„ç¯å¢ƒ delimiters ä¸å¯è¯†åˆ« `\\begin{...}` ç¯å¢ƒé›†åˆï¼Œé¿å… Swift/JS/æµ‹è¯•ä¸‰å¤„åˆ—è¡¨æ¼‚ç§»ã€‚
- **é‡å¤é€»è¾‘æŠ½è±¡å¤ç”¨**ï¼š
  - æ–°å¢ `MarkdownCodeSkipper` ç»Ÿä¸€ fenced code / inline code è·³è¿‡é€»è¾‘ä¸ç¼©è¿›è®¡ç®—ï¼Œå‡å°‘ `LaTeXDocumentNormalizer` / `MathNormalizer` / `MathProtector` çš„é‡å¤å®ç°ã€‚
- **æ€§èƒ½ä¸é²æ£’æ€§å¾®ä¼˜åŒ–**ï¼š
  - `MarkdownDetector.isLikelyMarkdown` å¯¹è¶…å¤§æ–‡æœ¬ï¼ˆ> 200k UTF-16ï¼‰ç›´æ¥å¿«é€Ÿè¿”å›ï¼Œé¿å… hover æ—¶æ— æ„ä¹‰çš„æ‰«ææˆæœ¬ã€‚
  - `MarkdownPreviewWebView` çš„ç½‘ç»œé˜»æ–­è§„åˆ™ç¼–è¯‘å¤±è´¥æ—¶èƒ½æ­£ç¡®å¤ä½çŠ¶æ€ï¼Œé¿å…åç»­æ°¸è¿œå¤„äº compiling çŠ¶æ€ã€‚
  - `MarkdownHTMLRenderer` çš„ placeholder æ›¿æ¢ä» O(n*m) å¾ªç¯ split/join æ”¶æ•›ä¸ºä¸€æ¬¡ `replace(regex)` æ˜ å°„æ›¿æ¢ã€‚
- **å®‰å…¨æ”¶æ•›**ï¼š
  - CSP æ”¶ç´§ `img-src`ï¼Œç§»é™¤ `file:`ï¼Œé¿å…å‰ªè´´æ¿ Markdown é€šè¿‡å›¾ç‰‡è¯­æ³•è¯»å–æœ¬æœºä»»æ„è·¯å¾„æ–‡ä»¶ã€‚
- **æµ‹è¯•è¡¥å¼º**ï¼š
  - æ–°å¢ `KaTeXRenderToStringTests`ï¼šç”¨ `JavaScriptCore` ç›´æ¥åŠ è½½ `katex.min.js`ï¼Œå¯¹å¤šæ®µçœŸå®æ ·ä¾‹ï¼ˆè¡¨æ ¼+ç¬¦å·è¡¨ã€spin-wave è®ºæ–‡ç‰‡æ®µï¼‰çš„æ¯ä¸ªæ•°å­¦ç‰‡æ®µæ‰§è¡Œ `katex.renderToString`ï¼Œå°†â€œçº¢å­—/è¯­æ³•é”™è¯¯â€ä½œä¸ºå•æµ‹å›å½’é—¨æ§›ã€‚
  - è¡¥å…… `MarkdownMathRenderingTests`ï¼šè¦†ç›– `(\mathcal{U})` è¿™ç±»æ—  `$` åŒ…è£¹çš„æ‹¬å·å…¬å¼ä¸ `\\( ... \\)` / `\\[ ... \\]` çš„ä¿æŠ¤è¡Œä¸ºã€‚

### Why

- é¢„è§ˆæ¸²æŸ“ç›¸å…³çš„ç¯å¢ƒåˆ—è¡¨/è·³è¿‡è§„åˆ™åˆ†æ•£åœ¨å¤šå¤„ï¼Œåç»­æ¯æ¬¡ä¿®å¤éƒ½å®¹æ˜“å‡ºç°â€œæ”¹äº† A å¿˜äº† Bâ€å¯¼è‡´å›å½’ã€‚
- ä¹‹å‰å°è¯• WKWebView ç«¯åˆ°ç«¯æµ‹è¯•åœ¨ unit test ç¯å¢ƒä¸‹æ˜“å—ç³»ç»Ÿ entitlement å½±å“ï¼›æ”¹ä¸º `JavaScriptCore + KaTeX renderToString` å¯ç¨³å®šã€å¯ CI çš„æ–¹å¼éªŒè¯â€œå…¬å¼å¯è§£æâ€ã€‚

### Result

- é¢„è§ˆæ¸²æŸ“å®ç°æ›´è½»é‡ã€æ›´æ˜“ç»´æŠ¤ï¼šç¯å¢ƒåˆ—è¡¨/è·³è¿‡é€»è¾‘ç»Ÿä¸€ï¼Œä¿®æ”¹ç‚¹æ›´é›†ä¸­ã€‚
- å¯¹çœŸå®è®ºæ–‡/ç¬”è®°æ ·ä¾‹çš„ KaTeX è§£æèƒ½åŠ›åŠ å…¥å›å½’é—¨æ§›ï¼Œé™ä½æœªæ¥æ”¹åŠ¨å¼•å…¥å…¬å¼çº¢å­—çš„æ¦‚ç‡ã€‚

---

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶

- `Scopy/Views/History/MathEnvironmentSupport.swift`
- `Scopy/Views/History/MarkdownCodeSkipper.swift`
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`
- `Scopy/Views/History/MathNormalizer.swift`
- `Scopy/Views/History/MathProtector.swift`
- `Scopy/Views/History/LaTeXDocumentNormalizer.swift`
- `Scopy/Views/History/MarkdownDetector.swift`
- `Scopy/Views/History/MarkdownPreviewWebView.swift`
- `ScopyTests/KaTeXRenderToStringTests.swift`
- `ScopyTests/MarkdownMathRenderingTests.swift`
- `Scopy.xcodeproj/project.pbxproj`
- `doc/implemented-doc/README.md`
- `doc/implemented-doc/CHANGELOG.md`

---

## âœ… æµ‹è¯•ä¸æ„å»º

**æµ‹è¯•ç¯å¢ƒ**ï¼šApple M3ï¼ˆ24 GBï¼‰ / macOS 15.7.2ï¼ˆ24G325ï¼‰ / Debug / 2025-12-16

- å®šå‘å•æµ‹ï¼š`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/MarkdownMathRenderingTests -only-testing:ScopyTests/KaTeXRenderToStringTests` âœ…
- Release æ„å»ºï¼š`xcodebuild build -scheme Scopy -configuration Release -destination 'platform=macOS'` âœ…ï¼ˆä½¿ç”¨ç‹¬ç«‹ `-derivedDataPath` é¿å… build.db é”å†²çªï¼‰
