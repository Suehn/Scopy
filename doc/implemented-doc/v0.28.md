# v0.28 - P0 æ€§èƒ½ï¼šé‡è½½å…¨é‡æ¨¡ç³Šæœç´¢æé€Ÿ + å›¾ç‰‡ç®¡çº¿åå°åŒ–

**æ—¥æœŸ**: 2025-12-12

---

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“

### What
- å…¨é‡ Fuzzy/Fuzzy+ åœ¨ 50kâ€“75k ç£ç›˜é‡è½½ä¸‹ä»åæ…¢çš„é—®é¢˜ï¼Œå®Œæˆ P0 æé€Ÿå¹¶è¾¾æ ‡ã€‚
- å›¾ç‰‡ç¼©ç•¥å›¾ä¸ hover é¢„è§ˆé“¾è·¯ç»§ç»­åå°åŒ–ï¼Œç§»é™¤ä¸»çº¿ç¨‹é‡æ´»ã€‚

### Why
- `SearchService.searchInFullIndex` åœ¨å€™é€‰é›†æå¤§æ—¶ä»éœ€å¯¹æ‰€æœ‰å€™é€‰åšè¯„åˆ†/æ’åºï¼›Debug ä¸‹ 50k/75k P95 è¶…æ ‡ã€‚
- ç¼©ç•¥å›¾ç”Ÿæˆ/å›¾ç‰‡é¢„è§ˆä»å­˜åœ¨ MainActor çš„ AppKit è§£ç /ç»˜åˆ¶ä¸ç£ç›˜ I/Oï¼Œå¯¼è‡´å¶å‘ UI å¡é¡¿ã€‚

### Result
- é‡è½½ç£ç›˜ fuzzy è¾¾åˆ° v0.md 4.1 ç›®æ ‡ï¼ˆé¦–å± P95 â‰¤ 200â€“250msï¼‰ã€‚
- å›¾ç‰‡ç¼©ç•¥å›¾ç”Ÿæˆã€åŸå›¾è¯»å–ã€é¢„è§ˆ downsample å…¨é“¾è·¯åå°åŒ–ï¼Œä¸»çº¿ç¨‹åªåšçŠ¶æ€æ›´æ–°ã€‚

---

## ğŸ—ï¸ æ ¸å¿ƒå®ç°

### 1) å…¨é‡æ¨¡ç³Šæœç´¢é‡è½½æé€Ÿ

**æ–‡ä»¶**ï¼š`Scopy/Services/SearchService.swift`

- **postings æœ‰åºäº¤é›†**ï¼šç”¨åŒæŒ‡é’ˆäº¤é›†æ›¿ä»£ `Set.formIntersection`ï¼Œå‡å°‘å“ˆå¸Œ/ä¸´æ—¶åˆ†é…ã€‚
- **Partial topâ€‘K æ’åº**ï¼šä»…ç»´æŠ¤ `offset+limit+1` å°é¡¶å †ï¼Œé¿å…å…¨é‡ sortã€‚
- **è‡ªé€‚åº” FTS é¢„ç­›**ï¼ˆä»…é¦–å±ã€å·¨å¤§å€™é€‰é›†ã€ASCII å•è¯æŸ¥è¯¢ï¼‰ï¼š
  - å½“å€™é€‰é›† â‰¥ 20k ä¸” `offset==0` æ—¶ï¼Œå…ˆç”¨ FTS5 å– topâ€‘K idï¼ˆé»˜è®¤ â‰¥ 5kï¼‰ï¼Œå†åœ¨è¯¥å­é›†ä¸Š fuzzy è¯„åˆ†æ’åºã€‚
  - `total` ç½®ä¸º `-1` è¡¨ç¤ºæœªçŸ¥ï¼›`hasMore` ä¾æ®é¦–å±æ˜¯å¦æ»¡é¡µä¼°è®¡ï¼Œåç»­åˆ†é¡µä»èµ°å…¨é‡ fuzzy ä¿éšœè¦†ç›–ã€‚
  - pinned ç›¸å…³å€™é€‰é¢å¤–å¹¶å…¥ï¼Œé¿å… pinned æ¼å¬å›ã€‚

### 2) å›¾ç‰‡ç¼©ç•¥å›¾/é¢„è§ˆåå°åŒ–

**æ–‡ä»¶**ï¼š`Scopy/Services/StorageService.swift`ã€`Scopy/Services/RealClipboardService.swift`ã€`Scopy/Views/HistoryListView.swift`

- **ImageIO ç¼©ç•¥å›¾ç”Ÿæˆ**ï¼š
  - æ–°å¢ `StorageService.makeThumbnailPNG`ï¼Œç”¨ `CGImageSourceCreateThumbnailAtIndex` + `CGImageDestination` åå° downsample/ç¼–ç ã€‚
  - `handleNewContent` ä¸å†åŒæ­¥ç”Ÿæˆç¼©ç•¥å›¾ï¼Œæ”¹ä¸ºè°ƒåº¦åå°ä»»åŠ¡ã€‚
- **åŸå›¾æ•°æ®åå°è¯»å–**ï¼š
  - `RealClipboardService.getImageData` å¯¹å¤–éƒ¨å¤§å›¾èµ° `Task.detached` ç£ç›˜è¯»å–ï¼›å°å›¾ç›´æ¥ç”¨å†…è” rawDataã€‚
- **Hover é¢„è§ˆ downsample**ï¼š
  - `HistoryItemView.startPreviewTask` åœ¨åå°æŒ‰ `previewMax` åš downsampleï¼Œå†å›ä¸»çº¿ç¨‹å±•ç¤ºï¼Œé¿å…åŸå›¾è§£ç å³°å€¼ã€‚

---

## âœ… ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

- `Scopy/Services/SearchService.swift`
  - postings äº¤é›†/Topâ€‘K å †æ’åºã€è‡ªé€‚åº” FTS é¢„ç­›ã€‚
- `Scopy/Services/StorageService.swift`
  - ImageIO ç¼©ç•¥å›¾ç”Ÿæˆ + åŸå­ä¿å­˜ã€‚
- `Scopy/Services/RealClipboardService.swift`
  - ç¼©ç•¥å›¾ç”Ÿæˆåå°è°ƒåº¦ï¼›åŸå›¾æ•°æ®åå°è¯»å–ã€‚
- `Scopy/Views/HistoryListView.swift`
  - hover é¢„è§ˆ downsampleã€‚
- `ScopyTests/SearchServiceTests.swift`
  - æ–°å¢ pinned fuzzy æ’åºå›å½’æµ‹è¯•ã€‚

---

## ğŸ§ª æµ‹è¯• & æ€§èƒ½

- `make test-unit` âœ… **52 tests passed** (1 perf skipped)
- `make test-perf` âœ… **22/22 passed (å«é‡è½½)**

**æ€§èƒ½å®æµ‹ï¼ˆApple Silicon, macOS 14, Debug, `make test-perf`ï¼‰**ï¼š
- Fuzzy 5k items P95 â‰ˆ 5.1ms
- Fuzzy 10k items P95 â‰ˆ 47ms
- Disk 25k fuzzy P95 â‰ˆ 43ms
- Heavy Disk 50k fuzzy P95 â‰ˆ 90.6ms
- Ultra Disk 75k fuzzy P95 â‰ˆ 124.7ms

---

**ç»´æŠ¤è€…**: Claude Code  
**æœ€åæ›´æ–°**: 2025-12-12

