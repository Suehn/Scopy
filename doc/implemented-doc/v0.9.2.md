# v0.9.2 - 过滤功能修复

## 📌 一页纸总结

**What**: 修复 v0.9 过滤功能的 4 个问题

**Why**:
- App 图标位置不一致：text 类型在左侧，image/file 类型在右侧
- App 过滤选项为空：SQL 语法错误导致查询失败
- Type 过滤选项过多：包含 RTF/HTML，用户只需要 text/image/file
- Type 过滤滚动时取消：有过滤条件时 loadMore 重置了过滤状态

**Result**:
- 所有类型的项目，app 图标都统一在左侧显示
- App 过滤下拉菜单正确显示最近使用的 app
- Type 过滤只保留 Text/Image/File 三种类型
- 有过滤条件时不触发 loadMore，保持过滤状态

---

## 🏗️ 实现路线

### Fix 1: App 图标位置统一

**问题分析**:
- 当前逻辑 (HistoryListView.swift:99-128):
  - text 类型：左侧显示 app 图标
  - image 类型：左侧显示缩略图/photo 图标，右侧显示 app 图标
  - file 类型：左侧显示 doc.fill 图标，右侧显示 app 图标

**修复方案**:
1. 修改 `HistoryItemView` 的 body 布局
2. 左侧始终显示 app 图标（无图标时显示默认 "app" 图标）
3. 内容区域根据类型显示缩略图/文件图标/文本
4. 右侧只显示时间和 Pin 标记（不再显示 app 图标）

### Fix 2: App 过滤选项为空

**问题分析**:
- `StorageService.getRecentApps()` SQL 语法错误
- 使用 `SELECT DISTINCT ... ORDER BY MAX(last_used_at)` 但没有 `GROUP BY`

**修复方案**:
```sql
-- 修复前（错误）
SELECT DISTINCT app_bundle_id FROM clipboard_items
WHERE app_bundle_id IS NOT NULL AND app_bundle_id != ''
ORDER BY MAX(last_used_at) DESC
LIMIT ?

-- 修复后（正确）
SELECT app_bundle_id FROM clipboard_items
WHERE app_bundle_id IS NOT NULL AND app_bundle_id != ''
GROUP BY app_bundle_id
ORDER BY MAX(last_used_at) DESC
LIMIT ?
```

### Fix 3: Type 过滤选项简化

**问题分析**:
- 当前包含 5 种类型：Text/Image/File/RTF/HTML
- 用户反馈只需要 3 种：Text/Image/File

**修复方案**:
1. 修改 `HeaderView.swift` 的 TypeFilterButton
2. 移除 RTF 和 HTML 选项
3. 只保留 Text/Image/File

### Fix 4: Type 过滤滚动时取消

**问题分析**:
- `HistoryListView` 中 loadMore 触发条件：`appState.canLoadMore && appState.searchQuery.isEmpty`
- 当有 typeFilter 但没有 searchQuery 时，loadMore 会被触发
- `loadMore()` 调用 `fetchRecent()` 不应用过滤条件

**修复方案**:
1. 添加 `hasActiveFilters` 计算属性到 `AppState`
   ```swift
   var hasActiveFilters: Bool {
       !searchQuery.isEmpty || appFilter != nil || typeFilter != nil
   }
   ```
2. 修改 loadMore 触发条件：`appState.canLoadMore && !appState.hasActiveFilters`

---

## 📂 核心改动

| 文件 | 改动 |
|------|------|
| `Views/HistoryListView.swift` | 统一 app 图标在左侧，修改 loadMore 触发条件 |
| `Views/HeaderView.swift` | 移除 RTF/HTML 过滤选项 |
| `Observables/AppState.swift` | 添加 `hasActiveFilters` 计算属性 |
| `Services/StorageService.swift` | 修复 `getRecentApps()` SQL 语法（GROUP BY） |

---

## 🎯 关键指标

| 指标 | 结果 |
|------|------|
| 构建状态 | Debug ✅ |
| 测试状态 | 80/80 passed (1 skipped) |
| App 图标位置 | 统一左侧 |
| App 过滤选项 | 正确显示 8 个 app |
| Type 过滤选项 | Text/Image/File |
| 过滤状态保持 | 滚动时不重置 |

---

## 📊 当前状态

```
项目状态检查:
  ✅ App 图标位置: 所有类型统一在左侧
  ✅ App 过滤选项: 正确显示最近使用的 app
  ✅ Type 过滤选项: 只有 Text/Image/File
  ✅ 过滤状态保持: 滚动时不会取消

功能状态:
  ✅ HistoryItemView 布局: 左侧 app 图标 + 内容 + 右侧时间/Pin
  ✅ SQL 查询: GROUP BY app_bundle_id ORDER BY MAX(last_used_at)
  ✅ hasActiveFilters: 检查搜索词/app过滤/类型过滤
  ✅ loadMore 条件: canLoadMore && !hasActiveFilters
```

---

## 🔮 遗留与后续

### v0.md 进度 Review

**已实现 ✅**
- [x] 前后端分离架构 (ClipboardServiceProtocol)
- [x] 菜单栏图标 + 快捷键弹出 (⇧⌘C，可自定义)
- [x] 搜索框 + 列表显示
- [x] 列表右侧：时间 / Pin 标记
- [x] **列表左侧：统一 app 图标** (v0.9.2 修复)
- [x] 分级存储（SQLite + 外部文件）
- [x] 懒加载分页 (首屏 50 条，每页 100 条)
- [x] 去重策略 (contentHash)
- [x] FTS5 搜索
- [x] 三种搜索模式（exact/fuzzy/regex）
- [x] Pin 功能
- [x] 设置窗口 (条数/空间/图片/文件)
- [x] 缩略图缓存 + LRU 管理 (v0.8)
- [x] 图片悬浮预览 (v0.8.1)
- [x] 按条数清理
- [x] 按时间清理 (maxDaysAge)
- [x] 按空间清理 (小内容 + 大内容)
- [x] 搜索防抖 (searchTask 取消机制)
- [x] App 过滤按钮 (v0.9)
- [x] Type 过滤按钮 (v0.9)
- [x] **过滤功能修复** (v0.9.2)

**未实现 ❌**
- [ ] 无（v0.md Phase 1 功能已全部实现）

### 后续计划
1. 性能优化（测试运行时间优化）
2. UI 细节打磨
3. 更多用户反馈收集

---

**最后更新**: 2025-11-27
**维护者**: Claude Code
