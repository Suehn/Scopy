# v0.36.1 - Phase 6 回归：Thread Sanitizer（Hosted Tests）

**日期**: 2025-12-13

---

## 一页纸总结

### What

- 新增 TSan 专用测试方案（Hosted test bundle mode）：
  - 新 target：`ScopyTestHost`（最小 AppKit host）
  - 新 target：`ScopyTSanTests`（Hosted unit tests）
  - 新 scheme：`ScopyTSan`
  - 新命令：`make test-tsan`
- 修复 Hosted tests 启动崩溃：为 unit-test bundle 显式设置 `NSPrincipalClass = XCTestCase`，避免注入时创建第二个 `NSApplication`。
- 让同一套测试代码同时支持两种模式：`ScopyTests` 继续 `@testable import Scopy`；`ScopyTSanTests` 通过 `-DSCOPY_TSAN_TESTS` 禁用该 import（测试与源码同模块编译）。

### Why

- 现有“独立测试 bundle 模式”无法直接开启 Thread Sanitizer：TSan runtime 通过 `dlopen` 加载过晚会报 `Interceptors are not working ... loaded too late`，无法作为并发回归门槛。
- 直接用 `Scopy.app` 作为 test host 会触发 SwiftUI `@main` 生命周期与 XCTest 冲突（历史上导致 “Test runner never began executing tests after launching”）。
- Hosted test bundle 注入时若 bundle 的 `NSPrincipalClass` 为 `NSApplication` 会触发 “Creating more than one Application” 崩溃，必须修正。

### Result

- Thread Sanitizer 回归可执行且稳定：`make test-tsan` 通过（132 tests, 1 skipped, 0 failures）。
- 原有单测流程不受影响：`make test-unit` 通过（53 tests, 1 skipped, 0 failures）。

---

## 核心实现

### Hosted test bundle（TSan 专用）

- 新增 `ScopyTestHost`：最小 `NSApplicationMain` 宿主（`activationPolicy = .prohibited`），仅用于承载 XCTest 注入并确保 TSan runtime 在进程启动时加载。
- 新增 `ScopyTSanTests`：
  - sources：复用 `ScopyTests/`（排除 Integration/Performance）并包含 `Scopy/` 源码（排除 `main.swift` / `ScopyApp.swift` 等入口文件）。
  - build：配置 `TEST_HOST` / `BUNDLE_LOADER` 指向 `ScopyTestHost`。
  - flags：`-DSCOPY_TSAN_TESTS` 用于条件编译。

### 修复 “Creating more than one Application”

- 为 unit-test bundle 显式设置 `INFOPLIST_KEY_NSPrincipalClass = XCTestCase`，避免 XCTest 在创建 bundle principal class 时实例化 `NSApplication()`。

---

## 修改文件列表（核心）

- `project.yml`
- `Makefile`
- `ScopyTestHost/main.swift`
- `ScopyTests/*`（条件编译包裹 `@testable import Scopy`）
- `Scopy.xcodeproj/project.pbxproj`（`xcodegen generate`）
- `Scopy.xcodeproj/xcshareddata/xcschemes/ScopyTSan.xcscheme`

---

## 关键指标

### 测试

- Thread Sanitizer：`make test-tsan` **132 tests**（1 skipped，0 failures）
- 单元测试：`make test-unit` **53 tests**（1 skipped，0 failures）

### 环境

- Apple M3 / macOS 15.7.2（24G325）/ arm64 / Xcode 16.3（16E140）/ 2025-12-13

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-tsan`
- ⏳ `/tmp/scopy_hotkey.log`（本版本无热键代码改动；按 `doc/review/review-v0.3.md` 仍建议人工自查一次）

---

## 遗留与后续

- Thread Sanitizer 已可跑通；Strict Concurrency 建议继续按 `doc/review/review-v0.3.md` 渐进开启（先从 tests target 开始）。

