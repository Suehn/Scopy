# v0.43.2 - Perf/UX：Low Power Mode 滚动优化 + 搜索取消更及时

**日期**: 2025-12-14

---

## 一页纸总结

### What

- **滚动期间降载**：List 实时滚动时标记 `isScrolling`，暂缓缩略图异步加载、禁用悬停预览/悬停选中，并减少动画开销，降低快速滚动时主线程压力（尤其 Low Power Mode）。
- **滚动事件更可靠**：新增 `ListLiveScrollObserverView` 监听 `NSScrollView.didLiveScrollNotification`，把滚动状态从“函数存在但未触发”变成真实可用的信号。
- **搜索取消更及时**：Search actor 在取消/超时时调用 `sqlite3_interrupt` 中断只读查询，减少尾部浪费；同时 **短词（≤2）模糊搜索走 recent cache**，避免触发全量 fuzzy/refine 的重路径。

### Why

- Low Power Mode 下 CPU 降频更明显，滚动时若仍触发缩略图 IO/解码、popover 预览、动画与频繁 selection 更新，会放大掉帧体感。
- 搜索在取消/超时时如果 DB 查询仍继续跑，会占用 CPU/IO 与连接资源，影响交互尾部与功耗。

### Result

- 交互：快速滚动更稳（滚动期减少附加工作，结束后恢复正常加载/预览）。
- 搜索：取消/超时更“干净”，短词模糊更轻量。
- 回归通过：
  - `make test-unit`：53 passed, 1 skipped
  - `make test-perf`：22 passed, 6 skipped
  - `make test-tsan`：132 passed, 1 skipped
  - `make test-strict`：166 passed, 7 skipped

---

## 实现路线

1. 新增 `ListLiveScrollObserverView`：从 List 的 enclosing `NSScrollView` 监听 live scroll 通知，回调到 `HistoryViewModel.onScroll()`。
2. `HistoryViewModel`：将滚动状态做成“长按保持、间歇结束”的节流，不为每个滚动通知创建新 Task。
3. `HistoryItemView/ThumbnailView`：滚动期暂停缩略图加载与 hover 预览，避免 popover/解码/动画抢占主线程。
4. `SearchEngineImpl`：withTimeout + cancellation handler 触发 `sqlite3_interrupt`；短词 fuzzy/fuzzyPlus 走 cache，避免不必要的全量路径。

---

## 核心改动

- `Scopy/Views/History/ListLiveScrollObserverView.swift`
- `Scopy/Views/HistoryListView.swift`
- `Scopy/Observables/HistoryViewModel.swift`
- `Scopy/Views/History/HistoryItemView.swift`
- `Scopy/Views/History/HistoryItemThumbnailView.swift`
- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 passed** (1 skipped)
- 性能测试：`make test-perf` **22 passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)
- Thread Sanitizer：`make test-tsan` **132 passed** (1 skipped)
- Strict Concurrency：`make test-strict` **166 passed** (7 skipped)

### 性能（Debug / `make test-perf` 单次运行）

- 环境：MacBook Air (Apple M3, 24 GB) / macOS 15.7.2（24G325）/ arm64 / 2025-12-14
- 电源：Low Power Mode = enabled（`pmset -g` 显示 `lowpowermode 1`）
- 关键结果：
  - Fuzzy 5k items P95 ≈ 8.45ms
  - Fuzzy 10k items P95 ≈ 78.50ms（Samples: 50；Low Power Mode 下测试阈值放宽至 300ms）
  - Disk 25k fuzzy P95 ≈ 104.57ms（Samples: 50）
  - Bulk insert 1000 items ≈ 83.76ms（≈11,940 items/s）
  - Fetch recent (50 items) avg ≈ 0.12ms
  - Regex 20k items P95 ≈ 5.20ms
  - Mixed content disk search（single run）≈ 7.31ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 若要量化“Low Power Mode 下滚动帧率/掉帧”，建议补充一个最小可复现脚本或 UI Perf baseline（例如 Instruments: Core Animation / Time Profiler），并把关键数据写入 `doc/profile/`。
- Rust 后端可行但属于“架构级替换”，建议先用本轮的 `sqlite3_interrupt` + 短词 cache 验证是否已满足体感目标，再决定是否引入跨语言维护成本。
