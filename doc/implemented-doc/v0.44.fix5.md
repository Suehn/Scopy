# v0.44.fix5

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Perf/Searchï¼šä¼˜åŒ– FTS5 æŸ¥è¯¢æ„é€ ï¼ˆå¤šè¯é»˜è®¤æŒ‰ `AND` ç»„åˆ + ç»Ÿä¸€è½¬ä¹‰ï¼‰ï¼Œå¹¶åœ¨ SQLite è¿æ¥ä¸Šå¯ç”¨ `mmap_size` æå‡å¤§åº“è¯»å–æ€§èƒ½ï¼›åŒæ—¶è®© fuzzy(Plus) åœ¨å€™é€‰é›†è¿‡å¤§æ—¶æ›´æ—©ä½¿ç”¨ FTS é¢„ç­›ã€‚

### Why

- ä¸‡å­—é•¿æ–‡ä¼šè®©â€œæŒ‰å­—ç¬¦é›†åˆç­›å€™é€‰â€çš„ fuzzy å€™é€‰é›†è†¨èƒ€ï¼Œå¯¼è‡´åç»­é€æ¡æ‰“åˆ†æ‰«ææˆæœ¬é™¡å¢ã€‚
- åŸå…ˆ exact æœç´¢æŠŠæ•´æ®µ query åŒ…æˆ phraseï¼ˆ`"a b c"`ï¼‰ï¼Œå¯¹å¤šè¯è¾“å…¥æ›´å®¹æ˜“é”™å¤±â€œåŒä¸€æ¡é‡Œè¯ä¸ç›¸é‚»â€çš„çœŸå®åŒ¹é…ï¼›å¹¶ä¸”åŒ…å«å¼•å·ç­‰ç‰¹æ®Šå­—ç¬¦æ—¶æ›´å®¹æ˜“ç”Ÿæˆéæ³• FTS è¯­å¥ï¼ˆå¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼‰ã€‚

### Result

- exact æœç´¢ï¼šå¤šè¯è¾“å…¥é»˜è®¤æ”¹ä¸º `word1 AND word2 ...`ï¼Œå…¼å®¹æ€§æ›´å¥½ä¸”é¿å… phrase ä½ç½®ç´¢å¼•å¸¦æ¥çš„ä¸å¿…è¦å¼€é”€ã€‚
- ç‰¹æ®Šå­—ç¬¦ï¼ˆ`"`, `*`, `-`ï¼‰è¾“å…¥ä¸å†å¯¼è‡´ FTS MATCH è§£æå¤±è´¥ï¼ˆæµ‹è¯•è¦†ç›–ï¼‰ã€‚
- å¤§åº“è¯»å–ï¼šæ‰“å¼€ DB æ—¶å¯ç”¨ `PRAGMA mmap_size = 268435456`ï¼ˆ256MBï¼‰ï¼Œå‡å°‘å¤§é‡éšæœºè¯»å–çš„ç³»ç»Ÿè°ƒç”¨å¼€é”€ã€‚

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. æ–°å¢ `FTSQueryBuilder`ï¼šç»Ÿä¸€åš query å½’ä¸€åŒ–ï¼ˆ`*` åˆ é™¤ã€`-`â†’ç©ºæ ¼ï¼‰ã€åˆ†è¯ä¸å®‰å…¨è½¬ä¹‰ï¼ˆ`"`â†’`""`ï¼‰ï¼Œå¹¶å°†å¤šè¯ç»„åˆä¸º `AND`ã€‚
2. exact æœç´¢æ”¹ç”¨ `FTSQueryBuilder`ï¼Œé¿å…æ•´æ®µ phraseã€‚
3. fuzzy(Plus) å¤§å€™é€‰é›†è·¯å¾„æ”¹ç”¨ `FTSQueryBuilder` å¹¶æ›´æ—©è§¦å‘ FTS é¢„ç­›ï¼Œé™ä½â€œé•¿æ–‡å¯¼è‡´å€™é€‰é›†è¿‡å¤§â€çš„ CPU å‹åŠ›ã€‚
4. SQLite è¯»å†™è¿æ¥å¯ç”¨ `mmap_size`ï¼ˆä¿å®ˆ 256MBï¼‰ï¼Œæå‡å¤§åº“æŸ¥è¯¢ååã€‚
5. å¢åŠ å›å½’æµ‹è¯•ï¼š
   - `FTSQueryBuilderTests`ï¼šè¦†ç›–ç©ºç™½/å¤šè¯/é€šé…ç¬¦/è¿å­—ç¬¦ç­‰æ„é€ è§„åˆ™ã€‚
   - `SearchServiceTests`ï¼šè¦†ç›– exact å¤šè¯ AND è¡Œä¸ºä¸ç‰¹æ®Šå­—ç¬¦ä¸å´©æºƒã€‚
   - `PerformanceTests`ï¼šæ–°å¢é•¿æ–‡ exact çš„è½»é‡å›å½’åŸºçº¿ç”¨ä¾‹ï¼ˆä¸ä¾èµ– env/scheme ä¼ å‚ï¼‰ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Infrastructure/Search/FTSQueryBuilder.swift`ï¼šFTS query æ„é€ ä¸è½¬ä¹‰çš„å•ä¸€æ¥æºã€‚
- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`ï¼šexact ä¸ fuzzy é¢„ç­›è·¯å¾„æ”¹ç”¨ `FTSQueryBuilder`ï¼›FTS é¢„ç­›è§¦å‘æ¡ä»¶æ›´è´´è¿‘å¤§å€™é€‰é›†åœºæ™¯ï¼›SQLite read connection å¯ç”¨ `mmap_size`ã€‚
- `Scopy/Infrastructure/Persistence/SQLiteClipboardRepository.swift`ï¼šSQLite write connection å¯ç”¨ `mmap_size`ã€‚
- `ScopyTests/FTSQueryBuilderTests.swift`ï¼šæ„é€ è§„åˆ™å›å½’æµ‹è¯•ã€‚
- `ScopyTests/SearchServiceTests.swift`ï¼šå¤šè¯ exact/ç‰¹æ®Šå­—ç¬¦ç”¨ä¾‹è¡¥é½ã€‚
- `ScopyTests/PerformanceTests.swift`ï¼šæ–°å¢é•¿æ–‡ exact æ€§èƒ½å›å½’ç”¨ä¾‹ã€‚

---

## ğŸ¯ å…³é”®æŒ‡æ ‡

- **Disk æœç´¢ï¼ˆ25k items, fuzzyPlusï¼‰**ï¼š
  - cold startï¼š710.20ms
  - P95ï¼š47.56msï¼ˆSamples: 60ï¼‰
  - å‘½ä»¤ï¼š`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/PerformanceTests/testDiskBackedSearchPerformance25k`
- **é•¿æ–‡ exact å›å½’ï¼ˆ40 docs, ~15840 charsï¼‰**ï¼š
  - P95ï¼š0.23msï¼ˆSamples: 20ï¼‰
  - å‘½ä»¤ï¼š`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/PerformanceTests/testExactSearchPerformanceLongDocuments`
- **ç¯å¢ƒ**ï¼š`hw.model=Mac15,12`ï¼›å†…å­˜ 24GBï¼›macOS 15.7.2ï¼ˆ24G325ï¼‰ï¼›Xcode 16.3ï¼ˆ16E140ï¼‰

---

## ğŸ“Š å½“å‰çŠ¶æ€

- å•å…ƒæµ‹è¯•ï¼ˆå®šå‘ï¼‰ï¼š`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/SearchServiceTests -only-testing:ScopyTests/FTSQueryBuilderTests` âœ…
- æ€§èƒ½å›å½’ï¼ˆå®šå‘ï¼‰ï¼š`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/PerformanceTests/testDiskBackedSearchPerformance25k -only-testing:ScopyTests/PerformanceTests/testExactSearchPerformanceLongDocuments` âœ…

---

## ğŸ”® é—ç•™ä¸åç»­

- å¦‚æœé•¿æ–‡æ•°é‡è¿›ä¸€æ­¥æå‡ï¼ˆä¾‹å¦‚â€œå¾ˆå¤šæ¡éƒ½æ˜¯å‡ åä¸‡å­—ç¬¦â€ï¼‰ï¼Œå¯è€ƒè™‘ï¼š
  - FTS5 schema-level ä¼˜åŒ–ï¼ˆ`columnsize=0` / `detail=column`ï¼‰+ æŸ¥è¯¢è¯­ä¹‰è°ƒæ•´ï¼ˆç¦ phrase/NEARï¼‰ï¼Œä»¥æ˜¾è‘—é™ä½ç´¢å¼•ä½“ç§¯ä¸æ®µåˆå¹¶æˆæœ¬ã€‚
  - å¯¹è¶…é•¿æ–‡æœ¬åšåˆ†å—ç´¢å¼•ï¼ˆchunk rowid + èšåˆå‘½ä¸­ï¼‰ï¼Œæ”¹å–„æç«¯é•¿æ–‡çš„ç´¢å¼•ä¸æ›´æ–°æˆæœ¬ã€‚

