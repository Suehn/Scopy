# v0.27 - P0 准确性/性能：搜索与分页版本一致性修复

**日期**: 2025-12-12

---

## 📌 一页纸总结

### What
- 修复搜索过程中分页（loadMore）可能把**旧搜索结果混入新搜索列表**的问题。
- 该问题在全量模糊搜索下更明显：前 50 条相关、继续滚动后出现不相关条目。

### Why
- `AppState.loadMore()` 与 `AppState.search()` 都是异步 Task；搜索切换时旧分页任务仍可能完成并 append。
- 这会破坏 v0.md 4.3 的“结果准确、逐步刷新”体验，并增加无意义的搜索/渲染开销。

### Result
- 搜索切换时旧分页任务会被取消；分页只会对当前搜索版本生效。
- 结果列表在任何时刻都与当前搜索词严格一致。

---

## 🏗️ 核心实现

**文件**：`Scopy/Observables/AppState.swift`

1. **loadMore 捕获搜索版本**
   - 在分页 Task 开始时记录 `currentVersion = searchVersion`。
   - 在 append 前校验 `currentVersion == searchVersion`，否则丢弃结果。

2. **search 切换时取消旧分页**
   - 每次 `search()` 递增 `searchVersion` 后，立即 `cancel()` 当前 `loadMoreTask` 并清空引用。
   - 防止任何旧请求在 debounce/搜索完成后写回 UI。

---

## ✅ 修改文件列表

- `Scopy/Observables/AppState.swift`
  - 分页/搜索版本一致性保护。
- `ScopyTests/AppStateTests.swift`
  - Mock 服务支持可控延迟。
  - 新增竞态回归测试 `testLoadMoreDoesNotAppendAfterSearchChange`。

---

## 🧪 测试

- `make test-unit` ✅ **51 tests passed** (1 perf skipped)

---

**维护者**: Claude Code  
**最后更新**: 2025-12-12

