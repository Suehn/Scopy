# v0.44.fix6

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Preview：修复 `(...[...])` 这类“括号里包含方括号”的 loose-LaTeX 片段被二次包裹，导致生成嵌套 `$...$`、KaTeX 解析失败（预览出现红字 `left/right`）的问题。

### Why

- `MathNormalizer` 会先把 `(...)` 包成 `$\\left(...\\right)$`，随后再尝试把 `[...]` 包成 `$\\left[...\\right]$`。
- 如果第二轮扫描不避开第一轮新插入的 `$...$`，就会在同一个数学片段内注入新的 `$`，从而把原本完整的 `\\left/\\right` 对拆碎，触发 KaTeX parse error。

### Result

- `(...[...])` 这类片段现在会被稳定地包裹为**单个** `$...$` 数学段（内部 `[...]` 不再被重复包裹），KaTeX 可正常渲染。
- 增加回归测试覆盖 `\\rho=[\\rho_4,...]` 这一真实样例，避免未来回归。

---

## 🏗️ 实现路线

1. 在 `normalizePlainTextSegment` 的括号包裹逻辑中，对每一轮 `wrapBracketedMath` 之间重新按 `$...$` 分段处理。
2. 确保任何一次包裹插入的 `$...$` 都不会被后续包裹逻辑再次进入，从根源避免嵌套 `$` 与破坏 `\\left/\\right` 成对关系。
3. 新增 rho 向量回归测试；并复用现有 KaTeX render-to-string 覆盖验证不会出现 parse error。

---

## 📂 核心改动

- `Scopy/Views/History/MathNormalizer.swift`：括号包裹分多轮执行时，轮次之间按 `$...$` 重新分段，避免对已插入的数学段做二次包裹。
- `ScopyTests/MarkdownMathRenderingTests.swift`：新增 `\\rho=[\\rho_4,\\rho_3,\\rho_2,\\rho_1,\\rho_0]` 回归用例。

---

## 🎯 关键指标

- **单元测试**：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests -skip-testing:ScopyTests/IntegrationTests`（Executed 215 tests, 7 skipped, 0 failures）
- **性能基线（与本改动无关，用于防回退）**：
  - Disk 搜索（25k items, fuzzyPlus）：cold start 693.32ms；P95 54.31ms（Samples: 60）
  - Long-doc exact（40 docs, ~15840 chars）：P95 0.22ms（Samples: 20）
- **环境**：`hw.model=Mac15,12`；内存 24GB；macOS 15.7.2（24G325）；Xcode 16.3（16E140）

---

## 📊 当前状态

- 预览兼容性：不改变既有渲染语义（仅限制“后续包裹逻辑不进入新插入的 `$...$`”）✅
- 回归覆盖：rho 向量样例 + KaTeX render-to-string ✅

---

## 🔮 遗留与后续

- 如果未来需要“在同一个数学段里也把 `[...]` 升级为 `\\left[...\\right]`”，建议在**单次解析**中生成（而不是多轮扫描后叠加），避免再次引入嵌套 `$` 风险。
