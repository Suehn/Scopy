# v0.35 - vNext 重构：HistoryListView 拆分（List/Row/Thumbnail/Preview 分文件）

**日期**: 2025-12-13

---

## 一页纸总结

### What

- Phase 5（Presentation 收口）继续推进：将原先巨型 `Scopy/Views/HistoryListView.swift` 拆分为更小、更聚焦的视图文件：
  - 列表框架：`Scopy/Views/HistoryListView.swift`
  - Row：`Scopy/Views/History/HistoryItemView.swift`
  - Thumbnail：`Scopy/Views/History/HistoryItemThumbnailView.swift`
  - Hover preview 内容：`Scopy/Views/History/HistoryItemImagePreviewView.swift`、`Scopy/Views/History/HistoryItemTextPreviewView.swift`
  - 其余 UI 组件：`EmptyStateView/SectionHeader/LoadMoreTriggerView`

### Why

- 降低单文件认知负担与回归风险：把“列表/行/缩略图/预览”按职责拆开，便于后续继续把业务策略从 View 挪走（如 AppState 拆分、DTO 派生字段收口）。
- 更易于定位缓存与预览相关的稳定性问题（缩略图加载、popover/hover 行为）。

### Result

- `Scopy/Views/HistoryListView.swift` 从 ~872 行拆分到 ~129 行（职责单一：列表与分区）。
- 单元测试与性能测试通过：
  - `make test-unit` 通过（53 tests passed，1 skipped）
  - `xcodebuild test -only-testing:ScopyTests/AppStateTests -only-testing:ScopyTests/AppStateFallbackTests` 通过（46 tests passed）
  - `make test-perf` 通过（22 tests passed，6 skipped；heavy 场景需 `RUN_HEAVY_PERF_TESTS=1`）

---

## 核心实现

### 目录收口：History 相关视图集中

新增目录 `Scopy/Views/History/`，把历史列表相关组件聚合到一起，避免继续把复杂度堆在单文件。

### Thumbnail 与 Hover Preview 拆分

- `HistoryItemThumbnailView`：统一处理缩略图加载（复用 `ThumbnailCache`），Row 不再直接持有缩略图加载任务与状态。
- `HistoryItemImagePreviewView` / `HistoryItemTextPreviewView`：popover 内容单独成文件，Row 只负责触发与状态管理。

---

## 修改文件列表（核心）

- 修改：`Scopy/Views/HistoryListView.swift`
- 新增：`Scopy/Views/History/HistoryItemView.swift`
- 新增：`Scopy/Views/History/HistoryItemThumbnailView.swift`
- 新增：`Scopy/Views/History/HistoryItemImagePreviewView.swift`
- 新增：`Scopy/Views/History/HistoryItemTextPreviewView.swift`
- 新增：`Scopy/Views/History/SectionHeader.swift`
- 新增：`Scopy/Views/History/LoadMoreTriggerView.swift`
- 新增：`Scopy/Views/History/EmptyStateView.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- AppState：`xcodebuild test -only-testing:ScopyTests/AppStateTests -only-testing:ScopyTests/AppStateFallbackTests` **46 tests passed**
- 性能测试：`make test-perf` **22 tests passed** (6 skipped)

### 性能（Debug / `make test-perf`）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 4.69ms
  - Fuzzy 10k items P95 ≈ 44.81ms
  - Disk 25k fuzzy P95 ≈ 55.73ms
  - Mixed content disk search（single run, after warmup）≈ 4.20ms

---

## 遗留与后续

- Phase 5 继续（仍未完成）：
  - （可选）拆分 `AppState`（History/Settings ViewModel）
  - `ClipboardItemDTO.cachedTitle/cachedMetadata` 的 Presentation 收口（Domain vs UI 边界）
- Phase 6（收尾）：dead code 清理、日志统一（`os.Logger`）、Strict Concurrency/TSan 回归

