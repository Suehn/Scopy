# v0.41 - Dev/Quality：Makefile 固化 Strict Concurrency 回归门槛

**日期**: 2025-12-13

---

## 一页纸总结

### What

- **新增 `make test-strict`**：在 `Makefile` 增加 Strict Concurrency 回归命令，统一以 `SWIFT_STRICT_CONCURRENCY=complete` + `SWIFT_TREAT_WARNINGS_AS_ERRORS=YES` 跑 `ScopyTests`。
- **输出日志固化**：命令输出写入 `strict-concurrency-test.log`，便于 CI/本地排查并发隔离回归。

### Why

- v0.39 已验证 Strict Concurrency（tests target）可跑通，但缺少“默认可执行入口”会导致回归门槛难以长期维持。
- 将命令固化为 `Makefile` target，减少团队/未来自己“记错命令/漏跑”的概率。

### Result

- **行为零变化**：仅开发/质量流程增强，不影响运行时逻辑。
- **回归通过**：`make test-unit` / `make test-perf` / `make test-strict` 均通过（见下方数据）。

---

## 核心实现

- `Makefile`：
  - 新增 `test-strict` target：仅跑 `ScopyTests`，并开启 Strict Concurrency + warnings as errors
  - `help` 输出新增说明

---

## 修改文件列表（核心）

- `Makefile`
- `DEPLOYMENT.md`
- `doc/profile/v0.41-profile.md`
- `doc/profile/README.md`
- `doc/implemented-doc/v0.41.md`
- `doc/implemented-doc/README.md`
- `doc/implemented-doc/CHANGELOG.md`
- `doc/review/review-v0.3.md`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- 性能测试：`make test-perf` **22 tests passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)
- Thread Sanitizer：`make test-tsan` **132 tests passed** (1 skipped)
- Strict Concurrency：`make test-strict` **166 tests passed** (7 skipped)

### 性能（Debug / `make test-perf` 单次运行）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 4.70ms
  - Fuzzy 10k items P95 ≈ 43.64ms（Samples: 50）
  - Disk 25k fuzzy P95 ≈ 58.08ms（Samples: 50）
  - Bulk insert 1000 items ≈ 51.84ms（≈19,290 items/s）
  - Fetch recent (50 items) avg ≈ 0.07ms
  - Regex 20k items P95 ≈ 3.04ms
  - Mixed content disk search（single run, after warmup）≈ 4.18ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`
- ⏳ 热键自查：`/tmp/scopy_hotkey.log`（本版本不改热键；按 `AGENTS.md` 仍建议人工自查一次）

---

## 遗留与后续

- Phase 7（可选）：抽成 Swift Package（强制边界，减少 UI 误触底层实现的回归风险）。
