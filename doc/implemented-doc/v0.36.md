# v0.36 - Phase 6 收尾：日志统一 + AsyncStream buffering + 阈值集中

**日期**: 2025-12-13

---

## 一页纸总结

### What

- 新增 `ScopyLog`（基于 `os.Logger`）并将仓库内 `print(...)` 全量迁移到统一日志入口（保留热键文件日志 `/tmp/scopy_hotkey.log`）。
- 为关键 `AsyncStream` 显式指定 buffering policy：
  - `ClipboardMonitor.contentStream`：`.bufferingNewest(8)`（避免大 payload 无界堆积）
  - `ClipboardService.eventStream` / `MockClipboardService.eventStream`：`.unbounded`（避免事件丢失）
- 新增 `ScopyThresholds` 集中记录阈值（ingest/hash offload、external storage），避免分散硬编码。

### Why

- `print` 分散且不可控，难以按模块过滤与长期观测；统一到 `os.Logger` 提升稳定性诊断能力。
- `AsyncStream` 默认 buffering 语义不显式，遇到 burst 容易引入隐性内存/丢事件风险；显式化后行为可预测、可审计。
- 阈值分散在 monitor/storage 中，容易出现“改一处忘一处”；集中配置便于文档化与后续调参。

### Result

- 行为兼容（不改核心功能逻辑），但并发/背压/日志的“语义确定性”提升。
- 单测与性能测试通过，关键指标无回归（见下）。

---

## 核心实现

### 统一日志（除热键文件日志外）

- 新增 `Scopy/Utilities/ScopyLogger.swift`：按模块分类 `Logger`（app/monitor/storage/search/ui/hotkey）。
- 替换所有 `print(...)` 为 `ScopyLog.*`，便于后续统一过滤与线上排查。

### AsyncStream buffering policy

- `Scopy/Services/ClipboardMonitor.swift`：
  - `contentStream` 改为 `.bufferingNewest(8)`，避免大 payload（图片 Data）在消费者慢时无界增长。
- `Scopy/Application/ClipboardService.swift`、`Scopy/Services/MockClipboardService.swift`：
  - `eventStream` 改为 `.unbounded`，保证事件不丢（事件体量小）。

### 阈值集中

- 新增 `Scopy/Infrastructure/Configuration/ScopyThresholds.swift`：
  - `ingestHashOffloadBytes`
  - `externalStorageBytes`
- `ClipboardMonitor` 与 `StorageService` 统一从该文件读取阈值。

---

## 修改文件列表（核心）

- `Scopy/Utilities/ScopyLogger.swift`
- `Scopy/Infrastructure/Configuration/ScopyThresholds.swift`
- `Scopy/Services/ClipboardMonitor.swift`
- `Scopy/Application/ClipboardService.swift`
- `Scopy/Observables/AppState.swift`
- `Scopy/Services/StorageService.swift`
- `Scopy/Services/MockClipboardService.swift`
- `Scopy/Services/PerformanceProfiler.swift`
- `Scopy/Services/HotKeyService.swift`
- `Scopy/Views/SettingsView.swift`
- `Scopy.xcodeproj/project.pbxproj`（`xcodegen generate`）

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- AppState：`xcodebuild test -only-testing:ScopyTests/AppStateTests -only-testing:ScopyTests/AppStateFallbackTests` **46 tests passed**
- 性能测试：`make test-perf` **22 tests passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)

### 性能（Debug / `make test-perf`）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 5.23ms
  - Fuzzy 10k items P95 ≈ 44.80ms
  - Disk 25k fuzzy P95 ≈ 56.94ms
  - Bulk insert 1000 items ≈ 54.80ms（≈18,248 items/s）
  - Regex 20k items P95 ≈ 3.08ms

---

## 遗留与后续

- Phase 6 仍建议补做一次 Thread Sanitizer 回归（`ENABLE_THREAD_SANITIZER=YES`）与 Strict Concurrency 渐进开启（先从 tests target 开始）。
- Phase 7（可选）：抽出 Swift Package 强制边界（见 `doc/review/review-v0.3.md`）。

