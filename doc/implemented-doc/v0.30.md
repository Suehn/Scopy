# v0.30 - vNext 重构地基：Domain 拆分 + SettingsStore SSOT

**日期**: 2025-12-12

---

## 一页纸总结

### What

- 将 `ClipboardServiceProtocol` 相关 DTO/模型从单文件中拆分到 `Scopy/Domain/Models/*`，协议移动到 `Scopy/Domain/Protocols/ClipboardServiceProtocol.swift`。
- 新增 `Scopy/Infrastructure/Settings/SettingsStore.swift`（actor）作为 Settings 的唯一真相源（SSOT），统一读写 `UserDefaults["ScopySettings"]`，并让 `AppDelegate`/`RealClipboardService` 不再直接读写 UserDefaults。

### Why

- 为后续 vNext 重构（actor 化、SQLite 归属收口、事件语义纯化）先建立“物理边界”，减少改动半径与耦合。
- 当前设置/热键存在多点 `UserDefaults` 读写，容易产生覆盖与一致性问题；先收口为单一入口，降低回归风险。

### Result

- 现有行为保持不变（重构地基阶段不引入功能改动）。
- Settings/Hotkey 持久化逻辑集中到 `SettingsStore`，为后续订阅式热键更新与事件语义纯化铺路。

---

## 核心实现

### Domain 拆分

- `Scopy/Domain/Models/*`：
  - `SearchMode.swift`
  - `ClipboardItemType.swift`
  - `ClipboardItemDTO.swift`
  - `SearchRequest.swift`
  - `SearchResultPage.swift`
  - `ClipboardEvent.swift`
  - `SettingsDTO.swift`
  - `StorageStatsDTO.swift`
- `Scopy/Domain/Protocols/ClipboardServiceProtocol.swift`：仅保留 `ClipboardServiceProtocol` 声明

### SettingsStore SSOT

- `Scopy/Infrastructure/Settings/SettingsStore.swift`：
  - `load()/save()/updateHotkey()`
  - `observeSettings()`（为后续订阅式热键更新预留）
- `Scopy/AppDelegate.swift`：热键持久化改为调用 `SettingsStore.updateHotkey(...)`
- `Scopy/Services/RealClipboardService.swift`：`getSettings/updateSettings` 改为调用 `SettingsStore`

---

## 修改文件列表

- `Scopy/AppDelegate.swift`
- `Scopy/Services/RealClipboardService.swift`
- `Scopy/Domain/Models/*`
- `Scopy/Domain/Protocols/ClipboardServiceProtocol.swift`
- `Scopy/Infrastructure/Settings/SettingsStore.swift`
- `doc/implemented-doc/v0.30.md`
- `doc/implemented-doc/README.md`
- `doc/implemented-doc/CHANGELOG.md`

---

## 测试

- 单元测试: `make test-unit` **53 tests passed** (1 perf skipped)

---

## 遗留与后续

- 下一阶段按 `doc/review/review-v0.3.md` 的 Phase 2/3 推进：SQLite 连接归属收口（Repository actor + 禁止 OpaquePointer 外泄）与 Search actor 化。

