# v0.43.7 - Fix/UX：浏览器输入框粘贴空内容（RTF/HTML 缺少 plain text）

**日期**: 2025-12-14

---

## 一页纸总结

### What

- **修复 Chrome/Edge 输入框粘贴为空**：从 Scopy 历史点选回写剪贴板后，在浏览器输入框 `⌘V` 可能无内容，但在 Typora/微信等可正常粘贴。

### Why

- 浏览器输入框通常只读取剪贴板的 **plain text**（`NSPasteboard.PasteboardType.string`）。
- 之前对 `.rtf/.html` 类型回写剪贴板时只写入了 `public.rtf`/`public.html`，**没有同时提供 plain text**，导致浏览器侧拿不到可粘贴的文本。

### Result

- `.rtf/.html` 回写剪贴板时同时写入 `.string` + 原始格式数据，浏览器输入框可正常粘贴。
- 回归通过：
  - `make test-unit`：**57 passed**, 1 skipped（58 total）
  - `make test-perf`：**16 passed**, 6 skipped（22 total）
  - `make test-tsan`：**137 passed**, 1 skipped（138 total）
  - `make test-strict`：**165 passed**, 7 skipped（172 total）

---

## 实现路线

1. `ClipboardMonitor` 增加同时写入 `.string` + 指定 type 的接口（单个 pasteboard item 多表示）。
2. `ClipboardService.copyToClipboard`：当 item 为 `.rtf/.html` 时使用新接口写入 plain text fallback。
3. 增加单测：验证 `.rtf/.html` 回写后剪贴板同时包含 `.string` 与对应格式数据。

---

## 核心改动

- `Scopy/Services/ClipboardMonitor.swift`
- `Scopy/Application/ClipboardService.swift`
- `ScopyTests/ClipboardMonitorTests.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit`（57 passed, 1 skipped）
- 性能测试：`make test-perf`（16 passed, 6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`）
- Thread Sanitizer：`make test-tsan`（137 passed, 1 skipped）
- Strict Concurrency：`make test-strict`（165 passed, 7 skipped）

### 性能（Debug / `make test-perf` 单次运行）

- 环境：MacBook Air（Apple M3, 24 GB）/ macOS 15.7.2（24G325）/ arm64 / 2025-12-14
- 电源：Low Power Mode enabled（`pmset -g` 显示 `lowpowermode 1`）
- 关键结果：
  - Fuzzy 5k items P95 ≈ 8.30ms
  - Fuzzy 10k items P95 ≈ 76.67ms（Samples: 50；Low Power Mode 下测试阈值放宽至 300ms）
  - Disk 25k fuzzy P95 ≈ 103.41ms（Samples: 50；Low Power Mode enabled）
  - Bulk insert 1000 items ≈ 80.96ms（≈12,352 items/s；Low Power Mode enabled）
  - Fetch recent (50 items) avg ≈ 0.11ms
  - Regex 20k items P95 ≈ 5.23ms
  - Mixed content disk search（single run）≈ 7.66ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 若条目类型为图片/文件，部分网页输入框本身不支持粘贴该类型；此版本仅修复 `.rtf/.html` 缺少 plain text 导致的“粘贴空”。

