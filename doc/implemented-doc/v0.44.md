# v0.44

## 📌 一页纸总结（What / Why / Result）

### What

- Release：收敛 Markdown/LaTeX hover 预览链路（稳健性 + 动态尺寸），并打通“从 tag 构建 DMG + Homebrew 对齐”的发布自动化。

### Why

- `brew install --cask scopy` 发生 `SHA-256 mismatch` 时，通常是同一 tag 的发布产物（DMG）被覆盖/重建，导致 Homebrew 固定的 sha 与实际下载文件不一致。
- 预览链路（Markdown/LaTeX）在真实拷贝内容（论文段落、括号内上下标、代码片段等）下容易出现误判或渲染不稳定，需要回归测试兜底。

### Result

- Preview：渲染更鲁棒（code-skip、括号内上下标识别增强、动态高度上报修复、移除最小宽高钳制等）并补齐测试。
- Release：`main` 推送且更新实现文档后自动打 tag 并发布 DMG；同一 tag 已发布 DMG 时拒绝覆盖，避免再次触发 Homebrew sha 不一致。
- Homebrew：可选自动对 `Homebrew/homebrew-cask` 发起 bump PR，用户可直接 `brew install --cask scopy` 获取最新版本（PR 合并后生效）。

---

## 🏗️ 实现路线

1. 预览链路规则收敛与边界补齐（code segment 跳过、括号内公式识别、动态高度回传）。
2. 补齐回归测试，覆盖易错例子（包含 fenced/inline code、脚本提前闭合、括号内上下标等）。
3. 发布流程统一由 tag 驱动：从实现文档索引读取版本、校验版本文档/CHANGELOG 一致性后自动打 tag。
4. 发布 workflow 增加“拒绝覆盖既有 DMG”保护，并支持（可选）自动 bump `homebrew-cask`。

---

## 📂 核心改动

- `.github/workflows/auto-tag.yml`
- `.github/workflows/release.yml`
- `Scopy/Views/History/*`（hover 预览渲染与尺寸计算）
- `ScopyTests/*`（Markdown/KaTeX/预览尺寸回归测试）
- `doc/implemented-doc/README.md`
- `doc/implemented-doc/CHANGELOG.md`

---

## 🎯 关键指标

- 目标：同一版本（同一 tag）发布产物不可覆盖，避免 Homebrew `SHA-256 mismatch`。
- 测试：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests` Executed 213 tests, 7 skipped。

---

## 📊 当前状态

- 单元测试：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests` Executed 213 tests, 7 skipped

---

## 🔮 遗留与后续

- 需要在仓库 Secrets 中配置 `HOMEBREW_GITHUB_API_TOKEN`（PAT），才能自动对 `Homebrew/homebrew-cask` 发 PR 并让 `brew install --cask scopy` 跟进到最新版。
