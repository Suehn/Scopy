# v0.33 - vNext 重构：ClipboardService actor + 事件语义纯化

**日期**: 2025-12-13

---

## 一页纸总结

### What

- 新增 `Scopy/Application/ClipboardService.swift`（actor）：统一组合 monitor/storage/search/settings，并由 actor 持有事件 continuation。
- `RealClipboardService` 降级为 adapter：对外保持 `ClipboardServiceProtocol` 形态，内部转发到 `ClipboardService` actor（并删除事件流锁）。
- 事件语义纯化：
  - `ClipboardEvent` 新增 `itemsCleared(keepPinned:)`
  - `clearAll()` 不再复用 `.settingsChanged`，改为发 `itemsCleared(keepPinned: true)`
- UI 侧最小适配：`AppState.handleEvent` 支持 `.itemsCleared`（最小行为：`await load()`）。

### Why

- 解决 `RealClipboardService.eventStream` 依赖 `NSLock` 保护 continuation 的结构性问题：由 actor 串行保证 yield/finish 的一致性。
- 修复“事件语义不纯”的根因：`clearAll` 不应触发 settings 相关副作用（如热键 re-apply），让 `.settingsChanged` 回归“仅设置变更”。
- 为后续 Phase 5/6 收口（Presentation/缓存/Strict Concurrency）打基础：门面与事件语义先稳定。

### Result

- 机械约束达成：
  - `rg -n "eventStreamLock|isEventStreamFinished" Scopy` 结果为 0
  - `clearAll()` 不再触发 `.settingsChanged`
- `make test-unit` 通过（53 tests passed，1 skipped）
- `make test-perf` 通过（22 tests passed，6 skipped；heavy 场景需 `RUN_HEAVY_PERF_TESTS=1`）

---

## 核心实现

### ClipboardService actor（Application 层门面）

- `Scopy/Application/ClipboardService.swift`
  - 事件流：`nonisolated let eventStream`（actor 持有 continuation，串行 yield/finish）
  - 生命周期：`start()/stop()` 统一管理 monitor/storage/search 的打开与关闭
  - 事件语义：`clearAll()` → `.itemsCleared(keepPinned: true)`；`updateSettings()` → `.settingsChanged`
  - AppKit/SQLite 边界：内部通过 `MainActor.run {}` 与跨 MainActor 调用处理 `ClipboardMonitor/StorageService`（二者仍为 `@MainActor`）

### RealClipboardService（兼容层 adapter）

- `Scopy/Services/RealClipboardService.swift`
  - 仅做协议转发与装配（`ClipboardService(databasePath:settingsStore:)`）
  - 测试用：`ClipboardServiceFactory.createForTesting()` 改为 shared in-memory DB URI（避免 `:memory:` 多连接不共享导致的搜索不可见）

---

## 修改文件列表（核心）

- 新增：`Scopy/Application/ClipboardService.swift`
- 修改：`Scopy/Services/RealClipboardService.swift`
- 修改：`Scopy/Domain/Models/ClipboardEvent.swift`
- 修改：`Scopy/Observables/AppState.swift`
- 修改：`Scopy/Services/MockClipboardService.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- AppState 测试：`xcodebuild test -only-testing:ScopyTests/AppStateTests -only-testing:ScopyTests/AppStateFallbackTests` **46 tests passed**
- 性能测试：`make test-perf` **22 tests passed** (6 skipped)

### 性能（Debug / `make test-perf`）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 8.21ms
  - Fuzzy 10k items P95 ≈ 78.76ms
  - Disk 25k fuzzy P95 ≈ 107.50ms

---

## 遗留与后续

- Phase 5：Presentation 收口（缓存单一入口 + 巨型 View 拆分 + ViewModel 分拆）。
- Phase 6：dead code 清理 + 日志统一 + Strict Concurrency/TSan 回归。

