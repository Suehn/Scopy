# v0.59.fix3

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Perf/Searchï¼šçŸ­è¯ï¼ˆâ‰¤2 charsï¼‰å€™é€‰åˆ†é¡µä½¿ç”¨ topâ€‘K heapï¼ˆå– `offset+limit+1`ï¼‰ï¼Œé¿å… O(k log k) å…¨é‡æ’åºã€‚
- Perf/Searchï¼š`computeCorpusMetrics` ä»â€œæŒ‰æ—¶é—´å‘¨æœŸåˆ·æ–°â€æ”¹ä¸ºâ€œä»… stale/force åˆ·æ–°â€ï¼Œæ¶ˆé™¤å‘¨æœŸæ€§ O(n) èšåˆæŠ–åŠ¨ã€‚
- Infra/SQLiteï¼šDB user_version bump åˆ° `6`ï¼Œåœ¨ `scopy_meta` å¢é‡ç»´æŠ¤ `item_count/unpinned_count/total_size_bytes`ï¼ˆè§¦å‘å™¨ä¿æŒç²¾ç¡®ä¸€è‡´ï¼‰ï¼Œç»Ÿè®¡è¯»ä¾§ä» O(n) æ”¶æ•›åˆ° O(1)ï¼ˆæ—§åº“è‡ªåŠ¨ fallbackï¼‰ã€‚
- Infra/SQLiteï¼šæ–°å¢ `idx_recent_order` / `idx_app_last_used`ï¼Œé™ä½å¸¸è§æ’åº/åˆ†ç»„çš„å¸¸æ•°æˆæœ¬ï¼ˆè¯­ä¹‰ä¸å˜ï¼‰ã€‚
- Perf/UIï¼šhover Markdown æ¸²æŸ“ç§»å‡º MainActorï¼›æ»šåŠ¨æœŸé—´ç¼©ç•¥å›¾ decode é™ä¼˜å…ˆçº§ï¼Œé™ä½ UI å¡é¡¿æ¦‚ç‡ã€‚
- Tooling/Perfï¼šä¿®å¤ `scripts/perf-audit.sh` åœ¨ `set -u` ä¸‹ç©ºæ•°ç»„å±•å¼€å´©æºƒï¼ŒåŸºå‡†è¾“å‡ºæ›´ç¨³å®šã€‚

### Why

- n=å­˜å‚¨ items æ•°å¢å¤§åï¼ŒçŸ­è¯å€™é€‰é›† k ä¹Ÿä¼šéšä¹‹å¢å¤§ï¼šå…¨é‡æ’åº O(k log k) ä¼šæŠŠ P95/P99 æ‹‰é«˜ï¼Œä¸”æ·±åˆ†é¡µï¼ˆoffset>0ï¼‰æ›´æ˜æ˜¾ã€‚
- `COUNT/AVG/MAX` è¿™ç±»å…¨è¡¨èšåˆå±äº O(n)ï¼›å³ä½¿å¶å‘æ‰§è¡Œï¼Œä¹Ÿä¼šé€ æˆäº¤äº’æœç´¢çš„ P99 æŠ–åŠ¨ã€‚
- `COUNT(*)` / `SUM(size_bytes)` ä½œä¸ºé«˜é¢‘ç»Ÿè®¡è¯»å–ï¼ˆæ¸…ç†ã€è®¾ç½®ã€çŠ¶æ€å±•ç¤ºï¼‰åœ¨å¤§åº“ä¸‹ä¼šå˜æˆä¸å¯å¿½ç•¥çš„å›ºå®šæˆæœ¬ï¼›é€šè¿‡ç²¾ç¡®å¢é‡ç»´æŠ¤å¯æŠŠè¯»ä¾§é™ä¸º O(1)ã€‚
- hover é¢„è§ˆæ¸²æŸ“æ˜¯å…¸å‹ CPU workï¼Œè·‘åœ¨ä¸»çº¿ç¨‹ä¼šç›´æ¥åæ˜ ä¸ºæ»šåŠ¨/hover å¡é¡¿ã€‚

### Result

- æœ¬åœ°éªŒè¯ï¼ˆmacOS 26.3ï¼ˆ25D5112cï¼‰ï¼›Xcode 26.2ï¼ˆ17C52ï¼‰ï¼›2026-01-29ï¼‰ï¼š
  - `make build` âœ…
  - `make test-unit` âœ…ï¼ˆExecuted 272 tests, 1 skipped, 0 failuresï¼‰
  - `make test-strict` âœ…ï¼ˆExecuted 272 tests, 1 skipped, 0 failuresï¼‰
  - `make test-tsan` âœ…ï¼ˆExecuted 262 tests, 1 skipped, 0 failuresï¼‰
  - `make test-perf` âœ…ï¼ˆExecuted 25 tests, 7 skipped, 0 failuresï¼‰
- æ€§èƒ½æ‘˜è¦ï¼ˆå¿«ç…§åº“ `perf-db/clipboard.db`ï¼Œ6421 items / 148.6MBï¼›release `ScopyBench`ï¼Œwarmup 20 / iters 30ï¼›`logs/perf-audit-2026-01-29_03-22-58/`ï¼‰ï¼š
  - engineï¼š`cm`ï¼ˆfuzzyPlus/relevanceï¼‰P95 5.58msï¼›`æ•°å­¦` P95 9.15msï¼›`cmd` P95 0.14ms
  - serviceï¼š`cm`ï¼ˆfuzzyPlus/relevanceï¼‰P95 5.62msï¼›`æ•°å­¦` P95 9.47msï¼›`cmd` P95 0.12ms

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. Searchï¼šçŸ­è¯å€™é€‰åˆ†é¡µæ”¹ä¸º topâ€‘K heap ä¿åºé€‰å–ï¼ˆä»…æ’åº K é¡¹ï¼‰ï¼Œå¹¶è¡¥å›å½’æµ‹è¯•è¦†ç›– offset æ·±åˆ†é¡µã€‚
2. Searchï¼šcorpus metrics åˆ·æ–°æ”¹ä¸ºâ€œä»…åœ¨ stale/forceâ€æ—¶æ‰§è¡Œï¼Œé¿å…æ— å˜æ›´æ—¶çš„å‘¨æœŸæ€§å…¨è¡¨èšåˆã€‚
3. SQLiteï¼šæ–°å¢ meta countersï¼ˆuser_version=6ï¼‰å¹¶ç”¨ trigger ç²¾ç¡®ç»´æŠ¤ï¼›è¯»ä¾§ä¼˜å…ˆèµ° metaï¼Œæ—§åº“è‡ªåŠ¨ fallbackã€‚
4. SQLiteï¼šè¡¥å……å¸¸ç”¨æ’åº/åˆ†ç»„ç´¢å¼•ï¼Œé™ä½æ·±åˆ†é¡µä¸ recent apps è¿‡æ»¤çš„å¸¸æ•°æˆæœ¬ã€‚
5. UIï¼šhover é¢„è§ˆæ¸²æŸ“ä¸ç¼©ç•¥å›¾è§£ç çš„çº¿ç¨‹/ä¼˜å…ˆçº§è°ƒæ•´ï¼Œå‡å°‘ä¸»çº¿ç¨‹äº‰ç”¨ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
- `Scopy/Infrastructure/Persistence/SQLiteMigrations.swift`
- `Scopy/Infrastructure/Persistence/SQLiteClipboardRepository.swift`
- `Scopy/Views/History/HistoryItemView.swift`
- `Scopy/Views/History/HistoryItemThumbnailView.swift`
- `ScopyTests/SearchServiceTests.swift`
- `scripts/perf-audit.sh`
- `doc/implementation/CHANGELOG.md`
- `doc/implementation/README.md`

---

## ğŸ¯ å…³é”®æŒ‡æ ‡

- `make test-perf`ï¼ˆ2026-01-29ï¼‰ï¼š
  - 5kï¼ˆfuzzyPlusï¼‰ï¼šP95 4.81msï¼›cold 82.11ms
  - 10kï¼ˆfuzzyPlusï¼‰ï¼šP95 25.15msï¼›cold 191.60ms
  - Disk 25kï¼ˆfuzzyPlusï¼‰ï¼šP95 52.74msï¼›cold 795.69ms
  - Service Disk 10kï¼ˆfuzzyPlusï¼‰ï¼šP95 22.06msï¼›cold 287.59ms

---

## ğŸ“Š å½“å‰çŠ¶æ€

- æ„å»ºï¼š`make build` âœ…ï¼ˆ2026-01-29ï¼‰
- å•æµ‹ï¼š`make test-unit` âœ…ï¼ˆExecuted 272 tests, 1 skipped, 0 failuresï¼Œ2026-01-29ï¼‰
- Strict Concurrencyï¼š`make test-strict` âœ…ï¼ˆExecuted 272 tests, 1 skipped, 0 failuresï¼Œ2026-01-29ï¼‰
- TSanï¼š`make test-tsan` âœ…ï¼ˆExecuted 262 tests, 1 skipped, 0 failuresï¼Œ2026-01-29ï¼‰
- Perfï¼š`make test-perf` âœ…ï¼ˆExecuted 25 tests, 7 skipped, 0 failuresï¼Œ2026-01-29ï¼‰

