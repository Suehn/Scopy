# v0.44.fix24

> 状态：✅

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Search：清空搜索也统一 bump 版本并取消 in-flight paging，避免旧任务污染新列表；同时移除 Clear/Esc 的重复触发（只保留 `TextField.onChange` 为单一触发源）。
- Fix/Index：full fuzzy index 增加 tombstone 健康度阈值（阈值触发 stale → 下次 fuzzy 自动重建），避免长期运行的 postings 漂移导致性能随时间退化。
- Fix/Storage：批量文件删除统一改为 bounded concurrency（默认并发度 8），并把 Clear All 的文件删除移出主线程，避免极端情况下 UI 卡顿与 I/O 调度风暴。
- Fix/Lifecycle：`ClipboardService.start()` 原子化（要么成功，要么失败无副作用可重试）。

### Why

- 内存索引若删除只留下 tombstone 且 postings 不收敛，长期运行会出现“候选集合越来越脏 → 查询扫描量越来越大”的性能漂移（P2-2）。
- 批量文件删除若无并发上限/在主线程同步 I/O，会导致调度风暴或 UI 卡顿（P2-7 / P2-10）。
- 启动过程半初始化会让后续 `start()` 被短路，稳定性与可恢复性变差（P2-5）。
- 搜索/分页并发状态机若不版本化/取消，会出现旧任务落地污染新状态（P2-9）。

### Result

- 长期运行：full fuzzy index 在删除积累后可自愈重建，降低长期漂移风险。
- Clear All / cleanup：批量文件删除更可控（有并发上限且不阻塞主线程）。
- 服务启动：失败可重试，不会遗留“半启动”状态。
- 搜索列表：清空/切换时不再出现旧分页结果混入、重复触发导致的额外 I/O。

---

## 🏗️ 实现路线

1. `SearchEngineImpl`：为 full index 增加 `tombstoneCount`，删除时累计；超过阈值标记 stale，下一次 fuzzy 自动重建。
2. `StorageService`：引入 `forEachConcurrent` + `deleteFilesBounded`，把各清理路径与 Clear All 统一到 bounded concurrency，并将 Clear All 删除移到 `Task.detached`。
3. `ClipboardService.start()`：改为局部构建，open 全部成功后一次性提交；失败 best-effort cleanup。
4. `HistoryViewModel`/UI：清空搜索也版本化 + cancel；移除 Clear/Esc 的重复 `search()` 调用。
5. 补齐回归测试覆盖上述行为。

---

## 📂 核心改动

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
  - full fuzzy index 增加 tombstone 统计与阈值 stale；新增 debug health（仅 DEBUG）用于测试验证。
- `Scopy/Services/StorageService.swift`
  - 批量文件删除收敛为 bounded concurrency（含 cleanup 与 clearAll）。
- `Scopy/Application/ClipboardService.swift`
  - `start()` 原子化与失败清理，保证可重试。
- `Scopy/Observables/HistoryViewModel.swift`
  - 清空搜索也 bump version + cancel in-flight paging。
- `Scopy/Views/HeaderView.swift` / `Scopy/Views/ContentView.swift`
  - Clear/Esc 不再重复触发 `search()`，避免双触发导致的重复 I/O。
- `ScopyTests/ReviewFix24Tests.swift`
  - 索引 stale→重建、Clear All 非阻塞与 bounded concurrency、start 可重试等回归测试。
- `ScopyTests/SearchStateMachineTests.swift`
  - in-flight loadMore 时清空搜索不再污染列表的回归测试。

---

## 🎯 关键指标

- 单元测试：`make test-unit`：Executed 215 tests, 1 skipped, 0 failures

---

## 🔮 遗留与后续

- P2-2 的“超长文本参与 full fuzzy 的工程化兜底（只索引前 N / 改走 FTS）”尚未落地；本次修复聚焦于 tombstone/postings 的长期漂移问题，避免引入潜在的搜索语义变化。

