# v0.5 Test Framework - Quick Walkthrough

> å¿«é€Ÿä¸Šæ‰‹æŒ‡å— - å¸®åŠ©æ–°å¯åŠ¨çš„å¯¹è¯å¿«é€Ÿç†è§£å½“å‰æµ‹è¯•æ¡†æ¶

---

## ğŸš€ 5 åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹

### 1. è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
xcodegen generate
xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests
```

### 2. æŸ¥çœ‹æµ‹è¯•ç»“æœ
```
Total: 69 tests
â”œâ”€â”€ Unit Tests: 48/48 âœ…
â””â”€â”€ UI Tests: 21/21 âœ…
```

### 3. å…³é”®ç›®å½•ç»“æ„
```
ScopyTests/
â”œâ”€â”€ AppStateTests.swift          # 31 ä¸ªåº”ç”¨çŠ¶æ€æµ‹è¯•
â”œâ”€â”€ PerformanceTests.swift       # 13 ä¸ªæ€§èƒ½æµ‹è¯•
â”œâ”€â”€ SearchServiceTests.swift
â”œâ”€â”€ StorageServiceTests.swift
â”œâ”€â”€ IntegrationTests.swift
â””â”€â”€ Helpers/                     # æµ‹è¯•åŸºç¡€è®¾æ–½
    â”œâ”€â”€ TestDataFactory.swift     # æ•°æ®ç”Ÿæˆå·¥å‚
    â”œâ”€â”€ MockServices.swift        # Mock æœåŠ¡
    â”œâ”€â”€ PerformanceHelpers.swift  # æ€§èƒ½æµ‹é‡å·¥å…·
    â””â”€â”€ XCTestExtensions.swift    # å¼‚æ­¥æµ‹è¯•æ‰©å±•

ScopyUITests/                    # UI æµ‹è¯• (ç‹¬ç«‹ bundle)
â”œâ”€â”€ MainWindowUITests.swift
â”œâ”€â”€ HistoryListUITests.swift
â”œâ”€â”€ KeyboardNavigationUITests.swift
â”œâ”€â”€ SettingsUITests.swift
â””â”€â”€ ContextMenuUITests.swift
```

---

## ğŸ“– å…³é”®æ–‡ä»¶è¯´æ˜

### TestDataFactory.swift - æ•°æ®ç”Ÿæˆ

**å¿«é€Ÿåˆ›å»ºæµ‹è¯•æ•°æ®**:
```swift
// åˆ›å»º 100 ä¸ªæµ‹è¯•é¡¹ç›®
let items = TestDataFactory.makeItems(count: 100)

// åˆ›å»ºæ··åˆæ•°æ® (å¤šä¸ªåº”ç”¨)
let mixed = TestDataFactory.makeMixedItems(count: 50)

// åˆ›å»ºç‰¹å®šæœç´¢è¯·æ±‚
let req = TestDataFactory.makeSearchRequest("query", mode: .fuzzy)
```

### MockServices.swift - Mock å®ç°

**é…ç½® Mock æœåŠ¡**:
```swift
let mock = ReusableMockClipboardService()
mock.setItemCount(100)  // å¿«é€Ÿè®¾ç½®æ•°æ®
mock.searchDelay = 0.1  // æ¨¡æ‹Ÿå»¶è¿Ÿ
mock.resetCallCounts()  // é‡ç½®è°ƒç”¨è®¡æ•°

// éªŒè¯è°ƒç”¨
XCTAssertEqual(mock.searchCallCount, 1)
XCTAssertEqual(mock.lastSearchQuery, "test")
```

### PerformanceHelpers.swift - æ€§èƒ½æµ‹é‡

**å¿«é€Ÿæµ‹é‡æ€§èƒ½**:
```swift
let stats = PerformanceHelpers.calculateStats(samples)
print(stats.report(title: "æœç´¢æ€§èƒ½"))

// éªŒè¯ SLO
SLOVerification.verifySearchLatency(
    stats: stats,
    target: .small  // â‰¤5k items, P95 â‰¤ 50ms
)
```

### XCTestExtensions.swift - å¼‚æ­¥å·¥å…·

**å¼‚æ­¥æµ‹è¯•**:
```swift
// ç­‰å¾…æ¡ä»¶æ»¡è¶³
await waitForCondition(timeout: 5) { condition }

// æ–­è¨€åœ¨æ—¶é—´å†…å®Œæˆ
try await assertCompletesWithin(1.0) {
    try await operation()
}
```

---

## ğŸ¯ å¸¸è§æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: æµ‹è¯•æœç´¢é˜²æŠ–
```swift
@MainActor
func testSearchDebounce() async throws {
    let mock = TestMockClipboardService()
    mock.setItemCount(100)

    // æ¨¡æ‹Ÿå¿«é€Ÿè¾“å…¥
    appState.searchQuery = "h"
    appState.search()
    appState.searchQuery = "he"
    appState.search()

    // åº”è¯¥é˜²æŠ–ï¼ˆåœ¨ 150ms åæ‰§è¡Œï¼‰
    try await Task.sleep(nanoseconds: 100_000_000)
    XCTAssertEqual(mock.searchCallCount, 0)

    try await Task.sleep(nanoseconds: 100_000_000)
    XCTAssertEqual(mock.searchCallCount, 1)
}
```

### åœºæ™¯ 2: æµ‹è¯•æ€§èƒ½è¾¾æˆ SLO
```swift
func testSearchPerformance() async throws {
    // åˆ›å»º 5000 ä¸ªé¡¹ç›®
    for i in 0..<5000 {
        _ = try storage.upsertItem(makeContent("Item \(i)"))
    }

    var times: [Double] = []
    for query in ["Hello", "test", "random"] {
        let start = CFAbsoluteTimeGetCurrent()
        _ = try await search.search(query: query, ...)
        times.append((CFAbsoluteTimeGetCurrent() - start) * 1000)
    }

    // è®¡ç®— P95
    times.sort()
    let p95 = times[Int(Double(times.count) * 0.95)]

    // v0.md ç›®æ ‡: â‰¤5k items, P95 â‰¤ 50ms
    XCTAssertLessThan(p95, 50)
}
```

### åœºæ™¯ 3: UI æµ‹è¯•
```swift
func testMainWindowLayout() throws {
    let app = XCUIApplication()
    app.launchArguments = ["--uitesting"]
    app.launch()

    // éªŒè¯æœç´¢å­—æ®µå­˜åœ¨
    let searchField = app.searchFields.firstMatch
    XCTAssertTrue(searchField.waitForExistence(timeout: 5))

    // éªŒè¯åˆ—è¡¨å­˜åœ¨
    let list = app.scrollViews.firstMatch
    XCTAssertTrue(list.exists)
}
```

---

## ğŸ”§ ä¿®æ”¹å’Œæ‰©å±•

### æ·»åŠ æ–°çš„å•å…ƒæµ‹è¯•

1. **åœ¨ AppStateTests ä¸­æ·»åŠ **:
```swift
func testMyNewFeature() async {
    mockService.setItemCount(50)
    await appState.load()

    // æµ‹è¯•é€»è¾‘
    // ...

    XCTAssertEqual(...)
}
```

2. **ä½¿ç”¨ Mock éªŒè¯è°ƒç”¨**:
```swift
XCTAssertEqual(mockService.copyCallCount, 1)
XCTAssertEqual(mockService.lastCopiedItemID, itemId)
```

### æ·»åŠ æ–°çš„ UI æµ‹è¯•

1. **åˆ›å»ºæ–°æ–‡ä»¶**: `ScopyUITests/MyFeatureUITests.swift`
2. **ä½¿ç”¨æ ‡å‡†æ¨¡æ¿**:
```swift
import XCTest

final class MyFeatureUITests: XCTestCase {
    var app: XCUIApplication!

    override func setUpWithError() throws {
        continueAfterFailure = false
        app = XCUIApplication()
        app.launchArguments = ["--uitesting"]
        app.launch()
    }

    func testMyFeature() throws {
        // æµ‹è¯•å®ç°
    }
}
```

### æ·»åŠ æ–°çš„æ€§èƒ½æµ‹è¯•

ä½¿ç”¨ `PerformanceHelpers`:
```swift
func testMyOperationPerformance() async throws {
    let stats = await runPerformanceTest(iterations: 20) {
        try await operation()
    }

    // éªŒè¯æ€§èƒ½
    XCTAssertLessThan(stats.p95, 50)
}
```

---

## ğŸ“Š v0.md SLO å¯¹é½

### å½“å‰æµ‹è¯•è¦†ç›–çš„ SLO

| æŒ‡æ ‡ | ç›®æ ‡ | éªŒè¯æ–¹å¼ |
|------|------|--------|
| é¦–å±åŠ è½½ | P95 < 100ms | `testFirstScreenLoadPerformance` |
| æœç´¢ (â‰¤5k) | P95 < 50ms | `testSearchPerformance5kItems` |
| æœç´¢ (10k) | P95 < 150ms | `testSearchPerformance10kItems` |
| æœç´¢é˜²æŠ– | 150-200ms | `testSearchDebounceEffect` |
| å†…å­˜ç¨³å®šæ€§ | < 50MB (500 ops) | `testMemoryStability` |

### è¿è¡Œ SLO éªŒè¯
```swift
let stats = PerformanceHelpers.calculateStats(times)
SLOVerification.verifySearchLatency(stats: stats, target: .small)
```

---

## ğŸ› å¸¸è§é—®é¢˜ä¸è°ƒè¯•

### é—®é¢˜ 1: "testEventStream" æµ‹è¯•è¾ƒå¼±
**åŸå› **: å¼‚æ­¥äº‹ä»¶æµåœ¨æµ‹è¯•ç¯å¢ƒä¸­ä¸ç¨³å®š

**è§£å†³**: ç›´æ¥æµ‹è¯•äº‹ä»¶å¤„ç†é€»è¾‘è€Œé stream
```swift
// âœ… æ¨è
appState.items.insert(newItem, at: 0)
XCTAssertEqual(appState.items.first?.id, newItem.id)

// âŒ é¿å…
try await taskForStream.value  // ä¸ç¨³å®š
```

### é—®é¢˜ 2: UI æµ‹è¯•æ‰¾ä¸åˆ°å…ƒç´ 
**åŸå› **: å…ƒç´ åŠ è½½å»¶è¿Ÿ

**è§£å†³**: ä½¿ç”¨ waitForExistence
```swift
let element = app.scrollViews.firstMatch
XCTAssertTrue(element.waitForExistence(timeout: 5))
```

### é—®é¢˜ 3: æ€§èƒ½æµ‹è¯•æ³¢åŠ¨å¤§
**åŸå› **: ç³»ç»Ÿè´Ÿè½½ã€ç¼“å­˜å½±å“

**è§£å†³**: ä½¿ç”¨ P95 è€Œéå¹³å‡å€¼ï¼Œå¤šæ¬¡é‡‡æ ·
```swift
let samples = try await PerformanceHelpers.collectTimeSamplesAsync(
    iterations: 20,
    warmupIterations: 2
) { try await operation() }
```

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥å¼€å‘

### v0.6 å‰ç«¯ UI å®ç°
- æ‰©å±• UI æµ‹è¯•è¦†ç›–å¤æ‚äº¤äº’
- æ·»åŠ æ‹–æ‹½ã€å¤šçª—å£ç­‰é«˜çº§åŠŸèƒ½æµ‹è¯•
- é›†æˆæ€§èƒ½æµ‹è¯•åˆ° CI

### v0.7 é›†æˆæµ‹è¯•
- å®Œæ•´çš„æ•°æ®æµæµ‹è¯• (Monitor â†’ Storage â†’ Search â†’ UI)
- ç«¯åˆ°ç«¯åœºæ™¯æµ‹è¯•
- æ€§èƒ½å›å½’æ£€æµ‹

### v0.8 ç”Ÿäº§å°±ç»ª
- 100% è¦†ç›–ç‡ç›®æ ‡
- è‡ªåŠ¨åŒ–æ€§èƒ½åŸºå‡†çº¿
- å®Œæ•´çš„ CI/CD é›†æˆ

---

## ğŸ“š é‡è¦é“¾æ¥

- **å®Œæ•´æ–‡æ¡£**: `doc/implementation/releases/v0.5.md`
- **è®¾è®¡è§„èŒƒ**: `doc/specs/v0.md`
- **åè®®å®šä¹‰**: `Scopy/Protocols/ClipboardServiceProtocol.swift`

---

## â±ï¸ å…³é”®æ—¶é—´çº¿

```
2025-11-27
â”œâ”€â”€ Phase 1: SearchService ä¿®å¤ âœ…
â”œâ”€â”€ Phase 2: AppState æµ‹è¯• âœ…
â”œâ”€â”€ Phase 3: UI æµ‹è¯•æ¡†æ¶ âœ…
â”œâ”€â”€ Phase 4: æ€§èƒ½æµ‹è¯•æ‰©å±• âœ…
â””â”€â”€ Phase 5: æµ‹è¯•åŸºç¡€è®¾æ–½ âœ…

ä¸‹ä¸€æ­¥: v0.6 å‰ç«¯ UI å®ç°
```

---

**ç‰ˆæœ¬**: v0.5 Walkthrough
**æœ€åæ›´æ–°**: 2025-11-27
**çŠ¶æ€**: âœ… å®Œæˆ
