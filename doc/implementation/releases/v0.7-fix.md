# v0.7-fix å®ç°æ–‡æ¡£ - Bug ä¿®å¤ä¸ UI æ”¹è¿›

**æ—¥æœŸ**: 2025-11-27
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**åŸºäºç‰ˆæœ¬**: v0.7

---

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“

### What
ä¿®å¤ v0.7 é—ç•™çš„ 6 ä¸ªé—®é¢˜ï¼šå¿«æ·é”®ä¸ç”Ÿæ•ˆã€æ–‡ä»¶å¤åˆ¶å¤±è´¥ã€æ€§èƒ½æŒ‡æ ‡æ˜¾ç¤ºä¸å®Œæ•´ã€æ–‡ä»¶æ˜¾ç¤ºè·¯å¾„è€Œéæ–‡ä»¶åã€Storage ç»Ÿè®¡ä¸å‡†ç¡®ã€‚

### Why
- ç”¨æˆ·åé¦ˆå¿«æ·é”®è®¾ç½®åæ— æ³•çœŸæ­£æ”¹å˜å”¤èµ·å¿«æ·é”®
- æ–‡ä»¶å¤åˆ¶åç²˜è´´åªå¾—åˆ°æ–‡ä»¶åï¼Œè€ŒéçœŸå®æ–‡ä»¶
- æ€§èƒ½æŒ‡æ ‡ç¼ºå°‘æ ·æœ¬æ•°å’Œå¹³å‡å€¼æ˜¾ç¤º
- æ–‡ä»¶ç±»å‹æ¡ç›®æ˜¾ç¤ºå®Œæ•´è·¯å¾„ï¼ˆå¦‚ /usr/bin/convertï¼‰è€Œéæ–‡ä»¶å

### Result
- âœ… å¿«æ·é”®è®¾ç½®åç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
- âœ… æ–‡ä»¶å¤åˆ¶åå¯åœ¨ Finder æ­£ç¡®ç²˜è´´
- âœ… æ€§èƒ½æŒ‡æ ‡æ˜¾ç¤º P95 + å¹³å‡å€¼ + æ ·æœ¬æ•°
- âœ… æ–‡ä»¶ç±»å‹æ˜¾ç¤ºæ–‡ä»¶å + å›¾æ ‡
- âœ… Storage ç»Ÿè®¡åŒ…å« WAL æ–‡ä»¶

---

## ğŸ—ï¸ å®ç°è·¯çº¿

### Fix 1: å¿«æ·é”®å®é™…ç”Ÿæ•ˆ âœ…
1. `AppDelegate` æ·»åŠ  `static var shared` å•ä¾‹è®¿é—®
2. `hotKeyService` æ”¹ä¸º `private(set)` å¯è®¿é—®
3. `togglePanel()` æ”¹ä¸ºé private
4. `SettingsDTO` æ·»åŠ  `hotkeyKeyCode` å’Œ `hotkeyModifiers` å­—æ®µ
5. `RealClipboardService` æŒä¹…åŒ–å¿«æ·é”®è®¾ç½®
6. `SettingsView.saveSettings()` ç«‹å³æ›´æ–° HotKeyService
7. `AppDelegate` å¯åŠ¨æ—¶ä»è®¾ç½®åŠ è½½å¿«æ·é”®

### Fix 2: å¤šä¿®é¥°é”®æ•è· âœ…
1. `HotKeyRecorderView.startRecording()` åŒæ—¶ç›‘å¬ `keyDown` å’Œ `flagsChanged`
2. ç¡®ä¿ â‡§âŒ˜C ç­‰å¤šä¿®é¥°é”®ç»„åˆèƒ½è¢«æ­£ç¡®å½•åˆ¶

### Fix 3: æ–‡ä»¶å¤åˆ¶ä¿®å¤ âœ…
1. `serializeFileURLs` æ”¹ç”¨ `url.path` è€Œé `url.absoluteString`
2. `deserializeFileURLs` æ”¹ç”¨ `URL(fileURLWithPath:)` è€Œé `URL(string:)`

### Fix 4: æ€§èƒ½æŒ‡æ ‡ UI æ”¹è¿› âœ…
1. æ˜¾ç¤ºæ ¼å¼æ”¹ä¸º `"X.X ms P95 / X.X ms avg (N samples)"`
2. æ·»åŠ  `formatMs()` è¾…åŠ©å‡½æ•°
3. ä½¿ç”¨å›ºå®šå®½åº¦å¯¹é½æ ‡ç­¾

### Fix 5: æ–‡ä»¶æ˜¾ç¤ºä¼˜åŒ– âœ…
1. `ClipboardItemDTO.title` å¯¹ `.file` ç±»å‹æå–æ–‡ä»¶å
2. `HistoryItemView` å¯¹æ–‡ä»¶ç±»å‹æ˜¾ç¤º `doc.fill` å›¾æ ‡
3. å›¾ç‰‡ç±»å‹æ˜¾ç¤º `photo` å›¾æ ‡

### Fix 6: Storage ç»Ÿè®¡ä¿®å¤ âœ…
1. `getDatabaseFileSize()` åŒ…å« `.db-wal` å’Œ `.db-shm` æ–‡ä»¶

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

### ä¿®æ”¹æ–‡ä»¶
| æ–‡ä»¶ | æ”¹åŠ¨è¯´æ˜ |
|------|----------|
| `AppDelegate.swift` | æ·»åŠ  shared å•ä¾‹ã€æš´éœ² hotKeyServiceã€loadHotkeySettings() |
| `Protocols/ClipboardServiceProtocol.swift` | SettingsDTO æ·»åŠ å¿«æ·é”®å­—æ®µã€ClipboardItemDTO.title ä¼˜åŒ– |
| `Services/ClipboardMonitor.swift` | ä¿®å¤æ–‡ä»¶ URL åºåˆ—åŒ–/ååºåˆ—åŒ– |
| `Services/RealClipboardService.swift` | ä¿å­˜/åŠ è½½å¿«æ·é”®è®¾ç½® |
| `Services/StorageService.swift` | getDatabaseFileSize åŒ…å« WAL æ–‡ä»¶ |
| `Views/SettingsView.swift` | å¿«æ·é”®ä¿å­˜+ç«‹å³ç”Ÿæ•ˆã€æ€§èƒ½æŒ‡æ ‡ UI æ”¹è¿› |
| `Views/HistoryListView.swift` | æ–‡ä»¶/å›¾ç‰‡ç±»å‹æ˜¾ç¤ºä¸“ç”¨å›¾æ ‡ |

---

## ğŸ¯ å…³é”®æŒ‡æ ‡

### åŠŸèƒ½éªŒè¯
| åŠŸèƒ½ | éªŒè¯æ–¹æ³• | çŠ¶æ€ |
|------|----------|------|
| å¿«æ·é”®ç«‹å³ç”Ÿæ•ˆ | è®¾ç½®æ–°å¿«æ·é”®åç«‹å³æµ‹è¯• | âœ… |
| å¤šä¿®é¥°é”®å½•åˆ¶ | å½•åˆ¶ â‡§âŒ˜C ç»„åˆ | âœ… |
| æ–‡ä»¶å¤åˆ¶ | å¤åˆ¶æ–‡ä»¶ååœ¨ Finder ç²˜è´´ | âœ… |
| æ€§èƒ½æŒ‡æ ‡æ˜¾ç¤º | æŸ¥çœ‹ About é¡µé¢ | âœ… |
| æ–‡ä»¶åæ˜¾ç¤º | å¤åˆ¶æ–‡ä»¶æŸ¥çœ‹åˆ—è¡¨ | âœ… |
| Storage ç»Ÿè®¡ | æŸ¥çœ‹ Storage é¡µé¢ | âœ… |

---

## ğŸ“Š å½“å‰çŠ¶æ€

```
å¿«é€Ÿæ£€æŸ¥:
  âœ… å¿«æ·é”®è®¾ç½®ç«‹å³ç”Ÿæ•ˆ
  âœ… å¤šä¿®é¥°é”®ç»„åˆå¯å½•åˆ¶
  âœ… æ–‡ä»¶å¤åˆ¶æ”¯æŒ Finder ç²˜è´´
  âœ… æ€§èƒ½æŒ‡æ ‡: P95 / avg (N samples)
  âœ… æ–‡ä»¶ç±»å‹æ˜¾ç¤ºæ–‡ä»¶å + å›¾æ ‡
  âœ… Storage ç»Ÿè®¡åŒ…å« WAL æ–‡ä»¶
```

---

## ğŸ”® é—ç•™ä¸åç»­

### v0.7-fix é—ç•™
- æ— 

### ä¸‹ä¸€æ­¥å»ºè®®
1. **v0.8**: æ‰¹é‡æ“ä½œã€åº”ç”¨è¿‡æ»¤
2. **v0.9**: iCloud åŒæ­¥
3. **v1.0**: ç¨³å®šç‰ˆå‘å¸ƒ

---

## ğŸ“ æŠ€æœ¯ç¬”è®°

### 1. æ–‡ä»¶ URL åºåˆ—åŒ–é—®é¢˜
```swift
// âŒ é”™è¯¯: absoluteString äº§ç”Ÿ file:///path æ ¼å¼
let paths = urls.map { $0.absoluteString }
// URL(string:) å¯èƒ½æ— æ³•æ­£ç¡®è§£æ

// âœ… æ­£ç¡®: ä½¿ç”¨ path å’Œ fileURLWithPath
let paths = urls.map { $0.path }
return paths.map { URL(fileURLWithPath: $0) }
```

### 2. å¿«æ·é”®ç«‹å³ç”Ÿæ•ˆ
```swift
// SettingsView.saveSettings()
if let keyCode = recordedKeyCode, let modifiers = recordedModifiers {
    AppDelegate.shared?.hotKeyService?.updateHotKey(
        keyCode: keyCode,
        modifiers: modifiers,
        handler: { AppDelegate.shared?.togglePanel() }
    )
}
```

### 3. SQLite WAL æ–‡ä»¶
```swift
// WAL æ¨¡å¼ä¸‹éœ€è¦è®¡ç®—æ‰€æœ‰ç›¸å…³æ–‡ä»¶
for ext in ["", "-wal", "-shm"] {
    let path = dbPath + ext
    // ç´¯åŠ æ–‡ä»¶å¤§å°
}
```

---

**å®Œæˆæ—¶é—´**: 2025-11-27
**ç»´æŠ¤è€…**: Claude Code
