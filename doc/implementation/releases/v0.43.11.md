# v0.43.11 â€” Fix/Perfï¼šHover é¢„è§ˆé¦–å¸§ç¨³å®š + æµè§ˆå™¨ç²˜è´´å…œåº•ï¼ˆHTML é UTF-8ï¼‰

**æ—¥æœŸ**ï¼š2025-12-14

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

- **What**ï¼š
  - ä¿®å¤ hover é¢„è§ˆé¦–å¸§ä½“éªŒï¼šå›¾ç‰‡/æ–‡æœ¬ popover é¦–æ¬¡å±•ç¤ºå³ç¨³å®šå°ºå¯¸ï¼Œä¸å†å‡ºç°â€œå…ˆæ˜¯å°ç¼©ç•¥å›¾/éœ€é‡æ‚¬åœæ‰æ­£å¸¸â€çš„ä½“æ„Ÿã€‚
  - ä¿®å¤æµè§ˆå™¨è¾“å…¥æ¡†ç²˜è´´ç©ºå†…å®¹ï¼ˆæ—§æ•°æ®/é UTF-8 HTMLï¼‰ï¼šç¡®ä¿å›å†™å‰ªè´´æ¿çš„ plain text ä¸ä¸ºç©ºã€‚
  - ç¼©ç•¥å›¾ä¸é¢„è§ˆé“¾è·¯æé€Ÿï¼šImageIO ä¸‹é‡‡æ ·ã€æ–‡ä»¶è·¯å¾„ç›´è¯»ã€ThumbnailCache è§£ç ç§»å‡ºä¸»çº¿ç¨‹ã€‚
  - æµ‹è¯•æ›´å¿«æ›´ç¨³ï¼šUI æœç´¢ debounce/refine ç­‰æ—¶åºå‚æ•°å¯é…ç½®ï¼Œæµ‹è¯•ç”¨ä¾‹é¿å…é•¿ `sleep`ã€‚
- **Why**ï¼š
  - SwiftUI popover åˆæ¬¡ä»¥å°å†…å®¹ï¼ˆspinner/å ä½ï¼‰å±•ç¤ºæ—¶ï¼Œå°ºå¯¸ä¸ä¸€å®šéšå†…å®¹å˜å¤§è€Œé‡æ’ï¼Œå¯¼è‡´åç»­å›¾ç‰‡ä»è¢«å‹åœ¨â€œå°çª—å£â€é‡Œï¼Œçœ‹èµ·æ¥åƒâ€œå°ç¼©ç•¥å›¾å½“é¢„è§ˆâ€ã€‚
  - HTML çš„ plain text æå–è‹¥é”™è¯¯å‡è®¾ UTF-8ï¼Œä¼šå¯¼è‡´ `plainText == ""`ï¼ŒChrome/Edge è¾“å…¥æ¡†ä¼˜å…ˆè¯» `.string` æ—¶å°±ä¼šç²˜è´´ä¸ºç©ºã€‚
- **Result**ï¼š
  - å›¾ç‰‡é¢„è§ˆï¼šé¦–å¸§æ›´å¿«ã€popover å°ºå¯¸ç¨³å®šã€æ— éœ€â€œç§»å¼€å†æ‚¬åœâ€ã€‚
  - æ–‡æœ¬é¢„è§ˆï¼špopover å›ºå®šé«˜åº¦ï¼Œé¿å…é¦–å¸§å°å°ºå¯¸å¯¼è‡´å†…å®¹ä¸å¯è§ã€‚
  - æµè§ˆå™¨ç²˜è´´ï¼š`.html/.rtf` æ•°æ®å›å†™æ—¶ï¼Œplain text å…œåº•ä» data è§£æç”Ÿæˆï¼Œå‡å°‘ç²˜è´´ç©ºå†…å®¹ã€‚

## ğŸ—ï¸ å®ç°è·¯çº¿

1. é¢„è§ˆæ¨¡å‹æ”¹ä¸ºæŒæœ‰ `CGImage`ï¼ˆé¿å… UI å±‚åå¤ `NSImage(data:)` è§£ç ï¼‰
2. Image/Text popover è§†å›¾å›ºå®š `frame`ï¼Œè§„é¿ popover å°ºå¯¸ä¸éšå†…å®¹å˜æ›´è€Œé‡æ’çš„é—®é¢˜
3. å›¾ç‰‡é¢„è§ˆä¼˜å…ˆèµ° ImageIOï¼šå¤–éƒ¨å­˜å‚¨å›¾ç‰‡ä» file path ç›´æ¥ç”Ÿæˆ downsampled `CGImage`
4. `ThumbnailCache` è§£ç ç§»å‡ºä¸»çº¿ç¨‹ï¼ˆImageIO/CGImageSourceï¼‰ï¼Œåˆ—è¡¨ç¼©ç•¥å›¾åŠ è½½ä¼˜å…ˆçº§è°ƒé«˜
5. ç¼©ç•¥å›¾ç”Ÿæˆæ”¹ä¸º file path ç‰ˆæœ¬ï¼ˆå¤–éƒ¨å¤§å›¾ä¸å†è¯»å…¥å®Œæ•´ `Data`ï¼‰ï¼Œå¹¶åœ¨ cache æ¸…ç©º/æ›´æ–°æ—¶åŒæ­¥æ¸…ç†å†…å­˜ç¼“å­˜
6. HTML plain text æå–æ”¹ä¸ºç›´æ¥è§£æ HTML dataï¼ˆä¸å†å¼ºåˆ¶ UTF-8ï¼‰ï¼›å›å†™å‰ªè´´æ¿æ—¶å¯¹ç©º `plainText` è¿›è¡Œ data å…œåº•è§£æ
7. è¡¥å……æµ‹è¯•è¦†ç›–ï¼ˆHTML é UTF-8 / copyToClipboard plain text fallbackï¼‰
8. æµ‹è¯•æ—¶åºå‚æ•°å¯æ³¨å…¥ï¼ˆdebounce/refine/scrollï¼‰ï¼Œæå‡ suite é€Ÿåº¦ä¸ç¨³å®šæ€§

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Views/History/HoverPreviewModel.swift`ï¼šé¢„è§ˆæ¨¡å‹æŒæœ‰ `CGImage`
- `Scopy/Views/History/HistoryItemView.swift`ï¼šhover é¢„è§ˆæ”¹ä¸º ImageIO downsampleï¼ˆfile path ä¼˜å…ˆï¼‰+ æ›´æ—©é¢„å–
- `Scopy/Views/History/HistoryItemImagePreviewView.swift`ï¼špopover å›ºå®šå°ºå¯¸ï¼Œé¿å…é¦–å¸§å°å†…å®¹å¯¼è‡´åç»­ä¸é‡æ’
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`ï¼špopover å›ºå®šé«˜åº¦
- `Scopy/Infrastructure/Caching/ThumbnailCache.swift`ï¼šImageIO è§£ç ç§»åˆ°åå° + æ”¯æŒæŒ‰ path evict
- `Scopy/Services/StorageService.swift`ï¼šæ–°å¢ `makeThumbnailPNG(fromFileAtPath:)`
- `Scopy/Application/ClipboardService.swift`ï¼š
  - `.html/.rtf` å›å†™å‰ªè´´æ¿ï¼š`plainText` ä¸ºç©ºæ—¶ä» data è§£æç”Ÿæˆå…œåº•
  - ç¼©ç•¥å›¾ç”Ÿæˆæ”¯æŒ priorityï¼›æ¸…ç©ºç¼©ç•¥å›¾ç£ç›˜ç¼“å­˜æ—¶åŒæ­¥æ¸…ç©ºå†…å­˜ cacheï¼›thumbnail ä¿å­˜å evict
- `Scopy/Services/ClipboardMonitor.swift`ï¼šHTML plain text è§£æä¸å†å‡è®¾ UTF-8
- `Scopy/Observables/HistoryViewModel.swift`ï¼šæŠ½å‡º `Timing` å¹¶æ”¯æŒæµ‹è¯•æ³¨å…¥ï¼ˆç¼©çŸ­ debounce/refine ç­‰ç­‰å¾…ï¼‰
- `Scopy/Observables/AppState.swift`ï¼š`forTesting` æ”¯æŒä¼ å…¥ `historyTiming`
- `ScopyTests/ClipboardMonitorTests.swift`ï¼šæ–°å¢ HTML é UTF-8 plain text è§£æç”¨ä¾‹
- `ScopyTests/ClipboardServiceCopyToClipboardTests.swift`ï¼šæ–°å¢ copyToClipboard å¯¹æ—§æ•°æ®ï¼ˆplainText ä¸ºç©ºï¼‰çš„å…œåº•æµ‹è¯•
- `ScopyTests/ThumbnailPipelineTests.swift`ï¼šç¼©ç•¥å›¾ file-path downsample ä¸å†…å­˜ç¼“å­˜ evict ç”¨ä¾‹
- `ScopyTests/AppStateTests.swift`ï¼šdebounce/refine/loadMore ç›¸å…³ç”¨ä¾‹æ”¹ä¸º `assertEventually` + å¯æ³¨å…¥æ—¶åº
- `ScopyTests/ConcurrencyTests.swift`ï¼šæœç´¢ç‰ˆæœ¬å·æµ‹è¯•æ›´å¯æ§ï¼ˆé¿å…å¶å‘ç«æ€ï¼‰
- `ScopyTests/ResourceCleanupTests.swift`ï¼šç§»é™¤å¤šä½™å›ºå®šç­‰å¾…ï¼Œé™ä½ suite è€—æ—¶

## ğŸ¯ å…³é”®æŒ‡æ ‡

- `make test-unit`ï¼š**142 passed** (1 skipped)
- `make test-integration`ï¼š**12 passed**
- `make test-perf`ï¼š**17 passed** (6 skipped)
- `make test-tsan`ï¼š**142 passed** (1 skipped)
- `make test-strict`ï¼š**142 passed** (1 skipped)

**æ€§èƒ½åŸºçº¿**ï¼ˆåŒæœºåŒé…ç½®ï¼Œ`make test-perf`ï¼ŒLow Power Mode disabledï¼‰ï¼š

- Search 10k (fuzzyPlus) cold start â‰ˆ **131.58ms**ï¼›steady P95 â‰ˆ **59.03ms**ï¼ˆSamples: 50ï¼‰
- Disk 25k (fuzzyPlus) cold start â‰ˆ **739.60ms**ï¼›steady P95 â‰ˆ **66.36ms**ï¼ˆSamples: 60ï¼‰
- Service-path disk 10k (fuzzyPlus) cold start â‰ˆ **259.61ms**ï¼›steady P95 â‰ˆ **49.58ms**ï¼ˆSamples: 50ï¼‰

## ğŸ“Š å½“å‰çŠ¶æ€ï¼ˆå¿«é€Ÿæ£€æŸ¥ï¼‰

- Debug buildï¼šâœ…
- æµ‹è¯•ï¼šâœ…ï¼ˆunit/integration/perf/tsan/strictï¼‰

## ğŸ”® é—ç•™ä¸åç»­

- è‹¥å†å²ä¸­å·²å­˜åœ¨â€œåŸå›¾æ–‡ä»¶ç¼ºå¤±â€çš„æ¡ç›®ï¼ˆä¾‹å¦‚æ—§ç‰ˆæœ¬æµ‹è¯•è¯¯åˆ å¯¼è‡´ï¼‰ï¼Œæœ¬æ¬¡ä¿®å¤æ— æ³•æ‰¾å›åŸå›¾ï¼›åç»­å¯è€ƒè™‘åœ¨ UI ä¸­æ˜¾å¼æç¤ºâ€œåŸå›¾ç¼ºå¤±ï¼Œä»…æœ‰ç¼©ç•¥å›¾â€ã€‚
- è‹¥éœ€è¦è¿›ä¸€æ­¥é‡åŒ– hover é¢„è§ˆé¦–å¸§è€—æ—¶ï¼Œå¯åœ¨ PerformanceTests å¢åŠ  ImageIO downsample çš„ micro-benchmarkï¼ˆæŒ‰å›ºå®šç´ æ/å°ºå¯¸é‡‡æ ·ï¼‰ã€‚
