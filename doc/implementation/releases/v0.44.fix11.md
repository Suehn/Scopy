# v0.44.fix11

## 📌 一页纸总结（What / Why / Result）

### What

- UX/Preview：修复 v0.44.fix10 引入的“Markdown 预览动态宽度失效（总是用最大宽度）”回归；并让 WKWebView 预览的滚动条 idle-hide 在系统“总是显示滚动条”下也确实生效。

### Why

- v0.44.fix10 为避免 reflow 诱发的横向溢出/抖动，选择把 Markdown 预览宽度固定为上限；但在小内容场景会出现明显空白，用户反馈“动态宽度失效”。
- 另一个用户可见问题是：WKWebView 的滚动条有时不会自动隐藏（本质上是 `ScrollbarAutoHider` 没 attach 到 WKWebView 内部真正负责滚动的 `NSScrollView`）。

### Result

- Markdown 预览重新支持 shrink-to-fit（并保留“接近上限时 snap 到 max”的稳定规则）。
- 当检测到横向滚动需求（KaTeX display / code block / table 等内部 overflow 容器）时，优先选择 popover 最大宽度，尽量减少横向滚动发生概率。
- WKWebView 的滚动条 show/hide 逻辑会自动找到并绑定到内部实际滚动的 `NSScrollView`，从而在 “Always show scroll bars” 系统设置下也能 idle-hide。

---

## 📂 核心改动

- `Scopy/Views/History/HistoryItemTextPreviewView.swift`
  - Markdown 预览宽度不再强制 `maxWidth`，改为用预测量宽度 shrink-to-fit；同时：
    - near-max 时 snap 到 `maxWidth`；
    - 一旦检测到横向溢出则锁定使用 `maxWidth`（避免来回抖动）；
    - 可见 WebView 回调只更新高度、保持宽度稳定，避免 hover 中途宽度跳变。
- `Scopy/Views/History/MarkdownPreviewWebView.swift`
  - 新增内部 scroll view 解析：递归查找 WKWebView 子视图中的 `NSScrollView`，确保 `ScrollbarAutoHider` attach 到正确实例。
  - 外层 horizontal scroller 始终关闭（横向滚动被局部化到 HTML 内的 overflow 容器）。
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`
  - 禁用页面级 `overflow-x`，避免产生整页横向滚动条。
  - “横向溢出”信号更贴近实际的内部 overflow 容器（`pre/table/.katex-display`）是否需要横向滚动，用于 SwiftUI 宽度策略。
- `Scopy/Views/History/HistoryItemView.swift`
  - 新的 hover 预览开始/结束时重置 `markdownHasHorizontalOverflow`，避免状态泄漏导致后续预览被错误锁定为最大宽度。

---

## ✅ 测试

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`：Executed 229 tests, 7 skipped, 0 failures

