# v0.43.19 â€” Fix/Qualityï¼šå®‰å…¨/å¹¶å‘/è¾¹ç•Œæ”¶å£ï¼ˆå¤–éƒ¨æ–‡ä»¶æ ¡éªŒ + äº‹ä»¶æµèƒŒå‹ + UI æ”¯æ’‘æ¨¡å—ï¼‰

**æ—¥æœŸ**ï¼š2025-12-15

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

- **What**ï¼š
  - **å¤–éƒ¨æ–‡ä»¶è¯»å–ç»Ÿä¸€æ ¡éªŒ**ï¼šå›¾ç‰‡åŸå§‹æ•°æ®è¯»å–ç»Ÿä¸€èµ° `StorageService.getOriginalImageData(for:)` çš„è·¯å¾„/å¤§å°/ç¬¦å·é“¾æ¥é˜²æŠ¤ï¼Œé¿å…æŸå/è¢«æ±¡æŸ“çš„ DB `storageRef` è¯»å–åˆ°éé¢„æœŸè·¯å¾„ã€‚
  - **ç¼©ç•¥å›¾ç”Ÿæˆå¹¶å‘æ”¶å£ï¼ˆSwift 6 Strictï¼‰**ï¼šç¼©ç•¥å›¾ç”Ÿæˆæ”¹ä¸ºä»…åœ¨ `Task.detached` ä¸­ä¼ é€’çº¯å€¼ï¼ˆpath/data/hashï¼‰ï¼Œé¿å…æ•è· `@MainActor` å¯¹è±¡ï¼›å¹¶åœ¨å†™ç›˜å‰åš `storageRef` æ ¡éªŒã€‚
  - **äº‹ä»¶æµèƒŒå‹ï¼ˆæ›¿ä»£ `.unbounded`ï¼‰**ï¼šå¼•å…¥ `AsyncBoundedQueue` + `AsyncStream(unfolding:)`ï¼Œåœ¨ä¸ä¸¢äº‹ä»¶çš„å‰æä¸‹ä¸º `ClipboardMonitor.contentStream` ä¸ `ClipboardService.eventStream` æä¾›æœ‰ç•Œç¼“å†²ä¸èƒŒå‹ï¼Œé¿å…æç«¯æƒ…å†µä¸‹å†…å­˜æ— ç•Œå¢é•¿ã€‚
  - **åœæ­¢è¯­ä¹‰å¯ await**ï¼šæ–°å¢ `stopAndWait()`ï¼Œæµ‹è¯•/é€€å‡ºè·¯å¾„ä¸å†ä¾èµ– sleep ç­‰å¾…èµ„æºæ”¶å°¾ã€‚
  - **æ¨¡å—è¾¹ç•Œæ›´ä¸€è‡´**ï¼šå°† `IconService` / `ThumbnailCache` ä»åç«¯åŒ…ä¸­æŠ½å‡ºä¸º `ScopyUISupport`ï¼ˆUI-support SwiftPM productï¼‰ï¼Œå¹¶ç§»é™¤åç«¯å¯¹ UI cache çš„ç›´æ¥ä¾èµ–ã€‚
  - **éšç§å£å¾„æ›´ç¨³**ï¼šè·¯å¾„/æ½œåœ¨æ•æ„Ÿé”™è¯¯ä¿¡æ¯æ—¥å¿—ä» `.public` æ”¶æ•›ä¸º `.private`ã€‚
  - **é‡å¤åŠ è½½é™å™ª**ï¼š`ContentView.onAppear` æ”¹ä¸º `HistoryViewModel.loadIfStale()`ï¼Œé¿å…å¯åŠ¨æ—¶ç«‹å³é‡å¤ IOã€‚
- **Why**ï¼šä¿®å¤ä»£ç  review ä¸­çš„ P0â€“P2 é£é™©ç‚¹ï¼šè·¯å¾„å®‰å…¨ã€Strict Concurrency åˆè§„ã€Timer ç”Ÿå‘½å‘¨æœŸå…œåº•ã€äº‹ä»¶æµæ— ç•Œç¼“å†²ã€ä»¥åŠåŒ…è¾¹ç•Œè¯­ä¹‰æ··ç”¨ã€‚
- **Result**ï¼šåŠŸèƒ½ä¸å˜ï¼ˆè¡Œä¸ºä¸€è‡´ï¼‰ï¼Œç¨³å®šæ€§ä¸å¹¶å‘å®‰å…¨æ€§æå‡ï¼›å•æµ‹ä¸ Strict Concurrency å›å½’å‡é€šè¿‡ã€‚

## ğŸ—ï¸ å®ç°è·¯çº¿

1. ç»Ÿä¸€å›¾ç‰‡è¯»å–è·¯å¾„ï¼šç§»é™¤å¯¹ `storageRef` çš„ç›´æ¥ `Data(contentsOf:)`ï¼Œç»Ÿä¸€å¤ç”¨ `StorageService` çš„æ ¡éªŒ/è¯»å–é€»è¾‘ã€‚
2. ç¼©ç•¥å›¾ç”Ÿæˆæ”¹é€ ï¼šæ‹†åˆ†ä¸ºâ€œä¸»çº¿ç¨‹/å­˜å‚¨è¯»å–ï¼ˆå¿…è¦æ—¶ï¼‰â€+â€œåå°ç”Ÿæˆ/å†™ç›˜â€ï¼Œ`Task.detached` ä»…æºå¸¦çº¯å€¼ã€‚
3. å¼•å…¥ `AsyncBoundedQueue`ï¼šæ›¿æ¢ `.unbounded` çš„ `AsyncStream` continuation æ–¹æ¡ˆï¼Œå¢åŠ å–æ¶ˆæ„ŸçŸ¥ï¼Œé¿å…æµ‹è¯•/é€€å‡ºæŒ‚èµ·ã€‚
4. å¢åŠ  `stopAndWait()` å¹¶æ›´æ–°æµ‹è¯•ï¼šåˆ é™¤ stop å sleep ä¾èµ–ã€‚
5. æŠ½å‡º `ScopyUISupport`ï¼šè¿ç§» `IconService`/`ThumbnailCache`ï¼Œè°ƒæ•´ä¾èµ–ä¸ importï¼›åç«¯ç§»é™¤å¯¹ UI cache çš„ç›´æ¥è°ƒç”¨ã€‚
6. æ”¶æ•›æ—¥å¿—éšç§ä¸å¯åŠ¨é‡å¤ loadã€‚

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Application/ClipboardService.swift`ï¼šå›¾ç‰‡è¯»å–æ ¡éªŒç»Ÿä¸€ï¼›ç¼©ç•¥å›¾ç”Ÿæˆ strict-concurrency å®‰å…¨ï¼›äº‹ä»¶æµèƒŒå‹ã€‚
- `Scopy/Services/ClipboardMonitor.swift`ï¼šTimer ç”Ÿå‘½å‘¨æœŸå…œåº•ï¼›contentStream èƒŒå‹ï¼›Strict Concurrency åˆè§„ã€‚
- `Scopy/Utilities/AsyncBoundedQueue.swift`ï¼šæ–°å¢æœ‰ç•Œé˜Ÿåˆ—ï¼ˆå«å–æ¶ˆæ„ŸçŸ¥ï¼‰ç”¨äº `AsyncStream(unfolding:)`ã€‚
- `Scopy/Domain/Protocols/ClipboardServiceProtocol.swift`ï¼šæ–°å¢ `stopAndWait()` é»˜è®¤å®ç°ã€‚
- `Scopy/Services/RealClipboardService.swift`ï¼šå®ç° `stopAndWait()`ã€‚
- `Scopy/Observables/AppState.swift`ï¼šå¯åŠ¨å¤±è´¥è·¯å¾„æ”¹ç”¨ `stopAndWait()`ã€‚
- `Scopy/Observables/SettingsViewModel.swift` / `Scopy/Observables/HistoryViewModel.swift`ï¼šUI ç¼“å­˜æ¸…ç†ä¸‹æ²‰åˆ° Presentationï¼›`loadIfStale()`ã€‚
- `ScopyUISupport/*`ï¼šæ–°å¢ UI-support SwiftPM targetï¼ˆ`IconService` / `ThumbnailCache`ï¼‰ã€‚
- `project.yml` / `Package.swift`ï¼šå¼•å…¥ `ScopyUISupport` product å¹¶æ›´æ–°ä¾èµ–ã€‚

## ğŸ¯ å…³é”®æŒ‡æ ‡

**æµ‹è¯•ç¯å¢ƒ**ï¼šApple M3 / macOS 15.7.2ï¼ˆ24G325ï¼‰/ arm64 / 2025-12-15

- å•å…ƒæµ‹è¯•ï¼š`make test-unit` **147 passed** (1 skipped)
- Strict Concurrencyï¼š`make test-strict` **147 passed** (1 skipped)

## ğŸ“Š å½“å‰çŠ¶æ€ï¼ˆå¿«é€Ÿæ£€æŸ¥ï¼‰

- âœ… Debug build
- âœ… `make test-unit`
- âœ… `make test-strict`

## ğŸ”® é—ç•™ä¸åç»­

- å¦‚è¦è¿›ä¸€æ­¥å¼ºåŒ–â€œæç«¯èƒŒå‹â€ä½“éªŒï¼Œå¯è€ƒè™‘åœ¨ UI å±‚å¢åŠ â€œè¿‡è½½æç¤º/å¼ºåˆ¶å…¨é‡ reloadâ€ç­–ç•¥ï¼ˆä»…åœ¨æ¶ˆè´¹ç«¯é•¿æœŸé˜»å¡æ—¶è§¦å‘ï¼‰ã€‚

