# v0.10.1 前后端分离问题修复

> 基于 `doc/reviews/frontend-separation-review-v0.10.md` 的深度代码审查

## 一页纸总结

**What**: 修复 v0.10 前后端分离改进中发现的 5 个问题
**Why**: 确保生命周期一致性、防止配置误写、保持代码模式统一
**Result**: 133/133 测试通过，所有问题已修复

---

## 问题与修复

| # | 严重度 | 问题 | 修复 |
|---|--------|------|------|
| 1 | 严重 | 降级 Mock 未调用 `start()` | ✅ 降级后调用 `mockService.start()` |
| 2 | 中 | Settings 首帧用默认值 | ✅ 使用可选类型 + 加载态 |
| 3 | 中 | settingsChanged 兜底缺失 | ✅ 先 reload 再兜底，无回调时记录日志 |
| 4 | 低 | ContentView 用 shared | ✅ 改用 `@Environment` 注入 |
| 5 | 低 | 缺少降级/事件测试 | ✅ 新增 3 个测试用例 |

---

## 核心改动

### Fix 1: 降级后调用 start()

**文件**: `Scopy/Observables/AppState.swift:122-141`

```swift
func start() async {
    do {
        try await service.start()
        print("✅ Clipboard Service started")
    } catch {
        print("❌ Failed to start Clipboard Service: \(error)")
        // 停止失败的服务（防止资源泄漏）
        service.stop()
        // 降级到 Mock 服务并启动
        let mockService = MockClipboardService()
        service = mockService
        do {
            try await mockService.start()
            print("⚠️ Falling back to Mock Clipboard Service (started)")
        } catch {
            print("❌ Mock service also failed to start: \(error)")
        }
    }
    // ...
}
```

### Fix 2: Settings 可选类型 + 加载态

**文件**: `Scopy/Views/SettingsView.swift:7-46`

```swift
@State private var tempSettings: SettingsDTO?  // 可选类型

var body: some View {
    Group {
        if tempSettings != nil {
            settingsContent(settings: Binding(...))
        } else {
            // 加载态
            VStack {
                ProgressView()
                Text("Loading settings...")
            }
        }
    }
    .onAppear {
        tempSettings = appState.settings
        refreshStats()
    }
}
```

### Fix 3: settingsChanged 先 reload 再兜底

**文件**: `Scopy/Observables/AppState.swift:233-242`

```swift
case .settingsChanged:
    // 1. 先 reload 最新设置
    await loadSettings()
    // 2. 兜底应用热键（无回调时记录日志）
    if let handler = applyHotKeyHandler {
        handler(settings.hotkeyKeyCode, settings.hotkeyModifiers)
    } else {
        print("⚠️ settingsChanged: applyHotKeyHandler not registered")
    }
    await load()
```

### Fix 4: ContentView 改用 Environment

**文件 1**: `Scopy/Views/ContentView.swift:5-11`

```swift
struct ContentView: View {
    @Environment(AppState.self) private var appState
    // ...
    var body: some View {
        @Bindable var bindableAppState = appState
        // ...
    }
}
```

**文件 2**: `Scopy/FloatingPanel.swift:42-47`

```swift
contentView = NSHostingView(
    rootView: view()
        .environment(AppState.shared)  // 注入
        .ignoresSafeArea()
)
```

### Fix 5: 新增测试用例

**文件**: `ScopyTests/AppStateTests.swift:636-708`

- `AppStateFallbackTests.testStartFallsBackToMockOnFailure()` - 测试降级行为
- `AppStateFallbackTests.testSettingsChangedAppliesHotkey()` - 测试事件处理
- `AppStateFallbackTests.testSettingsChangedWithoutHandlerDoesNotCrash()` - 测试无回调场景

---

## 文件清单

| 文件 | 改动 |
|------|------|
| `Scopy/Observables/AppState.swift` | Fix 1, 3 |
| `Scopy/Views/SettingsView.swift` | Fix 2 |
| `Scopy/Views/ContentView.swift` | Fix 4 |
| `Scopy/FloatingPanel.swift` | Fix 4 |
| `ScopyTests/AppStateTests.swift` | Fix 5 |

---

## 关键指标

| 指标 | 值 |
|------|-----|
| 测试用例 | 133/133 通过 (1 skipped) |
| 新增测试 | 3 |
| 编译 | ✅ Debug 通过 |
| 性能 | 无退化 |

---

## 遗留与后续

- ✅ 所有 review 问题已修复
- ✅ 测试覆盖已增强
- Phase 5 (设计系统抽象) 仍为可选，可后续实施

---

## 参考

- `doc/reviews/frontend-separation-review-v0.10.md` - 原始 review 文档
- `doc/reviews/frontend-separation-review.md` - Phase 1-4 评估文档
- `doc/specs/v0.md` - 设计规范

---

**日期**: 2025-11-28
**作者**: Claude Code
