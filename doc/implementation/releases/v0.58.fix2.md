# v0.58.fix2

## 📌 一页纸总结（What / Why / Result）

### What

- Perf/Search：2 字中文/非 ASCII 短词在大库下进一步提速（不减搜索范围），并补回归测试保障 pinned 命中稳定展示。

### Why

- 真实 143MB 历史库下，2 字中文短词（如“数学”）走 SQLite `instr(...)` 全表扫描，交互延迟仍偏高；需要在保持“全量不漏项 + 排序语义一致”的前提下，把最重路径降到 10ms 级。

### Result

- 真实 143MB / 6k+ 项快照库（`perf-db/clipboard.db`，release `ScopyBench`，warmup 20 / iters 30）：
  - `fuzzyPlus + relevance + query=数学`：avg 10.25ms，P95 12.86ms（此前 avg ~31ms）
  - `fuzzyPlus + relevance + query=cm`：avg 4.84ms，P95 4.96ms（保持 ~5ms 级）

---

## 🏗️ 实现路线

1. 扩展 `ShortQueryIndex`：新增非 ASCII UTF16 bigram postings（覆盖 CJK/emoji 等“2 UTF16 单元”短词），用于候选定位。
2. 搜索短词（≤2）时：index 就绪后优先走“候选集 + SQL instr 排序/分页”路径；候选过大或 index 未就绪时安全回退到原全表扫描，避免退化/不稳定。
3. 添加回归测试：中文短词搜索下 pinned 命中仍展示且排第一；同时等待 shortQueryIndex 构建完成，确保覆盖新路径。

---

## 📂 核心改动

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
  - `ShortQueryIndex`：新增非 ASCII UTF16 bigram postings + 候选查询接口
  - `searchFullFuzzy`：2 字非 ASCII 短词优先候选集 SQL 路径（语义/排序保持一致）
- `ScopyTests/SearchServiceTests.swift`
  - 新增 `testShortQueryCJKPinnedItemsRankFirst`
- `Makefile`
  - `bench-snapshot-search`：加入 `数学` 并提高 warmup 以反映稳定态

---

## 🎯 关键指标

- 2 字中文短词（数学等）稳定态：P95 ~13ms（真实快照库）。
- 2 字 ASCII 短词（cm）稳定态：P95 ~5ms（保持不退化）。

---

## 📊 当前状态

- 单元测试：`make test-unit` ✅（Executed 256 tests, 1 skipped, 0 failures，2026-01-12）
- Strict Concurrency：`make test-strict` ✅（Executed 256 tests, 1 skipped, 0 failures，2026-01-12）

---

## 🔮 遗留与后续

- 冷启动首次中文短词仍可能回退到全表扫描（例如“数学”首发 ~30ms）；若要进一步压缩首发延迟，需要引入更激进的“启动/打开面板预热索引”策略（仍可保持语义不变）。
