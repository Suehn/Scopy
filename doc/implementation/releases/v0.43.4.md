# v0.43.4 - Fix/UX：测试隔离外部原图 + 缩略图即时刷新

**日期**: 2025-12-14

---

## 一页纸总结

### What

- **修复测试误删外部原图**：`StorageService` 在 in-memory / 测试场景下不再默认落到 `Application Support/Scopy/content`；外部内容与缩略图目录随测试隔离到临时目录，避免测试触发 `cleanupOrphanedFiles()` 时误删真实历史的原图文件。
- **缩略图即时刷新（无需搜索/重载）**：缩略图生成后通过 `.thumbnailUpdated` 事件更新列表；同时 `HistoryItemView` 的 `Equatable` 比较纳入 `thumbnailPath`，确保缩略图路径变化会触发行视图重绘。

### Why

- 之前测试若使用 in-memory DB，但外部目录仍指向用户真实 `Application Support/Scopy/content`，清理 orphan 时会把真实历史的原图当作“孤儿文件”删除，导致“只剩缩略图”。
- `HistoryItemView` 采用 `Equatable` 优化重绘，但未纳入 `thumbnailPath`，导致缩略图生成完成后列表行不刷新，用户体感变成“要搜索/刷新 UI 才出现”。

### Result

- ✅ 测试不会再触碰/清理真实用户外部内容目录（外部存储根目录与 DB/测试运行隔离）。
- ✅ 缩略图生成后会即时显示（无需触发搜索或重载列表）。
- ✅ 回归通过：
  - `make test-unit`：**55 passed**, 1 skipped（56 total）
  - `make test-perf`：**16 passed**, 6 skipped（22 total）
  - `make test-tsan`：**135 passed**, 1 skipped（136 total）
  - `make test-strict`：**163 passed**, 7 skipped（170 total）

---

## 实现路线

1. `StorageService`：统一 root 目录解析逻辑
   - 非内存 DB：外部内容/缩略图目录与 DB 同目录 colocate（便于隔离与迁移）。
   - 测试/内存 DB：root 目录落到临时目录，避免写入/清理用户真实数据。
   - orphan 清理增加“DB 目录与 root 不一致时拒绝执行”的保护。
2. 缩略图更新链路对齐 UI
   - 缩略图保存完成后发送 `.thumbnailUpdated(itemID, thumbnailPath)`。
   - `HistoryItemView` 的 `Equatable` 比较加入 `thumbnailPath`，让缩略图路径变化触发刷新。

---

## 核心改动

- `Scopy/Services/StorageService.swift`
- `Scopy/Application/ClipboardService.swift`
- `Scopy/Observables/HistoryViewModel.swift`
- `Scopy/Views/History/HistoryItemView.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit`（55 passed, 1 skipped）
- 性能测试：`make test-perf`（16 passed, 6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`）
- Thread Sanitizer：`make test-tsan`（135 passed, 1 skipped）
- Strict Concurrency：`make test-strict`（163 passed, 7 skipped）

### 性能（Debug / `make test-perf` 单次运行）

- 环境：MacBook Air（Apple M3, 24 GB）/ macOS 15.7.2（24G325）/ arm64 / 2025-12-14
- 电源：Low Power Mode = disabled（`pmset -g` 显示 `lowpowermode 0`）
- 关键结果：
  - Fuzzy 5k items P95 ≈ 4.82ms
  - Fuzzy 10k items P95 ≈ 44.61ms（Samples: 50）
  - Disk 25k fuzzy P95 ≈ 70.83ms（Samples: 50）
  - Bulk insert 1000 items ≈ 51.87ms（≈19,277 items/s）
  - Fetch recent (50 items) avg ≈ 0.07ms
  - Regex 20k items P95 ≈ 2.99ms
  - Mixed content disk search（single run）≈ 4.25ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 若仍担心极端时序（缩略图事件早于首屏 items 设置）导致“事件丢失”，可在 `HistoryViewModel` 增加 pending thumbnail 更新缓存（按 `itemID → thumbnailPath`），在 `load()` 完成后统一 apply。
- 若后续需要进一步提升大量图片场景下的体感，可考虑给缩略图生成增加并发上限（避免磁盘/解码竞争导致尾部抖动）。

