# v0.43.5 - Perf/UX：图片预览提速（缩略图占位 + JPEG downsample）

**日期**: 2025-12-14

---

## 一页纸总结

### What

- **图片 hover 预览更快**：
  - popover 在延迟到达后先显示缩略图占位（若已缓存），避免长时间转圈。
  - 原图 downsample 改为 **无 alpha 用 JPEG**（质量 0.85），避免 PNG 编码在大分辨率场景下的高 CPU 开销。
  - 预览 IO + downsample 使用 `userInitiated` 优先级，减少被后台缩略图/清理任务“饿死”的体感。
- **避免不必要的重编码**：若原图像素已小于 `maxPixelSize`，直接复用原数据，不再额外 downsample/重编码。

### Why

- 文件体积小（例如 160KB）并不代表像素规模小；对大分辨率图片做 PNG 重编码会显著拖慢 hover 预览。
- 预览属于“用户当前交互”，应优先于后台 thumbnail 生成等 utility 任务。

### Result

- hover 预览响应更及时（先缩略图、后原图），总体等待显著下降。
- 回归通过：
  - `make test-unit`：**55 passed**, 1 skipped（56 total）
  - `make test-perf`：**16 passed**, 6 skipped（22 total）
  - `make test-tsan`：**135 passed**, 1 skipped（136 total）
  - `make test-strict`：**163 passed**, 7 skipped（170 total）

---

## 实现路线

1. `HistoryItemImagePreviewView`：支持缩略图路径作为占位（优先命中 `ThumbnailCache`）。
2. `HistoryItemView`：hover delay 到达即展示 popover；原图准备好后无缝替换。
3. `downsampleImageData`：检测像素是否需要 downsample；编码策略从 PNG 改为（无 alpha）JPEG。
4. `ClipboardService.getImageData`：外部文件读取提升为 `userInitiated` 并使用 `.mappedIfSafe`。

---

## 核心改动

- `Scopy/Views/History/HistoryItemView.swift`
- `Scopy/Views/History/HistoryItemImagePreviewView.swift`
- `Scopy/Application/ClipboardService.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit`（55 passed, 1 skipped）
- 性能测试：`make test-perf`（16 passed, 6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`）
- Thread Sanitizer：`make test-tsan`（135 passed, 1 skipped）
- Strict Concurrency：`make test-strict`（163 passed, 7 skipped）

### 性能（Debug / `make test-perf` 单次运行）

- 环境：MacBook Air（Apple M3, 24 GB）/ macOS 15.7.2（24G325）/ arm64 / 2025-12-14
- 电源：Low Power Mode enabled（`pmset -g` 显示 `lowpowermode 1`）
- 关键结果：
  - Fuzzy 5k items P95 ≈ 8.26ms
  - Fuzzy 10k items P95 ≈ 75.82ms（Samples: 50；Low Power Mode 下测试阈值放宽至 300ms）
  - Disk 25k fuzzy P95 ≈ 99.52ms（Samples: 50；Low Power Mode enabled）
  - Bulk insert 1000 items ≈ 84.10ms（≈11,891 items/s；Low Power Mode enabled）
  - Fetch recent (50 items) avg ≈ 0.11ms
  - Regex 20k items P95 ≈ 5.32ms
  - Mixed content disk search（single run）≈ 7.46ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 若要量化“hover 预览体感”可考虑补充一个最小 UI 基准（例如记录 hover → popover 首帧耗时），并写入 `doc/profiles/`。

