# v0.50.fix15

> 状态：✅
> 说明：Fix/Preview：修复 hover Markdown/LaTeX 长内容预览在复用 WKWebView 后更易出现的“滚动卡顿/分段渲染/偶发渲染缺块”，并保持共享单个 WKWebView + popover 全局互斥策略不变。

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Preview：复用同一 `WKWebView` 时，优先回放已知 metrics，而不是每次强制 JS 重新上报；仅在必要时延迟 refresh（等待 webView 有有效宽度），避免 0 宽度测量污染。
- Fix/Preview：Markdown 预览宽度 metrics 加入 sane-check（绝对/相对阈值）与可纠正策略，避免 popover 宽度被锁到极窄导致高度暴涨。
- Perf/Preview：滚动期降载（HTML 仅对 overflow 容器触发“临时显示滚动条”；`ScrollbarAutoHider` 改为 deadline + timer，避免每帧 cancel/reschedule）。

### Why

- 复用模式下，如果 `__scopyReportHeight(force:true)` 在 webView 尚未完成 layout（width=0/极小）的窗口期被触发，会产生错误 width/height；一旦缓存/复用，会导致 popover 极窄、滚动卡顿与“渲染不全/空白块”的体感问题。
- 滚动期高频 JS/主线程调度会进一步放大长内容的卡顿体感，需要减少滚动路径上的额外工作。

### Result

- 长内容 Markdown/LaTeX 预览：popover 宽度更稳定、滚动更顺滑，降低偶发“渲染缺块/分段加载”的体感问题。
- 行为保持不变：共享单个 `WKWebView`、popover 全局互斥、导出 PNG、网络阻断等现有功能与约束不变。

---

## 📂 核心改动

- `Scopy/Views/History/MarkdownPreviewWebView.swift`
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`
- `Scopy/Views/History/HistoryItemView.swift`
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`

---

## ✅ 测试

- ⏸ 未运行（按需可跑：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`）
- ✅ 编译：`make build`
