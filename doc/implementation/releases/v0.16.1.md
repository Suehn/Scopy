# v0.16.1 - è¾¹ç¼˜ Bug ä¿®å¤

**æ—¥æœŸ**: 2025-11-29
**ç±»å‹**: Bug ä¿®å¤
**å‰ç½®ç‰ˆæœ¬**: v0.16

---

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“

### What
ä¿®å¤ä¸¤ä¸ªè¾¹ç¼˜ Bugï¼š
1. è¿‡æ»¤å™¨ä¸ç”Ÿæ•ˆï¼šé€‰æ‹©å›¾ç‰‡ç±»å‹è¿‡æ»¤å™¨åï¼Œå¤åˆ¶æ–°æ–‡æœ¬ä»ç„¶æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
2. è´Ÿæ•° item countï¼šåˆ é™¤é¡¹ç›®åï¼Œfooter æ˜¾ç¤ºè´Ÿæ•°ï¼ˆå¦‚ "-41 items"ï¼‰

### Why
- Bug 1ï¼š`handleEvent(.newItem)` æ— æ¡ä»¶å°†æ–°é¡¹ç›®æ’å…¥ `items`ï¼Œæœªæ£€æŸ¥å½“å‰ `typeFilter`
- Bug 2ï¼š`delete()` å’Œ `handleEvent(.itemDeleted)` éƒ½é€’å‡ `totalCount`ï¼Œå¯¼è‡´æ¯æ¬¡åˆ é™¤å‡ 2 æ¬¡

### Result
- æ–°å¢ `matchesCurrentFilters()` æ–¹æ³•ï¼Œåªæœ‰åŒ¹é…è¿‡æ»¤æ¡ä»¶çš„é¡¹ç›®æ‰æ’å…¥åˆ—è¡¨
- ç§»é™¤ `delete()` ä¸­çš„ `totalCount -= 1`ï¼Œç”±äº‹ä»¶ç»Ÿä¸€å¤„ç†
- æµ‹è¯• 161/161 é€šè¿‡

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. åˆ†æ Bug 1 æ ¹å› ï¼š`handleEvent(.newItem)` æ— æ¡ä»¶æ’å…¥
2. åˆ†æ Bug 2 æ ¹å› ï¼š`totalCount` è¢«é‡å¤é€’å‡
3. å®ç° `matchesCurrentFilters()` è¾…åŠ©æ–¹æ³•
4. ä¿®æ”¹ `handleEvent(.newItem)` æ·»åŠ è¿‡æ»¤æ£€æŸ¥
5. ä¿®æ”¹ `delete()` ç§»é™¤é‡å¤é€’å‡
6. è¿è¡Œæµ‹è¯•éªŒè¯

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `Scopy/Observables/AppState.swift` | æ–°å¢ `matchesCurrentFilters()`ï¼Œä¿®å¤ `handleEvent(.newItem)` å’Œ `delete()` |

### å…·ä½“ä»£ç å˜æ›´

#### 1. handleEvent(.newItem) - æ·»åŠ è¿‡æ»¤æ£€æŸ¥

```swift
case .newItem(let item):
    let wasExisting = items.contains(where: { $0.id == item.id })
    items.removeAll { $0.id == item.id }

    // v0.16.1: åªæœ‰åŒ¹é…å½“å‰è¿‡æ»¤æ¡ä»¶æ—¶æ‰æ’å…¥åˆ°åˆ—è¡¨
    if matchesCurrentFilters(item) {
        items.insert(item, at: 0)
    }

    if !wasExisting {
        totalCount += 1
    }
    // ...
```

#### 2. delete() - ç§»é™¤é‡å¤é€’å‡

```swift
func delete(_ item: ClipboardItemDTO) async {
    do {
        try await service.delete(itemID: item.id)
        items.removeAll { $0.id == item.id }
        // v0.16.1: ç§»é™¤é‡å¤é€’å‡ï¼Œç”± handleEvent(.itemDeleted) ç»Ÿä¸€å¤„ç†
    } catch {
        print("Delete failed: \(error)")
    }
}
```

#### 3. æ–°å¢ matchesCurrentFilters() è¾…åŠ©æ–¹æ³•

```swift
/// v0.16.1: æ£€æŸ¥é¡¹ç›®æ˜¯å¦åŒ¹é…å½“å‰è¿‡æ»¤æ¡ä»¶
private func matchesCurrentFilters(_ item: ClipboardItemDTO) -> Bool {
    if let typeFilter = typeFilter, item.type != typeFilter {
        return false
    }
    if let appFilter = appFilter, item.appBundleID != appFilter {
        return false
    }
    if !searchQuery.isEmpty {
        return false
    }
    return true
}
```

---

## ğŸ¯ å…³é”®æŒ‡æ ‡

### æµ‹è¯•ç»“æœ

| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| å•å…ƒæµ‹è¯• | 161/161 passed (1 skipped) |
| æ„å»º | Debug âœ… |
| éƒ¨ç½² | /Applications/Scopy.app âœ… |

### Bug éªŒè¯

| Bug | éªŒè¯æ­¥éª¤ | é¢„æœŸç»“æœ |
|-----|---------|---------|
| è¿‡æ»¤å™¨ä¸ç”Ÿæ•ˆ | é€‰æ‹©å›¾ç‰‡è¿‡æ»¤å™¨ â†’ å¤åˆ¶æ–‡æœ¬ | æ–‡æœ¬ä¸æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­ |
| è´Ÿæ•° item count | åˆ é™¤é¡¹ç›® | è®¡æ•°æ­£ç¡®é€’å‡ï¼Œä¸å‡ºç°è´Ÿæ•° |

---

## ğŸ“Š å½“å‰çŠ¶æ€

```
âœ… Bug 1 ä¿®å¤ï¼šè¿‡æ»¤å™¨ä¸ç”Ÿæ•ˆ
âœ… Bug 2 ä¿®å¤ï¼šè´Ÿæ•° item count
âœ… æµ‹è¯•é€šè¿‡ï¼š161/161
âœ… å·²éƒ¨ç½²ï¼š/Applications/Scopy.app
```

---

## ğŸ”® é—ç•™ä¸åç»­

### æœ¬ç‰ˆæœ¬å®Œæˆ
- ä¸¤ä¸ªè¾¹ç¼˜ Bug å·²ä¿®å¤
- äº‹ä»¶é©±åŠ¨çŠ¶æ€ç®¡ç†æ›´åŠ ä¸€è‡´

### åç»­å»ºè®®
- è€ƒè™‘ä¸º `handleEvent(.itemUpdated)` ä¹Ÿæ·»åŠ è¿‡æ»¤æ£€æŸ¥
- è€ƒè™‘æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–è¿™ä¸¤ä¸ªè¾¹ç¼˜åœºæ™¯
