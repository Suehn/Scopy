# v0.40 - Presentation：拆分 AppState（History/Settings ViewModel）+ perf 用例稳定性

**日期**: 2025-12-13

---

## 一页纸总结

### What

- **拆分 AppState**：新增 `HistoryViewModel` / `SettingsViewModel`，`AppState` 收敛为“服务启动 + 事件分发 + UI 回调”协调器。
- **Presentation 收口**：主窗口相关视图改为直接依赖 `HistoryViewModel`（绑定 `searchQuery`、分页、选择/删除等），设置窗口改为依赖 `SettingsViewModel`（读取/保存 settings、拉取存储统计）。
- **perf 用例稳定性**：`testDiskBackedSearchPerformance25k` 采样从 5 → 50（10 rounds × 5 queries），降低一次性系统抖动导致的 P95 误报。

### Why

- `AppState` 过于臃肿会放大 Observation 半径，导致维护/回归成本升高；拆分可让 UI 更聚焦、边界更清晰，也为 Phase 7（Swift Package）提供更干净的 UI 入口。
- perf 测试必须可重复；少量样本对 P95 极其敏感，容易误报回归。

### Result

- 行为保持一致：搜索/过滤/分页/快捷键导航等路径不变，仅拆分状态与依赖注入方式。
- 测试与回归通过（含 Strict Concurrency/TSan），性能指标无明显回归（见下方数据）。

---

## 核心实现

### AppState 拆分

- `Scopy/Observables/HistoryViewModel.swift`：
  - 负责 history/search/paging/selection/actions（含 debounce、refine、loadMore）
  - 向 UI 暴露 `items/searchQuery/searchMode/filters/...`，并提供 `select/delete/pin/clear` 等动作
- `Scopy/Observables/SettingsViewModel.swift`：
  - 负责 settings 的读写与 storage stats/disk size（含 120s 缓存）
- `Scopy/Observables/AppState.swift`：
  - 负责 service 启动与 fallback、事件流单消费者分发、热键/窗口回调
  - 保留 `AppState` 兼容 API（tests 与旧调用点无需一次性重写）

### View 依赖收口

- `ContentView/HeaderView/HistoryListView/FooterView` 使用 `HistoryViewModel` 驱动（替代 `@Bindable AppState` 绑定 computed 属性的不可行路径）。
- `SettingsView` 使用 `SettingsViewModel` 获取 settings 与存储统计，保存时同步 `HistoryViewModel.searchMode`。
- `AppDelegate` 在 root view 注入 `AppState + HistoryViewModel + SettingsViewModel` 到 SwiftUI Environment。

### perf 用例稳定性

- `ScopyTests/PerformanceTests.swift`：
  - `testDiskBackedSearchPerformance25k` 增加样本数并打印 `Samples`，降低 flake。

---

## 修改文件列表（核心）

- `Scopy/Observables/AppState.swift`
- `Scopy/Observables/HistoryViewModel.swift`
- `Scopy/Observables/SettingsViewModel.swift`
- `Scopy/AppDelegate.swift`
- `Scopy/Views/ContentView.swift`
- `Scopy/Views/HeaderView.swift`
- `Scopy/Views/HistoryListView.swift`
- `Scopy/Views/FooterView.swift`
- `Scopy/Views/SettingsView.swift`
- `ScopyTests/PerformanceTests.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- 性能测试：`make test-perf` **22 tests passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)
- Thread Sanitizer：`make test-tsan` **132 tests passed** (1 skipped)
- Strict Concurrency：`xcodebuild test -only-testing:ScopyTests SWIFT_STRICT_CONCURRENCY=complete SWIFT_TREAT_WARNINGS_AS_ERRORS=YES` **166 tests passed** (7 skipped)

### 性能（Debug / `make test-perf` 单次运行）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 4.72ms
  - Fuzzy 10k items P95 ≈ 46.06ms（Samples: 50）
  - Disk 25k fuzzy P95 ≈ 58.44ms（Samples: 50）
  - Bulk insert 1000 items ≈ 51.57ms（≈19,390 items/s）
  - Fetch recent (50 items) avg ≈ 0.07ms
  - Regex 20k items P95 ≈ 3.11ms
  - Mixed content disk search（single run, after warmup）≈ 4.24ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ Strict Concurrency（ScopyTests）
- ⏳ 热键自查：`/tmp/scopy_hotkey.log`（本版本不改热键；按 `AGENTS.md` 仍建议人工自查一次）

---

## 遗留与后续

- （可选）将 Strict Concurrency 命令固化到 `Makefile` / CI（见 `doc/reviews/review-v0.3.md` Phase 6 待续）。
- Phase 7（可选）：抽成 Swift Package（强制边界，减少 UI 误触底层实现的回归风险）。

