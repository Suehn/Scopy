# v0.43 - Phase 7（完成）：强制 ScopyKit module 边界（后端从 App target 移出）

**日期**: 2025-12-13

---

## 一页纸总结

### What

- **完成 Phase 7 目标**：App target 仅保留 App/UI/Presentation 源码；后端（Domain/Application/Infrastructure/Services/Utilities）全部由本地 SwiftPM 模块 `ScopyKit` 提供。
- **修复 SwiftPM + 自定义 BUILD_DIR 冲突**：在保持构建产物落到 `.build/` 的前提下，补齐 Swift 编译搜索路径，使 App/Test targets 能稳定 `import ScopyKit`。
- **测试体系对齐模块边界**：`ScopyTests`/`ScopyTSanTests` 改为依赖 `ScopyKit`，不再把后端源码直接编进 test bundle。

### Why

- Phase 7 的核心收益是“编译器强制边界”：UI 不可能再意外引用 SQLite/存储/搜索实现细节，后续重构回归概率显著降低。
- 当前仓库将 `BUILD_DIR` 定位到 `.build/`（便于部署脚本），但 SwiftPM 仍会产出到 DerivedData；若不补齐搜索路径，将无法在 App target 中直接 `import ScopyKit`。

### Result

- App target 已可直接 `import ScopyKit`，并通过 `ClipboardServiceFactory` 创建服务。
- `make build`、`make test-unit`、`make test-perf`、`make test-tsan`、`make test-strict` 全部通过。

---

## 核心实现

### 1) App target 只保留 UI 代码

- `project.yml`：`Scopy` target sources 排除后端目录（`Application/Domain/Infrastructure/Services/Utilities/Extensions` 等），并继续依赖 package `ScopyKit`。
- UI 相关文件统一 `import ScopyKit`，以使用协议/DTO/服务入口。

### 2) SwiftPM module 可被 App/Test targets 正确导入

- `project.yml`：补充
  - `SWIFT_INCLUDE_PATHS = $(OBJROOT)/../Products/$(CONFIGURATION)`
  - `FRAMEWORK_SEARCH_PATHS = $(OBJROOT)/../Products/$(CONFIGURATION)`
- 说明：SwiftPM 产物默认仍在 DerivedData 的 `Build/Products/*`，该设置让 `BUILD_DIR=.build` 的工程也能找到 `ScopyKit.swiftmodule`。

### 3) ScopyTests/TSanTests 对齐 ScopyKit

- `project.yml`：`ScopyTests` / `ScopyTSanTests` 不再编译后端目录，改为依赖 `ScopyKit` product。
- 测试源码：统一 `import ScopyKit`，并避免引用 `RealClipboardService` / `MockClipboardService`（改走 `ClipboardServiceFactory`）。

### 4) ScopyKit 对外符号补齐访问控制

- 将 UI/测试需要的 Domain 模型、协议与关键服务类型补齐 `public`（例如 `ClipboardServiceProtocol`、`SettingsDTO`、`StorageService`、`SearchEngineImpl` 等），确保跨 module 正常使用。

---

## 修改文件列表（核心）

- `project.yml`
- `Scopy.xcodeproj/project.pbxproj`
- `Scopy/AppDelegate.swift`
- `Scopy/Observables/AppState.swift`
- `Scopy/Observables/HistoryViewModel.swift`
- `Scopy/Observables/SettingsViewModel.swift`
- `Scopy/Views/*`
- `Scopy/Presentation/ClipboardItemDisplayText.swift`
- `Scopy/Domain/Models/*`
- `Scopy/Domain/Protocols/ClipboardServiceProtocol.swift`
- `Scopy/Infrastructure/Caching/IconService.swift`
- `Scopy/Infrastructure/Caching/ThumbnailCache.swift`
- `Scopy/Infrastructure/Settings/SettingsStore.swift`
- `Scopy/Infrastructure/Persistence/ClipboardStoredItem.swift`
- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
- `Scopy/Services/*`（`StorageService`/`ClipboardMonitor`/`HotKeyService`/`Performance*`/`RealClipboardService`）
- `Scopy/Utilities/*`
- `ScopyTests/*`
- `DEPLOYMENT.md`
- `doc/profiles/v0.43-profile.md`
- `doc/profiles/README.md`
- `doc/implementation/README.md`
- `doc/implementation/CHANGELOG.md`
- `doc/reviews/review-v0.3.md`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 passed** (1 skipped)
- 性能测试：`make test-perf` **22 passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)
- Thread Sanitizer：`make test-tsan` **132 passed** (1 skipped)
- Strict Concurrency：`make test-strict` **166 passed** (7 skipped)

### 性能（Debug / `make test-perf` 单次运行）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 7.11ms
  - Fuzzy 10k items P95 ≈ 51.88ms（Samples: 50）
  - Disk 25k fuzzy P95 ≈ 72.74ms（Samples: 50）
  - Bulk insert 1000 items ≈ 60.26ms（≈16,595 items/s）
  - Fetch recent (50 items) avg ≈ 0.08ms
  - Regex 20k items P95 ≈ 3.87ms
  - Mixed content disk search（single run）≈ 6.10ms

---

## 当前状态（快速检查）

- ✅ `make build`
- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 公开 API 面仍偏大（为测试与迁移服务）；后续可通过：
  - 将测试迁移到 SwiftPM test target，或
  - 通过 `@_spi`/internal adapter 收敛 public surface
  来逐步减小对外暴露面。
