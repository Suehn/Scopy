# v0.44.fix26

> çŠ¶æ€ï¼šâœ…

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Fix/Searchï¼šExactï¼ˆFTSï¼‰ç»“æœæ–°å¢ä¸¤ç§æ’åºï¼š`Relevance`ï¼ˆ`bm25` + `last_used_at`ï¼‰ä¸ `Recent`ï¼ˆ`last_used_at`ï¼‰ï¼Œå¹¶åœ¨ä¸»é¢æ¿ Header å¢åŠ ä¸€é”®åˆ‡æ¢æŒ‰é’®ï¼ˆé»˜è®¤ `Relevance`ï¼Œå¯åˆ‡å› `Recent`ï¼‰ã€‚
- Fix/Settings æ–‡æ¡ˆï¼šå­˜å‚¨é™åˆ¶ä¸­çš„â€œå†…è”å­˜å‚¨ä¸Šé™â€æ›´åä¸ºâ€œå†…å®¹ä¼°ç®—ä¸Šé™â€ï¼Œå¹¶æ˜ç¡®å£å¾„ä¸º `SUM(size_bytes)`ï¼Œé¿å…ä¸â€œæ•°æ®åº“æ–‡ä»¶å¤§å°â€æ··æ·†ï¼ˆP3-1ï¼‰ã€‚
- Refactor/Storageï¼š`getOriginalImageData` é‡å‘½åä¸º `loadPayloadData`ï¼ˆä¿ç•™ deprecated å…¼å®¹è½¬å‘ï¼‰ï¼Œé¿å…å‘½åè¯¯å¯¼ï¼ˆP3-2ï¼‰ã€‚
- Fix/HotKeyï¼šç§»é™¤ HotKeyRecorderView çš„å›ºå®š sleep åŒæ­¥æ–¹å¼ï¼Œæ”¹ä¸ºåŸºäº `SettingsStore.observeSettings()` ç­‰å¾…æŒä¹…åŒ–ç»“æœå¹¶æ ¡éªŒï¼Œé™ä½ç«æ€/è¯¯æŠ¥é£é™©ï¼ˆP3-7ï¼‰ã€‚
- Perf/Previewï¼šhover Markdown æ¸²æŸ“ä»»åŠ¡å¢åŠ å–æ¶ˆæ£€æŸ¥ï¼Œé¿å…â€œå·²å–æ¶ˆä»ç»§ç»­æ¸²æŸ“å¹¶ç¼“å­˜â€çš„ CPU æµªè´¹ï¼ˆP3-5ï¼‰ã€‚
- Test/UITestsï¼šå»æ‰å¤šå¤„å›ºå®š sleepï¼Œæ”¹ä¸ºå¯ç­‰å¾…æ¡ä»¶ï¼›å¹¶åœ¨ `--uitesting` æ¨¡å¼ä¸‹ä½¿ç”¨æ ‡å‡† `NSWindow` æ‰¿è½½ä¸»ç•Œé¢ï¼Œæå‡ UI æµ‹è¯•å¯è§‚æµ‹æ€§ä¸ç¨³å®šæ€§ï¼ˆP3-4ï¼‰ã€‚

### Why

- FTS æœç´¢è‹¥åªæŒ‰æœ€è¿‘ä½¿ç”¨æ’åºï¼Œä¼šè®©â€œæ›´ç›¸å…³ä½†è¾ƒæ—§â€çš„ç»“æœé åï¼›è€Œ v0.md æè¿°çš„é»˜è®¤è¯­ä¹‰æ˜¯â€œåŒ¹é…åº¦ + æœ€è¿‘ä½¿ç”¨â€ã€‚æä¾›å¯åˆ‡æ¢æ’åºï¼Œå¹¶é»˜è®¤å¯¹é½è§„æ ¼ï¼ˆP2-3ï¼‰ã€‚
- â€œå†…å®¹ä¼°ç®—/æ•°æ®åº“æ–‡ä»¶å¤§å°â€å£å¾„ä¸ä¸€è‡´ä¼šè¯¯å¯¼ç”¨æˆ·å¯¹æ¸…ç†é˜ˆå€¼çš„ç†è§£ï¼ˆP3-1ï¼‰ã€‚
- å›ºå®š sleep çš„åŒæ­¥æ–¹å¼ä¸ hover é¢„è§ˆçš„å–æ¶ˆè¯­ä¹‰éƒ½ä¾èµ–æ—¶é—´å‡è®¾ï¼Œæ˜“åœ¨è´Ÿè½½/è°ƒåº¦å˜åŒ–ä¸‹å˜å¾—ä¸ç¨³å®šï¼ˆP3-5/P3-7/P3-4ï¼‰ã€‚

### Result

- Exactï¼ˆFTSï¼‰æ’åºå¯åˆ‡æ¢ä¸”é»˜è®¤æ›´ç¬¦åˆç›´è§‰ï¼›æ–°å¢å•æµ‹å¯¹é½ SQLite çš„ `bm25` æ’åºç»“æœã€‚
- Settings å­˜å‚¨ä¸Šé™è¯­ä¹‰æ›´æ¸…æ™°ï¼›payload loader å‘½åæ›´å‡†ç¡®ã€‚
- HotKey å½•åˆ¶ååŒæ­¥æ›´ç¡®å®šï¼›hover Markdown å–æ¶ˆæ›´â€œåŠæ—¶â€ã€‚
- UI æµ‹è¯•æ›´ç¨³å®šï¼ˆæ¡ä»¶ç­‰å¾… + `--uitesting` æ ‡å‡†çª—å£ï¼‰ï¼Œé¿å…å› çª—å£ç±»å‹/å›ºå®š sleep å¯¼è‡´çš„ flakyã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
  - Exact FTS æ”¯æŒ `bm25(clipboard_fts)` æ’åºï¼ˆRelevanceï¼‰ä¸æ—§çš„ Recent æ’åºã€‚
- `Scopy/Views/HeaderView.swift`
  - å¢åŠ  FTS æ’åºåˆ‡æ¢æŒ‰é’®ï¼ˆRelevance/Recentï¼‰ã€‚
- `Scopy/Observables/HistoryViewModel.swift`
  - è®°å½•å¹¶æŒä¹…åŒ– `ftsSortMode`ï¼ˆUserDefaultsï¼‰ï¼Œæ„é€  `SearchRequest.sortMode`ã€‚
- `Scopy/Domain/Models/SearchSortMode.swift`
  - æ–°å¢æœç´¢æ’åºæšä¸¾ï¼ˆä»…å½±å“ Exact/FTSï¼‰ã€‚
- `Scopy/Views/Settings/StorageSettingsPage.swift`
  - æ›´æ–°â€œå†…å®¹ä¼°ç®—ä¸Šé™â€æ–‡æ¡ˆè¯´æ˜ï¼ˆP3-1ï¼‰ã€‚
- `Scopy/Services/StorageService.swift`
  - `loadPayloadData(for:)` æ›¿ä»£è¯¯å¯¼æ€§å‘½åï¼ˆP3-2ï¼‰ã€‚
- `Scopy/Views/Settings/HotKeyRecorderView.swift`
  - ç›‘å¬ `SettingsStore` æ›´æ–°ï¼Œæ›¿ä»£å›ºå®š sleepï¼ˆP3-7ï¼‰ã€‚
- `Scopy/AppDelegate.swift`
  - `--uitesting` ä¸‹ä¸»ç•Œé¢ç”¨ `NSWindow` æ‰¿è½½ï¼Œæå‡ UI æµ‹è¯•ç¨³å®šæ€§ï¼ˆä¸å½±å“ç”Ÿäº§è¡Œä¸ºï¼‰ã€‚
- `ScopyTests/SearchServiceTests.swift`
  - æ–°å¢ FTS Relevanceï¼ˆbm25ï¼‰æ’åºå›å½’æµ‹è¯•ã€‚
- `ScopyUITests/*`
  - æ¡ä»¶ç­‰å¾…æ›¿ä»£å›ºå®š sleepï¼›ä½¿ç”¨ `History.SearchField`/`History.List` æ ‡è¯†ç¬¦å®šä½å…ƒç´ ã€‚

---

## ğŸ¯ æµ‹è¯•

- å•å…ƒæµ‹è¯•ï¼š`make test-unit`ï¼šExecuted 218 tests, 1 skipped, 0 failures
- UI æµ‹è¯•ï¼š`xcodebuild test -only-testing:ScopyUITests`ï¼šExecuted 25 tests, 4 skipped, 0 failures

