# v0.44.fix23

> 状态：✅

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Search：对 Exact 短词（≤2）与 Regex 的“仅搜索最近 2000 条（recent cache）”策略补齐显式 UI 提示，避免用户误以为“搜不到 = 不存在”。
- Fix/Dedup：移除自实现 SHA256，改用 `CryptoKit.SHA256.hash(data:)`；并补齐标准测试向量，确保哈希正确性进入 CI 门槛。

### Why

- 缓存只能作为加速手段；若把 cache 边界当成最终语义，会把“正确性”隐性限制在缓存覆盖范围内，造成产品不可信（P1-2）。
- 自实现密码学哈希缺少测试向量时，正确性难以保证；并且在大 payload 上容易引入不必要的拷贝/搬移路径（P2-1）。

### Result

- Search：行为保持性能策略不变，但语义变为“可解释”，并给出获得全量搜索的操作路径（Exact 输入 ≥3 / 切换 Fuzzy/Fuzzy+）。
- Hash：去重哈希改为系统实现，且用经典向量把输出锁定，降低性能与正确性风险。

---

## 🏗️ 实现路线

1. 在 `HistoryViewModel` 计算 `cacheLimitedSearchHint`：Exact ≤2 与 Regex 时给出提示文案。
2. 在 `HeaderView` 搜索框下渲染 hint（不改变搜索逻辑，仅提示语义）。
3. `ClipboardMonitor.computeHashStatic` 改用 `CryptoKit` 的 SHA256。
4. 为 SHA256 补齐经典测试向量（空串、`"abc"`、multi-block）。

---

## 📂 核心改动

- `Scopy/Observables/HistoryViewModel.swift`
  - 新增 `cacheLimitedSearchHint`（Exact ≤2 / Regex）作为显式语义提示。
- `Scopy/Views/HeaderView.swift`
  - 搜索框下显示 hint 文案（仅 UI，不改变行为）。
- `Scopy/Services/ClipboardMonitor.swift`
  - 用 `CryptoKit.SHA256` 替换自实现 SHA256。
- `ScopyTests/IntegrationTests.swift`
  - 新增 `SearchHintTests` 覆盖 hint 触发条件。
- `ScopyTests/ClipboardMonitorTests.swift`
  - 新增 `testSHA256HashVectors`（标准向量）。

---

## 🎯 关键指标

- 单元测试：`make test-unit`：Executed 211 tests, 1 skipped, 0 failures

---

## 📊 当前状态

- Exact ≤2 / Regex：UI 明确提示“仅搜索最近 2000 条”，并提示如何获得全量搜索。
- SHA256：输出与标准向量一致，去重哈希正确性进入回归测试。

---

## 🔮 遗留与后续

- 若后续希望对齐 v0.md “短词 prefilter + full refine”的直觉语义，可考虑为 Exact 短词引入渐进 refine（路线 A），以在保持首屏速度的同时最终可达全量历史。

