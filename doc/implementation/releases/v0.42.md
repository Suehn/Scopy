# v0.42 - Phase 7（准备）：引入本地 Swift Package `ScopyKit`（XcodeGen 接入）

**日期**: 2025-12-13

---

## 一页纸总结

### What

- **新增本地 SwiftPM 包 `ScopyKit`**：在仓库根目录 `Package.swift` 定义 `ScopyKit` library target（源码来自 `Scopy/`，排除 App/Presentation 相关文件）。
- **XcodeGen 集成**：`project.yml` 增加 `packages` 并让 App target 依赖 `ScopyKit`，让后续“抽包/强制边界”可以渐进落地。

### Why

- Phase 7 的目标是用编译器强制分层边界（App/Presentation 不再与 Domain/Infra/Application 同一 module），降低回归概率。
- 先把 SwiftPM 与工程接入固化为单独里程碑，可回滚、可复用，避免与后续大迁移耦合在一起。

### Result

- `xcodebuild` 会在构建/测试时解析本地 package（`Resolve Package Graph`），工程可正常编译与回归。
- **注意**：本版本仅完成“接入”，后续 v0.43 会把后端源码从 App target 移出并完成 public API 收口，真正实现强制边界。

---

## 核心实现

- `Package.swift`：
  - 定义 `ScopyKit` library + `ScopyKit` target（`path: "Scopy"`，排除 App/Presentation 相关文件）
  - 链接 `sqlite3`（用于持久化层）
- `project.yml`：
  - 增加本地 package 引用（`path: .`）
  - App target 增加对 `ScopyKit` product 的依赖
- `Scopy.xcodeproj/project.pbxproj`：
  - 由 `xcodegen generate` 生成并包含 package 配置

---

## 修改文件列表（核心）

- `Package.swift`
- `project.yml`
- `Scopy.xcodeproj/project.pbxproj`
- `DEPLOYMENT.md`
- `doc/profiles/v0.42-profile.md`
- `doc/profiles/README.md`
- `doc/implementation/releases/v0.42.md`
- `doc/implementation/README.md`
- `doc/implementation/CHANGELOG.md`
- `doc/reviews/review-v0.3.md`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- 性能测试：`make test-perf` **22 tests passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)
- Thread Sanitizer：`make test-tsan` **132 tests passed** (1 skipped)
- Strict Concurrency：`make test-strict` **166 tests passed** (7 skipped)

### 性能（Debug / `make test-perf` 单次运行）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 4.69ms
  - Fuzzy 10k items P95 ≈ 43.60ms（Samples: 50）
  - Disk 25k fuzzy P95 ≈ 56.61ms（Samples: 50）
  - Bulk insert 1000 items ≈ 51.70ms（≈19,342 items/s）
  - Fetch recent (50 items) avg ≈ 0.07ms
  - Regex 20k items P95 ≈ 3.11ms
  - Mixed content disk search（single run, after warmup）≈ 4.24ms

---

## 当前状态（快速检查）

- ✅ `make build`
- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- Phase 7（v0.43）：将 Domain/Infrastructure/Application/Services 从 App target 迁移到 `ScopyKit` module，并完成 public API 收口（UI 只依赖协议/DTO/用例门面）。

