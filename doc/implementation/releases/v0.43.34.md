# v0.43.34（Preview：单行短文本/矮图预览更贴合）

日期：2025-12-16

## 背景

在 hover 预览中，对于单行短文本与高度很小的图片，popover 仍会出现明显空白（高度/宽度未贴合内容）。

## 变更

### 1) 单行短文本：宽度/高度更贴合

- **宽度测量修复**：单行文本宽度改为使用 `NSString.size(withAttributes:)` 测量，避免 TextKit 的 `usedRect` 宽度退化为整行 fragment 宽度导致无法收缩。
- **更合理的最小尺寸**：
  - 最小宽度降低到 `ScopySize.unit * 40`（160pt），允许短文本更紧凑。
  - 最小高度改为 `max(44, lineHeight + padding*2)`，避免使用列表项高度导致单行文本预览过高。
- **滚动兜底**：保留少量 buffer，避免小内容因像素误差出现“仍需滚动一丁点”。

### 2) 矮图：高度更贴合

- 图片预览最小高度从 80pt 降为 `max(44, listItemHeight)`，减少矮图场景空白。
- 未加载到图片尺寸时的占位高度从 200pt 降为 120pt，降低加载阶段的跳变与空白。

## 测试

- 新增单测：`HoverPreviewTextSizingTests`（覆盖单行缩宽、多行保持最大宽度、行数影响高度）。
- Release 构建 + 定向单测通过。

## 修改文件

- `Scopy/Views/History/HoverPreviewTextSizing.swift`
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`
- `Scopy/Views/History/HistoryItemImagePreviewView.swift`
- `ScopyTests/HoverPreviewTextSizingTests.swift`
- `doc/implementation/README.md`
- `doc/implementation/CHANGELOG.md`

