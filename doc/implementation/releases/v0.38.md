# v0.38 - Phase 5 收口：DTO 去 UI 派生字段 + 展示缓存统一入口

**日期**: 2025-12-13

---

## 一页纸总结

### What

- `ClipboardItemDTO` 移除 UI-only 派生字段 `cachedTitle/cachedMetadata`，Domain 模型只保留“事实数据”。
- 新增 `ClipboardItemDisplayText`（Presentation）：为 `ClipboardItemDTO.title/metadata` 提供计算 + `NSCache` 缓存，保持列表渲染低开销。
- `HeaderView.AppFilterButton` 移除 View 内静态 LRU 缓存，统一改用 `IconService` 提供图标/名称缓存入口。

### Why

- Domain 模型携带 UI-only 派生字段会模糊边界，阻碍后续 Phase 7（抽 Swift Package）用编译器强制依赖方向。
- View 内静态缓存（锁 + LRU）会形成“隐形状态”，难以统一清理与度量。

### Result

- Domain ↔ Presentation 边界更干净：DTO 不再承载展示策略；UI 仍保留缓存加速路径（不回退 v0.21 的渲染性能优化）。
- 图标/名称缓存入口进一步收敛到 `IconService`，为后续继续拆分 `AppState` 与包边界做准备。

---

## 核心实现

### DTO 去派生字段

- `Scopy/Domain/Models/ClipboardItemDTO.swift`：
  - 删除 `cachedTitle/cachedMetadata` 存储字段与相关计算逻辑

### 展示缓存入口（Presentation）

- `Scopy/Presentation/ClipboardItemDisplayText.swift`：
  - `ClipboardItemDisplayText` 使用 `NSCache` 缓存 `title/metadata`
  - 通过 `extension ClipboardItemDTO` 提供 `title/metadata`（仅 Presentation 关心）

### AppFilterButton 去 View 内缓存

- `Scopy/Views/HeaderView.swift`：
  - 统一改为 `IconService.shared.icon/appName`

---

## 修改文件列表（核心）

- `Scopy/Domain/Models/ClipboardItemDTO.swift`
- `Scopy/Presentation/ClipboardItemDisplayText.swift`
- `Scopy/Views/HeaderView.swift`
- `Scopy.xcodeproj/project.pbxproj`（`xcodegen generate`）

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- 性能测试：`make test-perf` **22 tests passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)
- Thread Sanitizer：`make test-tsan` **132 tests passed** (1 skipped)

### 性能（Debug / `make test-perf` 单次运行）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 4.68ms
  - Fuzzy 10k items P95 ≈ 43.44ms
  - Disk 25k fuzzy P95 ≈ 56.15ms
  - Bulk insert 1000 items ≈ 82.69ms（≈12,094 items/s）
  - Fetch recent (50 items) avg ≈ 0.07ms
  - Regex 20k items P95 ≈ 3.02ms
  - Mixed content disk search（single run, after warmup）≈ 4.25ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ⏳ `/tmp/scopy_hotkey.log`（本版本不改热键；按 `AGENTS.md` 仍建议人工自查一次）

---

## 遗留与后续

- （可选）继续拆分 `AppState`（History/Settings ViewModel），缩小 Observation 半径（见 `doc/reviews/review-v0.3.md` Phase 5）。
- Strict Concurrency 渐进回归仍建议继续推进（Phase 6 待续）。
- Phase 7（可选）：抽成 Swift Package（强制边界）。

