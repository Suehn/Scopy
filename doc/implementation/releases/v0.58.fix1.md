# v0.58.fix1

> çŠ¶æ€ï¼šâœ…
> è¯´æ˜ï¼šPerf/Searchï¼š2 å­—çŸ­è¯ï¼ˆcm ç­‰ï¼‰è¿›ä¸€æ­¥æé€Ÿï¼›Correctnessï¼šçŸ­è¯ pinned å‘½ä¸­å›å½’æµ‹è¯•ã€‚

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Perf/Searchï¼šä¸º ASCII 1/2 å­—ç¬¦çŸ­è¯å¼•å…¥å†…å­˜ `ShortQueryIndex`ï¼ˆç¨€ç– postingsï¼šchar + bigramï¼‰ï¼Œç”¨äºå¿«é€Ÿå®šä½å€™é€‰æ¡ç›®ï¼ˆä¸æ¼é¡¹ï¼‰ã€‚
- Perf/Searchï¼šçŸ­è¯åŒ¹é…æ”¹ä¸ºâ€œå€™é€‰ + Swift UTF-8 bytes æ‰«æâ€è®¡ç®— matchPosï¼Œé¿å… SQLite `lower(...)`/`instr(...)` å…¨è¡¨æ‰«æçš„é«˜å¼€é”€ï¼ˆæ’åºè¯­ä¹‰ä¿æŒä¸€è‡´ï¼špinned ä¼˜å…ˆï¼Œrelevance æŒ‰ matchPos / lastUsedAtï¼‰ã€‚
- Infra/SQLiteï¼šæ–°å¢ `SQLiteStatement.columnTextBytes(_:)`ï¼Œç”¨äºé›¶æ‹·è´è¯»å– UTF-8 å­—èŠ‚å¹¶åšé«˜æ€§èƒ½æ‰«æã€‚
- Testï¼šæ–°å¢çŸ­è¯ pinned å‘½ä¸­å›å½’æµ‹è¯•ï¼Œç¡®ä¿æœç´¢çŠ¶æ€ä¸‹ pinned ä¸ä¼šâ€œæ¶ˆå¤±â€ã€‚

### Why

- ç”¨æˆ·çœŸå® 143MB å†å²åº“åœ¨ 2 å­—çŸ­è¯ï¼ˆå¦‚ `cm`ï¼‰ä¸‹ä»å¯èƒ½å‡ºç° 200ms+ å»¶è¿Ÿï¼Œæ˜æ˜¾åç¦»äº¤äº’é¢„æœŸï¼ˆå¸Œæœ› 10ms çº§ï¼‰ã€‚
- 2 å­—çŸ­è¯æ— æ³•ä¾èµ– trigram FTSï¼ˆtrigram ä»…å¯¹ â‰¥3 çš„ token æœ‰æ•ˆï¼‰ï¼Œéœ€è¦é’ˆå¯¹çŸ­è¯èµ°ä¸€æ¡â€œæ—¢å…¨é‡è¦†ç›–ã€åˆé«˜æ€§èƒ½â€çš„è·¯å¾„ã€‚

### Result

- çœŸå®æ€§èƒ½åŸºå‡†ï¼ˆrelease æ„å»ºï¼Œ`perf-db/clipboard.db` â‰ˆ 143MBï¼‰ï¼š
  - å†·å¯åŠ¨ï¼ˆ`--warmup 0 --iters 1`ï¼‰ï¼š
    - `fuzzyPlus + relevance + query=cm`ï¼š~52.41ms
    - `fuzzyPlus + relevance + forceFullFuzzy + query=cm`ï¼š~43.46ms
  - ç´¢å¼•å°±ç»ªåï¼ˆ`--warmup 20 --iters 30`ï¼‰ï¼š
    - `fuzzyPlus + relevance + query=cm`ï¼šavg 5.13msï¼ŒP95 5.45ms
    - `fuzzyPlus + relevance + forceFullFuzzy + query=cm`ï¼šavg 5.11msï¼ŒP95 5.71ms
    - `fuzzyPlus + relevance + query=cmd`ï¼šavg 0.09msï¼ŒP95 0.14ms

> æµ‹è¯•/åŸºå‡†å‰ç½®ï¼šå…ˆ `make snapshot-perf-db` ä» `~/Library/Application Support/Scopy/clipboard.db` æ‹·è´æœ€æ–°å¿«ç…§åˆ° `perf-db/clipboard.db`ï¼ˆæ–‡ä»¶ä¸æäº¤ï¼‰ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`ï¼ˆShortQueryIndex + çŸ­è¯å€™é€‰è·¯å¾„ + UTF-8 bytes æ‰«æï¼‰
- `Scopy/Infrastructure/Persistence/SQLiteConnection.swift`ï¼ˆ`columnTextBytes`ï¼‰
- `ScopyTests/SearchServiceTests.swift`ï¼ˆçŸ­è¯ pinned å›å½’æµ‹è¯•ï¼‰

---

## âœ… æµ‹è¯•

- `make build`ï¼šâœ…ï¼ˆ2026-01-11ï¼‰
- `make test-unit`ï¼šâœ…ï¼ˆ2026-01-11ï¼‰
- `make test-strict`ï¼šâœ…ï¼ˆ2026-01-11ï¼‰
- `make snapshot-perf-db` + `.build/release/ScopyBench ...`ï¼šâœ…ï¼ˆè§ä¸Šæ–¹ Resultï¼‰

