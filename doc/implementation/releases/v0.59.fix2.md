# v0.59.fix2

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Tooling/Testï¼šä¿®å¤ `make test*` pipeline å‡ç»¿ï¼ˆ`pipefail`ï¼‰ã€‚
- Fix/Swift Concurrencyï¼šæ”¶æ•› Swift 6 Strict Concurrency é˜»å¡çº§å‘Šè­¦ï¼ˆMarkdown/WKWebView é¢„è§ˆä¸å¯¼å‡ºè·¯å¾„ MainActor/Sendable è¯­ä¹‰è¡¥é½ï¼‰ã€‚
- Fix/TSanï¼šä¿®å¤ TSan æµ‹è¯• data race å¹¶æå‡ç¨³å®šæ€§ï¼ˆè½®è¯¢ helper MainActor åŒ–ï¼›TSan ä¸‹æ”¾å®½ä¸€å¤„æ€§èƒ½æ–­è¨€ï¼‰ã€‚
- Fix/AVFoundationï¼šæ›¿æ¢å¼ƒç”¨çš„åŒæ­¥ track å±æ€§è®¿é—®ï¼Œæ”¹ä¸ºå¼‚æ­¥ `loadTracks`/`load` ä»¥å…¼å®¹æ–°ç‰ˆ SDKã€‚
- Docs/Reviewï¼šè¡¥å……ä¸€ä»½å®ç°å®¡è®¡è®°å½•ä¸éªŒè¯ç»“æœã€‚

### Why

- `xcodebuild â€¦ | tee â€¦` é»˜è®¤ä¸ä¼šæŠŠå¤±è´¥ä¼ é€’ç»™ makeï¼Œå®¹æ˜“å¯¼è‡´ CI/æœ¬åœ°è¯¯åˆ¤â€œé€šè¿‡â€ã€‚
- Swift 6 ä¸¥æ ¼å¹¶å‘ä¸æ–°ç‰ˆ SDK å¯¹ Sendable/ä¸»çº¿ç¨‹éš”ç¦»æ›´ä¸¥æ ¼ï¼Œé˜»å¡çº§è¯Šæ–­ä¼šè®©æœªæ¥å‡çº§/ç¼–è¯‘ç›´æ¥å¤±è´¥ã€‚
- TSan å›å½’æ˜¯ç¨³å®šæ€§é—¨æ§›ï¼Œæµ‹è¯•ä¸­ data race ä¼šå¯¼è‡´å‡çº¢ä¸æ©ç›–çœŸå®é—®é¢˜ã€‚
- AVFoundation æ–° SDK ä¸­åŒæ­¥å±æ€§è®¿é—®å·²å¼ƒç”¨/é™åˆ¶ï¼›å¼‚æ­¥åŠ è½½æ›´ç¬¦åˆä¸»çº¿ç¨‹å«ç”Ÿï¼Œé¿å…æ½œåœ¨å¡é¡¿ã€‚

### Result

- æœ¬åœ°éªŒè¯ï¼ˆmacOS 26.3ï¼›Xcode 26.2ï¼›2026-01-27ï¼‰ï¼š
  - `make build` âœ…
  - `make test-unit` âœ…ï¼ˆExecuted 266 tests, 1 skipped, 0 failuresï¼‰
  - `make test-strict` âœ…ï¼ˆExecuted 266 tests, 1 skipped, 0 failuresï¼‰
  - `make test-tsan` âœ…ï¼ˆExecuted 256 tests, 1 skipped, 0 failuresï¼‰

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. Makefile æ‰€æœ‰ `xcodebuild | tee` ç›®æ ‡ç»Ÿä¸€åŠ  `pipefail`ï¼Œä¿è¯å¤±è´¥å¯ä¼ æ’­ã€‚
2. æ”¶æ•› WKWebView/å¯¼å‡ºé“¾è·¯çš„ actor è¾¹ç•Œï¼šUI/Delegate èµ° MainActorï¼›è·¨å¹¶å‘è¾¹ç•Œçš„æ•°æ®æ¡¥æ¥æ”¹ä¸ºç±»å‹å®‰å…¨/Sendable æ–¹æ¡ˆã€‚
3. ä¿®å¤ TSan æµ‹è¯•è½®è¯¢çš„å¹¶å‘è®¿é—®ï¼šç»Ÿä¸€åœ¨ MainActor è¯»å†™ UI stateï¼›TSan ä¸“ç”¨å®ä¸‹æ”¾å®½ä¸ç¨³å®šçš„ timing æ–­è¨€ã€‚
4. è¿ç§» AVFoundation deprecated APIï¼šæ”¹ç”¨ `loadTracks(withMediaType:)` ä¸ `track.load(...)` å¼‚æ­¥è¯»å–å°ºå¯¸/transformã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Makefile`
- `Scopy/Views/History/MarkdownPreviewWebView.swift`
- `Scopy/Views/History/MarkdownExportService.swift`
- `Scopy/Views/History/MarkdownPreviewCache.swift`
- `Scopy/Utilities/FilePreviewSupport.swift`
- `ScopyTests/Helpers/XCTestExtensions.swift`
- `ScopyTests/SearchServiceTests.swift`
- `doc/reviews/code-audit-2026-01-26.md`

---

## ğŸ¯ å…³é”®æŒ‡æ ‡

- `make test-unit`ï¼šExecuted 266 tests, 1 skipped, 0 failuresï¼ˆ2026-01-27ï¼‰
- `make test-strict`ï¼šExecuted 266 tests, 1 skipped, 0 failuresï¼ˆ2026-01-27ï¼‰
- `make test-tsan`ï¼šExecuted 256 tests, 1 skipped, 0 failuresï¼ˆ2026-01-27ï¼‰

---

## ğŸ“Š å½“å‰çŠ¶æ€

- æ„å»ºï¼š`make build` âœ…ï¼ˆ2026-01-27ï¼‰
- å•æµ‹ï¼š`make test-unit` âœ…ï¼ˆExecuted 266 tests, 1 skipped, 0 failuresï¼Œ2026-01-27ï¼‰
- Strict Concurrencyï¼š`make test-strict` âœ…ï¼ˆExecuted 266 tests, 1 skipped, 0 failuresï¼Œ2026-01-27ï¼‰
- TSanï¼š`make test-tsan` âœ…ï¼ˆExecuted 256 tests, 1 skipped, 0 failuresï¼Œ2026-01-27ï¼‰

---

## ğŸ”® åç»­ TODO

- [ ] æ–°å¢æ›´è´´è¿‘çœŸå®åœºæ™¯çš„å¹¶å‘/å–æ¶ˆ/é‡å…¥å›å½’æµ‹è¯•ï¼ˆä¸å¼•å…¥è¯­ä¹‰å˜åŒ–ï¼‰ã€‚
- [ ] è¯„ä¼°å¼•å…¥ Swift Testingï¼ˆä¿æŒ XCTest ä¸ºé»˜è®¤è·‘æ³•ï¼Œé¿å… CI é£é™©ï¼‰ã€‚

