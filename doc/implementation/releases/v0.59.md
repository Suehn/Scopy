# v0.59

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Perf/Searchï¼šæ–°å¢ fullIndex **ç£ç›˜å†·å¯åŠ¨ç¼“å­˜**ï¼ˆbest-effortï¼‰+ prefilter å‘½ä¸­æ—¶ **åå°é¢„çƒ­ fullIndex**ï¼Œæ˜¾è‘—é™ä½â€œå†·å¯åŠ¨é¦–æ¬¡ refineï¼ˆforceFullFuzzy=trueï¼‰â€çš„ç­‰å¾…æ—¶é—´ã€‚
- Perf/Searchï¼šæ”¶å£å¤šå¤„ä½é£é™©çƒ­è·¯å¾„å¼€é”€ï¼ˆquery é¢„å¤„ç†ã€ASCII postings å¿«è·¯å¾„ã€statement cache LRUã€å›ºå®š SQL shape ç­‰ï¼‰ï¼Œä¸æ”¹å˜æœç´¢è¯­ä¹‰ï¼ˆä¸æ¼é¡¹ï¼‰ä¸æ’åºè§„åˆ™ã€‚
- Tooling/Testï¼šæ–°å¢ **çœŸå® DB å¯¹ç…§å›å½’**ï¼ˆprefilter+prewarm vs cold refineï¼›disk cache vs rebuildï¼‰ä¸ `make test-real-db`ã€‚

### Why

- v0.58 ç³»åˆ—å¼•å…¥æ¸è¿›å¼å…¨é‡æ ¡å‡†åï¼Œé•¿æ–‡æœ¬å¤§åº“çš„é¦–å±äº¤äº’å·²ç»å¾ˆå¿«ï¼›ä½†åœ¨çœŸå® 143MB+ DB ä¸‹ï¼Œå†·å¯åŠ¨ç¬¬ä¸€æ¬¡ refine ä»å¯èƒ½è§¦å‘ fullIndex æ„å»ºï¼Œå‡ºç° **2s+** çš„â€œé¦–æ¬¡å…¨é‡æ‰«æâ€ç­‰å¾…ã€‚
- ç›®æ ‡æ˜¯åœ¨ **ä¸å‡å°‘æœç´¢èŒƒå›´/ä¸æ”¹å˜æ’åºè¯­ä¹‰** çš„å‰æä¸‹ï¼ŒæŠŠâ€œé¦–æ¬¡ refineâ€æ‹‰å›åˆ°å‡ åæ¯«ç§’çº§ï¼Œå¹¶æä¾›å¯å¤ç°çš„å¯¹ç…§å›å½’éªŒè¯ã€‚

### Result

- çœŸå® DBï¼ˆ`~/Library/Application Support/Scopy/clipboard.db` â‰ˆ 148.6MBï¼Œ2026-01-13ï¼›`make test-real-db` è¾“å‡ºï¼ŒDEBUG æµ‹è¯•æ„å»ºï¼‰ï¼š
  - prefilterï¼ˆFTSï¼ŒisPrefilter=trueï¼‰ï¼š~**1.30ms**
  - prefilter + åå°é¢„çƒ­å refineï¼š~**16.33ms**
  - å†·å¯åŠ¨ç›´æ¥ refineï¼ˆæ— é¢„çƒ­ï¼‰ï¼š~**2305.90ms**
  - ç£ç›˜ç¼“å­˜åŠ è½½ refineï¼š~**861.03ms**
  - ç£ç›˜ç¼“å­˜æ–‡ä»¶ï¼š`clipboard.db.fullindex.v2.plist` â‰ˆ **38.8MB**
- çœŸå®å¿«ç…§åº“ï¼ˆ`perf-db/clipboard.db` â‰ˆ 148.6MBï¼›release `ScopyBench`ï¼Œwarmup 20 / iters 30ï¼›`make bench-snapshot-search`ï¼‰ï¼š
  - `fuzzyPlus + relevance + query=cm`ï¼šavg **4.89ms**ï¼ŒP95 **5.43ms**
  - `fuzzyPlus + relevance + query=æ•°å­¦`ï¼šavg **9.40ms**ï¼ŒP95 **11.82ms**
  - `fuzzyPlus + relevance + query=cmd`ï¼šavg **0.10ms**ï¼ŒP95 **0.11ms**
  - `fuzzyPlus + relevance + forceFullFuzzy + query=cm`ï¼šavg **5.15ms**ï¼ŒP95 **5.42ms**
  - `fuzzy + relevance + forceFullFuzzy + query=abc`ï¼šavg **2.36ms**ï¼ŒP95 **2.51ms**
  - `fuzzy + relevance + forceFullFuzzy + query=cmd`ï¼šavg **2.61ms**ï¼ŒP95 **2.64ms**

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. fullIndex æ”¯æŒç£ç›˜å¿«ç…§ï¼ˆbinary plistï¼‰ï¼šå†™å…¥æ—¶å¸¦ä¸Š DB/WAL æ–‡ä»¶ fingerprintï¼Œè¯»å–æ—¶æ ¡éªŒ fingerprint ä¸åŒ¹é…åˆ™ç›´æ¥æ”¾å¼ƒï¼ˆä¿è¯å‡†ç¡®æ€§ä¼˜å…ˆï¼‰ã€‚
2. prefilter å‘½ä¸­ï¼ˆé•¿æ–‡æœ¬å¤§åº“ï¼‰æ—¶åå°å¯åŠ¨ fullIndex buildï¼ˆä¼˜å…ˆå°è¯•ç£ç›˜å¿«ç…§ï¼›å¦åˆ™ä» DB æ„å»ºï¼‰ï¼Œè®©é¦–æ¬¡ refine ä¸å†æ‰¿æ‹…å†·æ„å»ºæˆæœ¬ã€‚
3. fullIndex è¿è¡Œä¸­ä¿æŒå¯ç”¨ï¼šå¯¹ upsert/pin/delete å¢é‡åº”ç”¨ï¼›å¯¹æ–‡æœ¬å˜åŒ–é‡‡ç”¨ tombstone + append ç­–ç•¥ï¼Œé¿å…æ˜‚è´µçš„ postings ç§»é™¤ï¼ŒåŒæ—¶ä¿è¯ä¸æ¼é¡¹ã€‚
4. å¢é‡ä¼˜åŒ–ä¸çƒ­è·¯å¾„æ”¶æ•›ï¼šquery é¢„å¤„ç†ã€postings å¿«è·¯å¾„ã€å›ºå®š SQL shapeï¼ˆ`json_each` ä¿åºï¼‰ã€statement cache LRUã€recent cache å¤ç”¨ lowercased ç­‰ã€‚
5. å¢åŠ çœŸå® DB å¯¹ç…§å›å½’ï¼šéªŒè¯â€œprefilter+prewarm çš„ refineâ€ä¸â€œå†·å¯åŠ¨ç›´æ¥ refineâ€ç»“æœé›†åˆ + æ’åºä¸€è‡´ï¼›éªŒè¯ç£ç›˜ç¼“å­˜åŠ è½½ä¸é‡å»ºç»“æœä¸€è‡´ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
  - fullIndexï¼šç£ç›˜ç¼“å­˜ï¼ˆv2ï¼‰+ prefilter åå°é¢„çƒ­ + å¢é‡æ›´æ–°ï¼ˆtombstoneï¼‰
  - çƒ­è·¯å¾„ï¼šquery é¢„å¤„ç†ã€ASCII postings å¿«è·¯å¾„ã€LRU statement cacheã€`json_each` ä¿åº fetch
- `ScopyTests/RealDatabaseRegressionTests.swift`
  - æ–°å¢çœŸå® DB å¯¹ç…§å›å½’ï¼ˆä»…åœ¨ `-DSCOPY_REAL_DB_TESTS` ä¸‹å¯ç”¨ï¼‰
- `ScopyTests/SearchServiceTests.swift`
  - è¡¥å……çŸ­è¯/æ··åˆå­—ç¬¦/å¢é‡æ›´æ–°ç›¸å…³å›å½’è¦†ç›–
- `Makefile`
  - æ–°å¢ `make test-real-db`

---

## ğŸ“Š å½“å‰çŠ¶æ€

- æ„å»ºï¼š`make build` âœ…ï¼ˆ2026-01-13ï¼‰
- å•æµ‹ï¼š`make test-unit` âœ…ï¼ˆExecuted 259 tests, 1 skipped, 0 failuresï¼Œ2026-01-13ï¼‰
- Strict Concurrencyï¼š`make test-strict` âœ…ï¼ˆExecuted 259 tests, 1 skipped, 0 failuresï¼Œ2026-01-13ï¼‰
- çœŸå®æ€§èƒ½åŸºå‡†ï¼š`make bench-snapshot-search` âœ…ï¼ˆè§ä¸Šæ–¹ Resultï¼Œ2026-01-13ï¼‰
- çœŸå® DB å¯¹ç…§å›å½’ï¼š`make test-real-db` âœ…ï¼ˆExecuted 2 tests, 0 failuresï¼Œ2026-01-13ï¼‰

---

## ğŸ”® é—ç•™ä¸åç»­

- ç£ç›˜ç¼“å­˜åŠ è½½ï¼ˆ~861msï¼‰ä»æ˜¾è‘—æ…¢äºâ€œé¢„çƒ­åå†…å­˜ refineâ€ï¼ˆ~16msï¼‰ï¼›å¦‚è¦ç»§ç»­å‹ç¼©å†·å¯åŠ¨ refineï¼Œå¯è€ƒè™‘æ›´ç´§å‡‘çš„è‡ªå®šä¹‰äºŒè¿›åˆ¶æ ¼å¼ + mmapï¼ˆä»…ä¼˜åŒ–åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œä¸æ”¹è¯­ä¹‰ï¼‰ã€‚
- å½“å‰ç£ç›˜ç¼“å­˜ä¸º best-effortï¼ˆå¤±è´¥ä¸å½±å“åŠŸèƒ½ï¼‰ï¼›è‹¥è¦è®©ç¼“å­˜æ›´â€œæ–°â€ï¼Œéœ€è¦å¼•å…¥æ›´ç»†çš„å†™å…¥èŠ‚æµ/åˆå¹¶ç­–ç•¥ï¼ˆé¿å…é¢‘ç¹å†™å…¥ 40MB çº§æ–‡ä»¶ï¼‰ã€‚
