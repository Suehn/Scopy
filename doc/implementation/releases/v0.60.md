# v0.60

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Refactor/Settingsï¼šè®¾ç½®ä¿å­˜æ”¹ä¸ºâ€œå­—æ®µçº§ patch merge åˆ° latestâ€ï¼Œé¿å…å¹¶å‘æ›´æ–°æ—¶è¢«æ—§å¿«ç…§è¦†ç›–ï¼ˆhotkey ä»ä¿æŒâ€œå½•åˆ¶åç«‹å³ç”Ÿæ•ˆ + ç‹¬ç«‹æŒä¹…åŒ–â€è¯­ä¹‰ï¼‰ã€‚
- Fix/Settingsï¼š`æ¢å¤é»˜è®¤` ä¸å†åˆ¶é€ â€œçƒ­é”® UI çœ‹ä¼¼é‡ç½®ä½†å®é™…æœªæŒä¹…åŒ–â€çš„ä¸ä¸€è‡´ï¼ˆReset ä¼šä¿ç•™å½“å‰ hotkeyï¼‰ã€‚
- Fix/Storageï¼šåˆ é™¤è·¯å¾„æ”¹ä¸º DB-firstï¼ˆDB åˆ é™¤æˆåŠŸåå† best-effort åˆ é™¤å¤–éƒ¨æ–‡ä»¶ï¼‰ï¼›æ‰¹é‡åˆ é™¤ä½¿ç”¨æœ‰ç•Œå¹¶å‘ï¼Œé™ä½ I/O é£æš´ä¸ä¸»çº¿ç¨‹å¡é¡¿é£é™©ã€‚
- Fix/Storageï¼šå¼ºåŒ– `storageRef` æ ¡éªŒï¼ˆæ‹’ç»è¶Šç•Œ/ç›®å½•/è½¯é“¾æ¥ï¼‰ï¼Œå¹¶è®©å•æ¡åˆ é™¤çš„ `storageRef` è¯»å–ä¸è¡Œåˆ é™¤åœ¨åŒä¸€ DB äº‹åŠ¡ä¸­å®Œæˆï¼Œå‡å°‘æç«¯ç«æ€å­¤å„¿æ–‡ä»¶çª—å£ã€‚
- Fix/HotKeyï¼š`currentHotKeyID` lock-isolatedï¼Œé¿å…æ½œåœ¨ data race/é”é¡ºåºé—®é¢˜ã€‚
- Fix/Concurrencyï¼šç§»é™¤ `nonisolated(unsafe)` timer å­˜å‚¨çƒ­ç‚¹ï¼Œæ”¹ä¸ºæ˜¾å¼é”ç›’å­æ‰˜ç®¡ï¼ˆæ›´æ˜“é€šè¿‡ Strict Concurrency/TSanï¼‰ã€‚
- Tooling/CIï¼šæ–°å¢ CIï¼ˆbuild + unit + strictï¼‰ï¼Œå¹¶å¯¹é½ `project.yml` çš„ Xcode åŸºçº¿ä¸º 16.0ã€‚

### Why

- Settings å±äºé«˜é¢‘è¯»å†™çš„å…±äº«çŠ¶æ€ï¼šHeader çš„ searchMode æŒä¹…åŒ–ã€è®¾ç½®é¡µ Save/Cancel äº‹åŠ¡ã€çƒ­é”®å½•åˆ¶â€œç«‹å³åº”ç”¨â€ç­‰è·¯å¾„å¤©ç„¶å­˜åœ¨å¹¶å‘äº¤é”™ï¼›å…¨é‡è¦†ç›–å†™ä¼šå¯¼è‡´ç”¨æˆ·è®¾ç½®è¢«â€œæ‚„æ‚„å†™å›æ—§å€¼â€ã€‚
- Storage åˆ é™¤æ˜¯â€œä¸¤é˜¶æ®µå‰¯ä½œç”¨â€ï¼ˆDB è¡Œ + æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼šå¿…é¡»ä»¥ DB ä¸ºå‡†ï¼Œé¿å… DB å¤±è´¥æ—¶è¯¯åˆ æ–‡ä»¶ã€æˆ–å¤–éƒ¨è·¯å¾„è¢«åˆ©ç”¨é€ æˆè¶Šç•Œåˆ é™¤ã€‚
- Swift 6 Strict Concurrency/TSan ä¼šæŠŠéšè—çš„ data race/ä¸å®‰å…¨éš”ç¦»æ”¾å¤§ä¸ºä¸ç¨³å®šæˆ–é˜»å¡è¯Šæ–­ï¼šä¼˜å…ˆæŠŠå¹¶å‘è¾¹ç•Œå˜å¾—å¯è¯æ˜ã€‚

### Result

- ç”¨æˆ·æ— æ„Ÿï¼šåŠŸèƒ½/è¡¨ç°ä¿æŒä¸€è‡´ï¼ˆä»…ä¿®å¤å¹¶å‘ä¸€è‡´æ€§ä¸åˆ é™¤å®‰å…¨æ€§è¾¹ç•Œï¼‰ã€‚
- æœ¬åœ°éªŒè¯ï¼ˆ2026-01-30ï¼‰ï¼š
  - `make build` âœ…
  - `make test-unit` âœ…ï¼ˆExecuted 276 tests, 1 skipped, 0 failuresï¼‰
  - `make test-strict` âœ…ï¼ˆExecuted 276 tests, 1 skipped, 0 failuresï¼‰
  - `make test-tsan` âœ…ï¼ˆExecuted 266 tests, 1 skipped, 0 failuresï¼‰
  - `make test-perf` âœ…ï¼ˆExecuted 25 tests, 7 skipped, 0 failuresï¼‰
- æ€§èƒ½æœªå›é€€ï¼ˆ`make test-perf` æ‘˜è¦ï¼Œ2026-01-30ï¼‰ï¼š
  - 5kï¼ˆfuzzyPlusï¼‰ï¼šP95 4.97msï¼›cold 83.70ms
  - 10kï¼ˆfuzzyPlusï¼‰ï¼šP95 25.50msï¼›cold 197.48ms
  - Disk 25kï¼ˆfuzzyPlusï¼‰ï¼šP95 57.50msï¼›cold 822.94ms
  - Service Disk 10kï¼ˆfuzzyPlusï¼‰ï¼šP95 22.26msï¼›cold 296.63ms

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. Settingsï¼šå¼•å…¥ `SettingsPatch`ï¼ˆå­—æ®µçº§ diffï¼‰ï¼ŒSave æ—¶æŠŠ patch merge åˆ°æœ€æ–°æŒä¹…åŒ– settings åå†å†™å›ã€‚
2. Settingsï¼šæŠŠâ€œçƒ­é”®å½•åˆ¶â€ä»äº‹åŠ¡ä¿å­˜é‡Œå‰¥ç¦»ï¼ˆä¿æŒå³æ—¶ç”Ÿæ•ˆ + ç‹¬ç«‹æŒä¹…åŒ–ï¼‰ï¼Œå¹¶ä¿®å¤ Reset çš„ UI/æŒä¹…åŒ–ä¸ä¸€è‡´ã€‚
3. Storageï¼šç»Ÿä¸€ DB-first åˆ é™¤è¯­ä¹‰ï¼Œè¡¥é½è·¯å¾„æ ¡éªŒï¼›æ‰¹é‡æ–‡ä»¶åˆ é™¤æ”¹ä¸ºæœ‰ç•Œå¹¶å‘ã€‚
4. HotKey/Concurrencyï¼šæ”¶æ•›é”ä¸éš”ç¦»è¾¹ç•Œï¼Œå»æ‰ `nonisolated(unsafe)` çƒ­ç‚¹ã€‚
5. Toolingï¼šè¡¥ CI è¦†ç›–ï¼Œå›ºå®š Xcode åŸºçº¿ï¼Œç¡®ä¿å›å½’å°½æ—©æš´éœ²ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Domain/Models/SettingsPatch.swift`
- `Scopy/Domain/Models/SettingsDTO+Patch.swift`
- `Scopy/Views/Settings/SettingsView.swift`
- `Scopy/Observables/SettingsViewModel.swift`
- `Scopy/Views/HeaderView.swift`
- `Scopy/Views/Settings/HotKeyRecorderView.swift`
- `Scopy/Services/StorageService.swift`
- `Scopy/Infrastructure/Persistence/SQLiteClipboardRepository.swift`
- `Scopy/Services/HotKeyService.swift`
- `Scopy/Views/History/MarkdownPreviewWebView.swift`
- `Scopy/Views/Settings/SettingsWindowCoordinator.swift`
- `Scopy/AppDelegate.swift`
- `.github/workflows/ci.yml`
- `project.yml`
- `ScopyTests/SettingsConcurrencyMergeTests.swift`
- `ScopyTests/StorageServiceTests.swift`
- `ScopyTests/ReviewFix24Tests.swift`

---

## ğŸ“Š å½“å‰çŠ¶æ€

- æ„å»ºï¼š`make build` âœ…ï¼ˆ2026-01-30ï¼‰
- å•æµ‹ï¼š`make test-unit` âœ…ï¼ˆExecuted 276 tests, 1 skipped, 0 failuresï¼Œ2026-01-30ï¼‰
- Strict Concurrencyï¼š`make test-strict` âœ…ï¼ˆExecuted 276 tests, 1 skipped, 0 failuresï¼Œ2026-01-30ï¼‰
- TSanï¼š`make test-tsan` âœ…ï¼ˆExecuted 266 tests, 1 skipped, 0 failuresï¼Œ2026-01-30ï¼‰
- Perfï¼š`make test-perf` âœ…ï¼ˆExecuted 25 tests, 7 skipped, 0 failuresï¼Œ2026-01-30ï¼‰

---

## ğŸ”® é—ç•™ä¸åç»­

- Storageï¼šå°† `validatedExternalFileURLs` çš„æ–‡ä»¶ç³»ç»Ÿæ ¡éªŒç§»åŠ¨åˆ°åå°ï¼ˆå‡å°‘ `@MainActor` I/O çš„å°¾å»¶è¿ŸæŠ–åŠ¨ï¼‰ã€‚
- HotKeyï¼šå¯é€‰æŠŠ `hotKeyRef` ä¸ `currentHotKeyID` åˆå¹¶ä¸ºåŒä¸€æŠŠé”çš„å®ä¾‹çŠ¶æ€ï¼Œè¿›ä¸€æ­¥å‡å°‘éšå«çº¿ç¨‹å‡è®¾ã€‚
