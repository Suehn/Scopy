# v0.19 - 代码深度审查修复

**日期**: 2025-12-04

---

## 📌 一页纸总结

**What**: 基于深度代码审查，修复 11 个稳定性、性能、内存安全和功能准确性问题

**Why**: 代码审查发现多个潜在问题：内存泄漏风险、主线程阻塞、功能实现不完整、代码重复

**Result**:
- 内存优化：SearchService 缓存从潜在 200MB 降至 ~10MB
- 图片指纹内存：从 33MB 降至 4KB (减少 99.99%)
- 修复 cleanupByAge 孤立文件泄漏
- 修复主线程阻塞问题
- 实现真正的模糊搜索
- 消除代码重复，统一错误处理

---

## 🏗️ 实现路线

### 高优先级修复 (5个)

1. **#1 SearchService 缓存内存问题**
   - 问题：缓存 2000 条 StoredItem，每条可能含 100KB rawData
   - 修复：缓存时去除 rawData，只保留搜索所需元数据

2. **#2 cleanupByAge 不清理外部文件**
   - 问题：按时间清理只删除数据库记录，不删除外部文件
   - 修复：重写方法，先查询 storage_ref，再并发删除文件

3. **#3 cleanupOrphanedFiles 主线程阻塞**
   - 问题：在 @MainActor 上下文中调用 group.wait()
   - 修复：将文件删除移到后台线程执行

4. **#4 图片去重逻辑矛盾**
   - 问题：计算轻量指纹后又强制用 SHA256，浪费 CPU
   - 修复：统一使用 SHA256，移除无用的轻量指纹计算

5. **#5 stop() 等待逻辑错误**
   - 问题：isCancelled 只表示请求取消，不表示任务完成
   - 修复：先停止监控使 stream 结束，再取消任务

### 中优先级修复 (3个)

6. **#6 图片指纹分配过多内存**
   - 问题：为提取 4x4 像素创建完整尺寸 CGContext (4K 图片 33MB)
   - 修复：使用 32x32 缩略图计算哈希，仅 4KB 内存

7. **#7 缩略图生成缺少 autoreleasepool**
   - 问题：多个 NSImage/NSBitmapImageRep 对象未及时释放
   - 修复：包装在 autoreleasepool 中管理中间对象

8. **#8 模糊搜索不准确**
   - 问题：长查询使用 FTS5 前缀匹配，"hlo" 无法匹配 "Hello"
   - 修复：所有模糊搜索都使用真正的字符顺序匹配

### 低优先级修复 (3个)

9. **#11-12 代码重复**
   - 问题：parseItem 和 SQLITE_TRANSIENT 在两个文件中重复定义
   - 修复：新建 SQLiteHelpers.swift，提取共享代码

10. **#13 错误处理不一致**
    - 问题：多处使用 try? 静默忽略错误
    - 修复：改为 do-catch 并添加日志

11. **#15 search() 频繁清除缓存**
    - 问题：每次新搜索都清除缓存，导致频繁刷新
    - 修复：移除搜索时的缓存清除，只在数据变更时失效

---

## 📂 核心改动

### 新增文件
| 文件 | 用途 |
|------|------|
| `Scopy/Services/SQLiteHelpers.swift` | 共享 SQLite 工具函数 |

### 修改文件
| 文件 | 改动 |
|------|------|
| `StorageService.swift` | #2 cleanupByAge, #3 cleanupOrphanedFiles, #7 autoreleasepool, #13 错误日志 |
| `SearchService.swift` | #1 缓存去除 rawData, #8 真正模糊搜索, #11-12 使用共享代码 |
| `ClipboardMonitor.swift` | #4 统一 SHA256, #6 缩略图计算哈希 |
| `RealClipboardService.swift` | #5 stop() 逻辑, #13 错误日志, #15 移除搜索缓存清除 |

---

## 🎯 关键指标

### 内存优化
| 指标 | 修复前 | 修复后 | 改善 |
|------|--------|--------|------|
| SearchService 缓存 (最坏情况) | ~200MB | ~10MB | **-95%** |
| 图片指纹计算 (4K 图片) | 33MB | 4KB | **-99.99%** |

### 功能修复
| 问题 | 状态 |
|------|------|
| cleanupByAge 孤立文件 | ✅ 修复 |
| 主线程阻塞 | ✅ 修复 |
| 图片去重逻辑 | ✅ 统一 |
| 模糊搜索准确性 | ✅ 修复 |

### 测试结果
```
Executed 161 tests, with 1 test skipped and 0 failures
** TEST SUCCEEDED **
```

---

## 📊 当前状态

| 项目 | 状态 |
|------|------|
| 单元测试 | 161/161 passed (1 skipped) |
| 构建 | Debug ✅ |
| 高优先级问题 | 5/5 ✅ |
| 中优先级问题 | 3/3 ✅ |
| 低优先级问题 | 3/3 ✅ |

---

## 🔮 遗留与后续

### 已完成
- 所有 11 个审查问题已修复

### 可选优化 (未实施)
- #9 异步文件删除等待完成 - 需要更大重构
- #10 Task.detached 复制大数据 - 需要引用类型包装
- #14 validateStorageRef 对新文件验证 - 低风险

### 建议后续
1. 考虑添加更多内存压力测试
2. 监控生产环境的内存使用情况
3. 定期进行代码审查
