# v0.44.fix10

## 📌 一页纸总结（What / Why / Result）

### What

- UX/Preview：针对 hover Markdown/LaTeX 预览的滚动条与宽度稳定性做“彻底收口”，消除不必要的横向滚动条，并让竖向滚动条 idle 时可靠隐藏。

### Why

- v0.44.fix9 后仍可能出现两类体验问题：
  - **不必要的横向滚动条**：KaTeX display、代码块、表格等在 HTML 内部是 `overflow-x:auto` 容器；当系统设置为“总是显示滚动条”时，这些容器会在没有实际滚动操作时也显示横向滚动条（视觉噪音）。
  - **竖向滚动条不隐藏**：部分 WKWebView 场景下，`NSScrollView.didLiveScrollNotification` 并不稳定触发，导致基于该通知的 scroller hide/show 方案不可靠。
  - **宽度 reflow 抖动**：Markdown 预览若先按最大宽度测量再缩窄展示，可能触发 reflow 产生横向溢出，进而出现横条。

### Result

- HTML 内部滚动条：默认隐藏，滚动时短暂显示（不影响滚动能力）。
- 外层 NSScrollView 滚动条：通过 `contentView` bounds 变化监听实现 show/hide，覆盖 WKWebView 的实际滚动路径，idle 时可靠隐藏。
- Markdown 预览宽度：展示宽度固定为屏幕自适应上限，避免缩窄后 reflow 触发横向溢出。

---

## 📂 核心改动

- `Scopy/Views/History/MarkdownHTMLRenderer.swift`
  - CSS：对 `pre/table/.katex-display` 的 `::-webkit-scrollbar` 做默认隐藏；滚动时由 JS 临时放开。
  - JS：捕获 `scroll`（capture）与 `wheel`，为 `<html>` 临时加 `scopy-scrollbars-visible` class（700ms 无滚动后移除）。
- `Scopy/Views/History/MarkdownPreviewWebView.swift`
  - `ScrollbarAutoHider` 改为监听 `NSView.boundsDidChangeNotification`（`contentView.postsBoundsChangedNotifications = true`），替代 `didLiveScroll`/`didEndLiveScroll`，使竖向滚动条 idle-hide 在 WKWebView 下更可靠。
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`
  - Markdown/LaTeX 预览宽度固定使用当前屏幕上限（与预测量宽度一致），避免 reflow 造成横向溢出与滚动条抖动。

---

## ✅ 测试

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`：Executed 229 tests, 7 skipped, 0 failures

