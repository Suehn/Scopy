# v0.15 - UI Enhancement + Bug Fixes

## 📌 一页纸总结

**What**: UI 优化 + 关键 Bug 修复（孤立文件清理、Show in Finder）

**Why**:
1. 发现 9.3GB 孤立文件（81,603 个文件未被数据库引用）
2. 用户反馈 UI 信息层次不清晰
3. Show in Finder 按钮不工作

**Result**:
- **孤立文件清理**: 9.3GB → 0（删除 81,603 个孤立文件）
- **UI 优化**: 移除 App 图标，重新设计元数据显示
- **文本预览**: 新增悬浮预览功能（前100字+...+后100字）
- **所有测试通过**

---

## 🏗️ 实现路线

### Phase 1: Footer 简化
- 移除 Clear All 按钮（⌘⌫）
- 保留 Settings（⌘,）和 Quit（⌘Q）

### Phase 2: 元数据显示重设计
- 移除列表项中的 App 图标
- 文本: `{字数}字 · {行数}行 · ...{末4字}`
- 图片: `{宽}×{高} · {大小}`
- 文件: `{文件数}个文件 · {大小}`

### Phase 3: 文本预览功能
- 悬浮预览（与图片预览相同的触发机制）
- 显示前 100 字符 + ... + 后 100 字符
- 支持 text/rtf/html 类型

### Phase 5: 孤立文件清理 (P0 Bug Fix)
- 新增 `cleanupOrphanedFiles()` 方法
- 启动时自动清理未被数据库引用的文件
- 并行删除提升性能

### Phase 6: Show in Finder 修复
- 使用 `FileManager.urls()` 获取可靠路径
- 不再依赖 `storageStats` 是否加载完成

---

## 📂 核心改动

| 文件 | 修改类型 | 说明 |
|------|----------|------|
| `Scopy/Services/StorageService.swift` | Bug Fix | 新增 `cleanupOrphanedFiles()` 方法 |
| `Scopy/Services/RealClipboardService.swift` | Bug Fix | 启动时调用孤立文件清理 |
| `Scopy/Views/SettingsView.swift` | Bug Fix | 修复 Show in Finder 按钮 |
| `Scopy/Views/FooterView.swift` | UI | 移除 Clear All 按钮 |
| `Scopy/Views/HistoryListView.swift` | UI | 移除 App 图标，重设计元数据，添加文本预览 |

---

## 🎯 关键指标

### Bug 修复效果

| 问题 | 修复前 | 修复后 |
|------|--------|--------|
| 孤立文件数量 | 81,603 | 0 |
| 外部存储大小 | 9.3 GB | 8.0 KB |
| Show in Finder | 不工作 | 正常 |

### UI 变化

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| Footer 按钮 | Clear All + Settings + Quit | Settings + Quit |
| 列表项 App 图标 | 显示 | 移除 |
| 文本元数据 | `App名 · 大小` | `字数字 · 行数行 · ...末4字` |
| 图片元数据 | `Image · App名 · 大小` | `宽×高 · 大小` |
| 文本预览 | 无 | 悬浮显示前100+...+后100字 |

### 测试结果
- 单元测试: **全部通过**

---

## 📊 当前状态

```
项目状态检查:
  ✅ 孤立文件清理: 9.3GB → 0
  ✅ Show in Finder: 修复
  ✅ Footer: 移除 Clear All 按钮
  ✅ 元数据显示: 重新设计
  ✅ 文本预览: 新增功能
  ✅ 测试: 全部通过
  ✅ 构建: Release ✅
```

---

## 🔮 遗留与后续

### 已解决问题
- 孤立文件导致的存储泄漏（9.3GB）
- Show in Finder 按钮不工作
- UI 信息层次不清晰

### 后续优化方向
1. 文件预览功能（当前跳过，复杂度高）
2. 图片分辨率存储到数据库（避免解析 plainText）
3. 考虑添加存储清理进度指示器

### 下一版本计划
- v0.16: 继续 UI 美化
- 性能监控收敛

---

## 技术细节

### 1. 孤立文件清理原理

**问题根因**:
- 数据库有 402 条记录，但 content 目录有 81,603 个文件
- 所有记录的 `storage_ref` 都是 NULL（内联存储）
- 这些文件是历史遗留的孤立文件

**解决方案**:
```swift
func cleanupOrphanedFiles() throws {
    // 1. 获取数据库中所有有效的 storage_ref
    let validRefs = Set<String>()  // 从数据库查询

    // 2. 遍历 content 目录
    for file in contentDirectory {
        if !validRefs.contains(file.name) {
            orphanedFiles.append(file)
        }
    }

    // 3. 并行删除孤立文件
    deleteFilesInParallel(orphanedFiles)
}
```

### 2. 文本预览实现

```swift
private func startTextPreviewTask() {
    hoverPreviewTask = Task {
        // 等待预览延迟
        try? await Task.sleep(nanoseconds: delayNanos)

        // 生成预览内容
        let preview: String
        if text.count <= 200 {
            preview = text
        } else {
            preview = "\(text.prefix(100))\n...\n\(text.suffix(100))"
        }

        // 显示预览
        showTextPreview = true
    }
}
```

### 3. 元数据显示格式

```swift
private var metadataText: String {
    switch item.type {
    case .text, .rtf, .html:
        return "\(charCount)字 · \(lineCount)行 · ...\(lastChars)"
    case .image:
        return "\(width)×\(height) · \(size)"
    case .file:
        return "\(fileCount)个文件 · \(size)"
    default:
        return formatBytes(item.sizeBytes)
    }
}
```

---

**版本**: v0.15
**日期**: 2025-11-29
**作者**: Claude Code
