# v0.50.fix17

> 状态：✅
> 说明：Feat/PNG：集成 pngquant（默认用于 Markdown/LaTeX 导出 PNG 压缩）；可选启用“历史图片写入前压缩”，并提供导出/写入两套独立参数与压缩比提示。

## 📌 一页纸总结（What / Why / Result）

### What

- Feat/PNG：**Markdown/LaTeX 导出 PNG 默认启用 pngquant 压缩**（写入剪贴板前完成压缩）。
- Feat/PNG：新增可选开关 **“历史图片压缩（pngquant）”**（默认关闭），开启后图片写入历史前会压缩并覆盖原始 payload。
- Feat/PNG：导出/写入历史 **两套独立参数**（quality/speed/colors），并支持自定义 pngquant 路径（留空自动探测，优先使用内置 `Tools/pngquant`）。
- UX：导出成功后会在按钮提示中展示 **简单压缩比**（例如 `pngquant -73%`）。

### Why

- 图片是 `content/` 的主要空间来源；导出 PNG 与历史图片若不优化，容易触发自动清理阈值，造成“历史条目变少”的体感问题。
- pngquant 对 PNG 的压缩收益显著，且不改变复制图片进入历史的默认行为（避免意外损伤原图质量）。

### Result

- 导出：导出结果会优先被压缩后写入剪贴板，因此后续进入 Scopy 历史/落盘到 `content/` 的也是 **压缩后的 PNG**（满足“压缩即替代原图”的语义）。
- 历史图片：默认不压缩；用户可按需开启并调整两套参数。
- 兼容：若 pngquant 不可用，将 best-effort 跳过压缩，不影响导出/写入历史的原有功能链路。

---

## 📂 核心改动

- `Scopy/Services/PngquantService.swift`
- `Scopy/Views/History/MarkdownExportService.swift`
- `Scopy/Application/ClipboardService.swift`
- `Scopy/Domain/Models/SettingsDTO.swift`
- `Scopy/Infrastructure/Settings/SettingsStore.swift`
- `Scopy/Views/Settings/ClipboardSettingsPage.swift`
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`
- `Scopy/Resources/Tools/pngquant`
- `Scopy/Resources/ThirdParty/pngquant/*`
- `project.yml`

---

## ✅ 测试

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`：Executed 276 tests, 25 skipped, 0 failures
- `make release-validate`：✅

