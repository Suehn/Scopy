# v0.44.fix8

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Perf/Searchï¼ˆè¯­ä¹‰ç­‰ä»·ï¼‰ï¼šä¿®å¤ FTS å†™å…¥ä¾§æ— æ„ä¹‰é‡å»ºã€ç¼“å­˜ä¸€è‡´æ€§æ¼‚ç§»ï¼Œå¹¶é™ä½æœç´¢çƒ­è·¯å¾„çš„å›ºå®šå¼€é”€ä¸æ·±åˆ†é¡µæŠ–åŠ¨é£é™©ã€‚

### Why

- FTS external-content + trigger ç»´æŠ¤é‡Œï¼Œ`clipboard_items` çš„ `AFTER UPDATE` trigger ä¹‹å‰ä¼šåœ¨ä»…æ›´æ–°å…ƒæ•°æ®ï¼ˆ`last_used_at/use_count/is_pinned`ï¼‰æ—¶ä¹Ÿæ‰§è¡Œ â€œdelete old + insert newâ€ï¼Œå¯¼è‡´ **é•¿æœŸå†™æ”¾å¤§ + FTS æ®µç¢ç‰‡åŒ–**ï¼Œé—´æ¥æŠ¬é«˜æœç´¢å°¾å»¶è¿Ÿã€‚
- Search çƒ­è·¯å¾„æ¯æ¬¡éƒ½ `sqlite3_prepare_v2` é‡æ–° prepare SQLï¼Œæ‰“å­—é¢‘ç¹æŸ¥è¯¢æ—¶å½¢æˆç¨³å®šå›ºå®šæˆæœ¬ã€‚
- åå° cleanup æ‰¹é‡åˆ é™¤æœªé€šçŸ¥ search-side cache/indexï¼Œå­˜åœ¨â€œå¹½çµå€™é€‰ / é•¿æœŸæ¼‚ç§»â€é£é™©ï¼›pin å˜æ›´ä¹Ÿå¯èƒ½å¯¼è‡´çŸ­è¯ cache 30s å†…çŸ­æš‚ä¸ä¸€è‡´ã€‚
- fuzzy æ·±åˆ†é¡µåœ¨ offset å¢å¤§æ—¶ `heap reserveCapacity(offset+limit+1)`ï¼Œå¹¶ä¸”æ¯é¡µé‡å¤å…¨é‡æ‰«æï¼Œå®¹æ˜“å‡ºç°å°¾å»¶è¿Ÿ/å†…å­˜å³°å€¼æŠ–åŠ¨ã€‚

### Result

- FTS ä»…åœ¨ `plain_text` çœŸæ­£å˜åŒ–æ—¶æ‰æ›´æ–°ç´¢å¼•ï¼Œç§»é™¤å…ƒæ•°æ®æ›´æ–°çš„ FTS churnï¼ˆè¯­ä¹‰ä¸å˜ï¼‰ã€‚
- SearchEngineImpl å¼•å…¥ statement cacheï¼ˆactor å†…ä¸²è¡Œå¤ç”¨ï¼‰ï¼Œå‡å°‘é«˜é¢‘æŸ¥è¯¢çš„ prepare å¼€é”€ï¼ˆè¯­ä¹‰ä¸å˜ï¼‰ã€‚
- cleanup åç»Ÿä¸€ä½¿ search cache/index å¤±æ•ˆï¼›pin å˜æ›´åŒæ­¥å¤±æ•ˆ short-query cacheï¼Œä¿è¯ä¸€è‡´æ€§ï¼ˆè¯­ä¹‰ä¸å˜ï¼‰ã€‚
- fuzzy åˆ†é¡µå¯¹ offset>0 å¼•å…¥ per-query â€œå…¨é‡æœ‰åº matches ç¼“å­˜â€ï¼Œé¿å…æ·±åˆ†é¡µé‡å¤å…¨é‡ topK æ‰«æå¯¼è‡´çš„æŠ–åŠ¨ï¼ˆæ’åº comparator ä¸å˜ï¼Œè¯­ä¹‰ä¸å˜ï¼‰ã€‚

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. bump DB `PRAGMA user_version` å¹¶æ›¿æ¢ `clipboard_au` triggerï¼šåªåœ¨ `plain_text` å˜åŒ–æ—¶åˆ·æ–° FTSã€‚
2. åœ¨ `SearchEngineImpl` å†…åŠ å…¥ statement cacheï¼Œå¹¶å¯¹çƒ­è·¯å¾„æŸ¥è¯¢ç»Ÿä¸€ `reset/clear_bindings`ã€‚
3. cleanup ä¸ pin è·¯å¾„è¡¥é½ search-side invalidationï¼Œæ¶ˆé™¤ç¼“å­˜/ç´¢å¼•æ¼‚ç§»çª—å£ã€‚
4. fuzzy æ·±åˆ†é¡µå¼•å…¥ query-scope æœ‰åºç»“æœç¼“å­˜ï¼ˆä»…åœ¨ offset>0 æ—¶å¯ç”¨ï¼Œé¿å…å½±å“é¦–å±ï¼‰ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `Scopy/Infrastructure/Persistence/SQLiteMigrations.swift`ï¼š`user_version` â†’ 2ï¼›`clipboard_au` æ”¹ä¸º `AFTER UPDATE OF plain_text ... WHEN OLD.plain_text IS NOT NEW.plain_text`ã€‚
- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`ï¼š
  - statement cacheï¼ˆä¸Šé™ 32ï¼‰+ çƒ­è·¯å¾„ `reset()` å¤ç”¨ï¼›
  - `handlePinnedChange` å¤±æ•ˆ short-query cacheï¼›
  - fuzzy offset paging çš„ query-scope æ’åºç¼“å­˜ï¼ˆindex generation å˜æ›´å³å¤±æ•ˆï¼‰ã€‚
- `Scopy/Application/ClipboardService.swift`ï¼šcleanup æˆåŠŸå `await search.invalidateCache()`ï¼ˆå«å®šæ—¶ cleanup ä¸ settings æ›´æ–°è§¦å‘ cleanupï¼‰ã€‚
- `ScopyTests/SearchServiceTests.swift`ï¼šæ–°å¢ trigger è¯­ä¹‰å›å½’ï¼ˆæ£€æŸ¥ `sqlite_master` ä¸­ trigger SQLï¼‰ã€‚
- `ScopyTests/SearchBackendConsistencyTests.swift`ï¼šæ–°å¢ service-path å›å½’ï¼ˆpin åçŸ­è¯æœç´¢ç«‹å³ç½®é¡¶ï¼‰ã€‚

---

## ğŸ¯ å…³é”®æŒ‡æ ‡

**æ€§èƒ½åŸºçº¿ï¼ˆApple M3 24GB, macOS 15.7.2ï¼ˆ24G325ï¼‰, Xcode 16.3ï¼ˆ16E140ï¼‰, Debugï¼Œ`PerformanceTests`ï¼‰**

- Disk æœç´¢ï¼ˆ25k items, fuzzyPlusï¼‰ï¼šcold start 720.22msï¼›P95 46.08msï¼ˆSamples: 60ï¼‰
- Service-path disk æœç´¢ï¼ˆ10k items, fuzzyPlusï¼‰ï¼šcold start 250.20msï¼›P95 35.54msï¼ˆSamples: 50ï¼‰

**æµ‹è¯•ç»“æœ**

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/PerformanceTests`ï¼šExecuted 24 tests, 6 skipped, 0 failures
- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests/SearchServiceTests`ï¼šExecuted 25 tests, 1 skipped, 0 failures

---

## ğŸ“Š å½“å‰çŠ¶æ€

- æœç´¢è¯­ä¹‰ï¼šåŒ¹é…é›†åˆ/æ’åº comparator ä¸å˜ï¼›ä»…ç§»é™¤å†—ä½™å·¥ä½œä¸ä¿®å¤ä¸€è‡´æ€§çª—å£ âœ…
- è¿ç§»ï¼š`PRAGMA user_version=2`ï¼Œè§¦å‘å™¨æ›¿æ¢ä¸éœ€è¦é‡å»º FTS âœ…
- å›å½’è¦†ç›–ï¼štrigger è¯­ä¹‰ + pinâ†’çŸ­è¯ cache ä¸€è‡´æ€§ âœ…
