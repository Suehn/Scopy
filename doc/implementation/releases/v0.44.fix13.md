# v0.44.fix13

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Preview：修复 `$...$` 数学段内部包含 `\begin{cases}...\end{cases}` 等环境时，hover Markdown/LaTeX 预览会把内部占位符（`SCOPYMATHPLACEHOLDER...`）泄漏到最终渲染结果的问题。

### Why

- `MathProtector` 的保护顺序是“环境块优先，其次 `$...$`”，这在真实题目文本里会产生“环境占位符被塞进 `$...$` 的 original 里”的嵌套结构。
- 如果还原阶段只按原顺序做一次替换，就可能出现：外层占位符被替换出来后，内层占位符才第一次出现在 HTML 中，但已经错过了替换时机，导致 KaTeX 把它当作普通文本渲染（表现为红框中的怪异字母/占位符串）。

### Result

- 保护阶段对 placeholders 做“嵌套占位符展开”，确保每个 `original` 都是自洽的、不会再包含其它 placeholder。
- 还原阶段按“逆插入顺序”替换，作为额外保险，避免任何残余嵌套结构导致占位符漏出（数学语义不变）。
- 新增回归测试覆盖 `\text{sgn}` + `cases` + 多段 `$...$` 的真实片段，并用 KaTeX `renderToString` 跑到端，确保不再出现占位符泄漏与 parse error。

---

## 📂 核心改动

- `Scopy/Views/History/MathProtector.swift`
  - 新增 `resolveNestedPlaceholders`：把外层 original 中引用到的内层 placeholder 展开为内层 original。
  - `restoreMath` 改为按 `placeholders.reversed()` 替换，避免“先替换内层但内层尚未出现在 HTML 中”造成遗漏。
- `ScopyTests/MarkdownMathRenderingTests.swift`
  - 新增 `testInlineCasesInsideDollarMathDoesNotLeakNestedPlaceholder`，验证保护后 `original` 不含 `SCOPYMATHPLACEHOLDER`。
- `ScopyTests/KaTeXRenderToStringTests.swift`
  - 强化“第 21 题”片段回归：对每个提取出的 segment 断言不含占位符，并确保 KaTeX 渲染无异常。

---

## ✅ 测试

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`：Executed 232 tests, 7 skipped, 0 failures

