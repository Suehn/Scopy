# v0.44.fix25

> çŠ¶æ€ï¼šâœ…

## ğŸ“Œ ä¸€é¡µçº¸æ€»ç»“ï¼ˆWhat / Why / Resultï¼‰

### What

- Fix/WebViewï¼šMarkdown hover-preview çš„ `WKScriptMessageHandler` æ”¹ä¸ºå¼±ä»£ç†è½¬å‘ï¼Œå¹¶åœ¨ `dismantleNSView` æ˜¾å¼æ‹†ç¯ï¼ˆremove handler + nil delegatesï¼‰ï¼Œé¿å…æ½œåœ¨ retain cycle å¯¼è‡´ controller æ— æ³•é‡Šæ”¾ã€‚
- Fix/Statsï¼šå­˜å‚¨ç»Ÿè®¡å£å¾„æ‹†åˆ†â€”â€”`getStorageStats()` ä»…è¿”å›â€œå†…å®¹ä¼°ç®—â€ï¼ˆDB `SUM(size_bytes)`ï¼‰ï¼Œ`getDetailedStorageStats()` ä¿æŒâ€œçœŸå®ç£ç›˜å ç”¨â€ï¼ˆDB æ–‡ä»¶ + å¤–éƒ¨ç›®å½• + ç¼©ç•¥å›¾ç›®å½•ï¼‰ï¼Œé¿å…é¦–å±/åˆ·æ–°é‡å¤ç›®å½•éå†ã€‚

### Why

- WebKit çš„ `WKUserContentController` ä¼šå¼ºå¼•ç”¨å…¶æ³¨å†Œçš„ script message handlerï¼›å½“ handler ç»‘å®šä¸º `self` ä¸” controller åŒæ—¶å¼ºæŒæœ‰ `WKWebView` æ—¶ï¼Œå¾ˆå®¹æ˜“å½¢æˆå¼ºå¼•ç”¨ç¯ï¼ˆP2-6ï¼‰ã€‚
- ç›®å½•éå†è®¡ç®— size å±äºé«˜æˆæœ¬ I/Oï¼›å½“å¤šä¸ªå…¥å£åœ¨åŒä¸€æ—¶åˆ»è§¦å‘æ‰«æï¼Œä¼šé€ æˆé¦–å±å˜æ…¢ã€èƒ½è€—ä¸Šå‡ä¸â€œéšæœºå¡é¡¿â€ï¼ˆP2-8ï¼‰ã€‚

### Result

- hover-preview çš„ WebView handler å¼ºå¼•ç”¨é“¾è¢«æ ¹å› æ‹†é™¤ï¼Œä¸” view ç§»é™¤æ—¶æ˜¾å¼ teardownï¼Œç”Ÿå‘½å‘¨æœŸå¯é€šè¿‡å•æµ‹éªŒè¯é‡Šæ”¾ã€‚
- é¦–å±/åˆ·æ–°è·¯å¾„ä¸å†å› ä¸º `getStorageStats()` è§¦å‘ç›®å½•æ‰«æï¼›â€œå†…å®¹ä¼°ç®—/çœŸå®ç£ç›˜å ç”¨â€çš„ UI å±•ç¤ºå£å¾„æ›´ä¸€è‡´ã€‚

---

## ğŸ—ï¸ å®ç°è·¯çº¿

1. æ–°å¢ `WeakScriptMessageHandler`ï¼ˆå¼±æŒæœ‰çœŸå® handlerï¼‰ç”¨äºæ³¨å†Œåˆ° `WKUserContentController`ã€‚
2. `MarkdownPreviewWebViewController` ä¸ one-shot `MarkdownPreviewWebView` ç»Ÿä¸€æ”¹ç”¨ proxy æ³¨å†Œï¼Œå¹¶åœ¨ `dismantleNSView` ä¸­ remove handler + nil delegatesã€‚
3. `ClipboardService.getStorageStats()` æ”¹ä¸º DB `SUM(size_bytes)`ï¼ˆå†…å®¹ä¼°ç®—ï¼‰ï¼Œé¿å…ç›®å½•æ‰«æã€‚
4. æ–°å¢å›å½’æµ‹è¯•ï¼šWebView controller å¯é‡Šæ”¾ï¼›å†…å®¹ä¼°ç®—ä¸çœŸå®ç£ç›˜å ç”¨å£å¾„åŒºåˆ†ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ”¹åŠ¨

- `ScopyUISupport/WeakScriptMessageHandler.swift`
  - WebKit script message handler å¼±ä»£ç†ï¼ˆæ ¹å› æ‹†ç¯ï¼‰ã€‚
- `Scopy/Views/History/MarkdownPreviewWebView.swift`
  - handler æ”¹ä¸ºå¼±ä»£ç† + `dismantleNSView` teardownï¼ˆremove handler / nil delegates / stop loadingï¼‰ã€‚
- `Scopy/Application/ClipboardService.swift`
  - `getStorageStats()` æ”¹ä¸ºå†…å®¹ä¼°ç®—ï¼ˆ`SUM(size_bytes)`ï¼‰ã€‚
- `ScopyTests/WebViewLifecycleTests.swift`
  - è¦†ç›– `MarkdownPreviewWebViewController` é‡Šæ”¾ï¼ˆé¿å… retain cycle å›å½’ï¼‰ã€‚
- `ScopyTests/StorageStatsSemanticsTests.swift`
  - è¦†ç›–â€œå†…å®¹ä¼°ç®— vs çœŸå®ç£ç›˜å ç”¨â€å£å¾„ã€‚

---

## ğŸ¯ å…³é”®æŒ‡æ ‡

- å•å…ƒæµ‹è¯•ï¼š`make test-unit`ï¼šExecuted 217 tests, 1 skipped, 0 failures

