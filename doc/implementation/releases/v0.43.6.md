# v0.43.6 - Perf/UX：hover 图片预览更及时（预取 + ThumbnailCache 优先级）

**日期**: 2025-12-14

---

## 一页纸总结

### What

- **hover 预览更快**：在 hover delay 期间预取原图数据并完成 downsample，popover 出现后更容易“直接有图”，减少长时间转圈与“移开再悬停才显示”的体感。
- **缩略图占位更及时**：`ThumbnailCache` 支持按场景传入优先级；popover 预览按 `userInitiated` 加载缩略图并使用 `.mappedIfSafe`，让当前交互优先于后台任务。

### Why

- hover 预览属于“当前交互”路径，但之前数据准备往往发生在 popover 显示之后；在系统忙/低功耗场景下，会出现“轻量图也要等很久”的体感。
- `ThumbnailCache` 读盘使用较低优先级且非 memory map，首帧占位更容易被延后。

### Result

- hover 预览更稳定：对“轻量图”更容易在 popover 出现后直接展示缩略图/预览图，无需通过重新悬停触发刷新。
- 回归通过：
  - `make test-unit`：**55 passed**, 1 skipped（56 total）
  - `make test-perf`：**16 passed**, 6 skipped（22 total）
  - `make test-tsan`：**135 passed**, 1 skipped（136 total）
  - `make test-strict`：**163 passed**, 7 skipped（170 total）

---

## 实现路线

1. `ThumbnailCache.loadImage` 增加 `priority` 参数；读盘改为 `.mappedIfSafe`，减少拷贝与 IO 抖动。
2. popover 预览加载缩略图时使用 `userInitiated` 优先级，保证“当前 hover”优先于后台任务。
3. `HistoryItemView` 在 hover delay 内启动预取任务（150ms 后开始），提前完成 `getImageData` + downsample；delay 到达时展示 popover，随后直接应用已准备好的 preview data。

---

## 核心改动

- `Scopy/Infrastructure/Caching/ThumbnailCache.swift`
- `Scopy/Views/History/HistoryItemImagePreviewView.swift`
- `Scopy/Views/History/HistoryItemView.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit`（55 passed, 1 skipped）
- 性能测试：`make test-perf`（16 passed, 6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`）
- Thread Sanitizer：`make test-tsan`（135 passed, 1 skipped）
- Strict Concurrency：`make test-strict`（163 passed, 7 skipped）

### 性能（Debug / `make test-perf` 单次运行）

- 环境：MacBook Air（Apple M3, 24 GB）/ macOS 15.7.2（24G325）/ arm64 / 2025-12-14
- 电源：Low Power Mode enabled（`pmset -g` 显示 `lowpowermode 1`）
- 关键结果：
  - Fuzzy 5k items P95 ≈ 8.23ms
  - Fuzzy 10k items P95 ≈ 77.35ms（Samples: 50；Low Power Mode 下测试阈值放宽至 300ms）
  - Disk 25k fuzzy P95 ≈ 110.59ms（Samples: 50；Low Power Mode enabled）
  - Bulk insert 1000 items ≈ 82.74ms（≈12,086 items/s；Low Power Mode enabled）
  - Fetch recent (50 items) avg ≈ 0.11ms
  - Regex 20k items P95 ≈ 5.31ms
  - Mixed content disk search（single run）≈ 7.91ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 若要量化 hover 预览体验，可考虑补充一个最小基准（hover → popover 首帧/首图耗时），并写入 `doc/profiles/`。

