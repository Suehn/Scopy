# v0.44.fix3

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Preview：Markdown/LaTeX 预览改为“渲染并稳定测量后再展示”，避免 popover 在懒加载阶段出现闪烁与大小跳动。

### Why

- 公式（KaTeX）渲染和字体加载会引发短时间内多次布局变化；如果 popover 已经打开并同步跟随尺寸，会造成明显的闪烁/抖动与生硬切换。

### Result

- Hover 文本预览在检测到 Markdown 后：先在行内离屏预热同一个 `WKWebView`，等待尺寸稳定，再打开 popover；popover 打开时已完成渲染与测量，尺寸不再跳动。

---

## 🏗️ 实现路线

1. 引入可复用的 `WKWebView` 控制器（保留原安全策略与 size 上报逻辑）。
2. Markdown 模式下先离屏加载 HTML，并对 size 上报做短去抖（settle）以等待 KaTeX/字体稳定。
3. size 稳定后再打开 popover，并把同一个 `WKWebView` 从离屏容器“搬”到 popover，避免二次加载与二次闪烁。

---

## 📂 核心改动

- `Scopy/Views/History/MarkdownPreviewWebView.swift`：新增 `MarkdownPreviewWebViewController` 与 `ReusableMarkdownPreviewWebView`，支持复用同一个 WebView。
- `Scopy/Views/History/HistoryItemView.swift`：Markdown 预览改为离屏预热 + stable size 后再展示 popover（避免跳动）。
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`：popver 侧使用复用 WebView，并在展示后不再跟随尺寸更新（防止二次跳动）。
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`：Web 内容保持“渲染完成再淡入”以减少内部闪现（离屏预热时用户不可见）。

---

## 🎯 关键指标

- **测试**：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`（Executed 218 tests, 7 skipped, 0 failures）
- **环境**：Apple M3 / 24GB；macOS 15.7.2（24G325）；Xcode 16.3（16E140）
- **稳定策略**：离屏测量在 90ms 内没有新 size 上报后视为稳定（可根据体验再调）。

---

## 📊 当前状态

- 单元测试：`xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests` ✅
- hover 体验：Markdown/公式预览不再“先开后抖”，popover 首帧即稳定尺寸 ✅

---

## 🔮 遗留与后续

- 若后续发现极端内容（大图/超长表格）仍会在更长时间内继续变化，可把 settle 窗口做成“自适应上限”（例如最多等待 250ms）以进一步消除边界抖动。
