# v0.37 - P0-6 ingest 背压：spool + 有界并发队列（减少无声丢历史）

**日期**: 2025-12-13

---

## 一页纸总结

### What

- `ClipboardMonitor` 大内容 ingest 改为“有界并发 + pending backlog”，不再在队列满时 cancel oldest task。
- 大 payload（默认 ≥100KB）先写入 `~/Library/Caches/Scopy/ingest/`，`contentStream` 仅传 file ref；Storage 入库时 move/copy 到 external storage，失败/去重路径会清理临时文件。
- `ClipboardMonitor.contentStream` 调整为 `.unbounded`（payload 不携带大 `Data`），降低 burst 时的 drop 风险。

### Why

- v0.36 的 `ClipboardMonitor` 在 burst 场景下会出现：
  - 队列满时直接 cancel oldest task（可能无声丢历史）
  - `contentStream` 为 `.bufferingNewest(8)` 时消费者慢可能丢旧事件
- 该问题属于 P0-6：用户确实复制了，但条目可能未入库且不易感知。

### Result

- 常见 burst 场景下 ingest 更可预测：背压主要转移到磁盘（ingest spool），内存峰值更可控，历史丢失风险显著下降。
- 仍保留极端兜底：pending backlog 超限会丢弃最旧 pending，并记录 error log（后续可扩展为 UI 提示）。

---

## 核心实现

### ClipboardMonitor：payload 分离 + 有界并发

- `ClipboardMonitor.ClipboardContent` 引入 `payload`：
  - `.none` / `.data(Data)` / `.file(URL)`
- 大内容后台任务：
  - `maxConcurrentTasks` 并发处理，超出进入 pending backlog（避免直接 cancel 最旧任务）
  - 大 payload 先落盘到 `~/Library/Caches/Scopy/ingest/`，再 yield（stream 不再携带大 `Data`）

### StorageService：支持 ingest file ref

- `StorageService.upsertItem` 支持消费 `.file(URL)`：
  - 外部存储：move/copy 到 `~/Library/Application Support/Scopy/content/`
  - 去重/失败：best-effort 清理 ingest 文件，避免缓存目录泄漏

### ClipboardService：设置过滤也做清理

- 当用户设置禁用保存图片/文件时，若 ingest payload 已落盘，立即清理 `ingest` 临时文件后返回。

---

## 修改文件列表（核心）

- `Scopy/Services/ClipboardMonitor.swift`
- `Scopy/Services/StorageService.swift`
- `Scopy/Application/ClipboardService.swift`
- `Scopy/Infrastructure/Configuration/ScopyThresholds.swift`
- `ScopyTests/*`
- `DEPLOYMENT.md`
- `doc/profiles/v0.36.1-profile.md`
- `doc/profiles/v0.37-profile.md`
- `doc/profiles/README.md`
- `doc/reviews/review-v0.3.md`
- `Scopy.xcodeproj/project.pbxproj`（`xcodegen generate`）

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- 性能测试：`make test-perf` **22 tests passed** (6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`)
- Thread Sanitizer：`make test-tsan` **132 tests passed** (1 skipped)

### 性能（Debug / `make test-perf`）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / Xcode 16.3（16E140）/ 2025-12-13
- 关键结果（单次运行）：
  - Fuzzy 5k items P95 ≈ 8.55ms
  - Fuzzy 10k items P95 ≈ 78.40ms
  - Disk 25k fuzzy P95 ≈ 115.68ms
  - Bulk insert 1000 items ≈ 83.97ms（≈11,908 items/s）
  - Fetch recent (50 items) avg ≈ 0.11ms
  - Regex 20k items P95 ≈ 5.54ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ⏳ `/tmp/scopy_hotkey.log`（本版本不改热键；按 `AGENTS.md` 仍建议人工自查一次）

---

## 遗留与后续

- pending backlog 超限目前只记录日志；如需用户可见，可在 `ClipboardEvent` 引入 ingest warning 事件并在 UI 展示提示。
- Strict Concurrency 渐进回归仍建议继续推进（见 `doc/reviews/review-v0.3.md`）。

