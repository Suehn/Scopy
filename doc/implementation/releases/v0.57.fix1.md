# v0.57.fix1

> 状态：✅
> 说明：Fix/Clipboard：修复 ChatGPT 网页复制（KaTeX/MathML）导致的纯文本公式错乱；粘贴到 Typora 等 Markdown 编辑器可直接得到 `$...$`/`$$...$$`。

## 📌 一页纸总结（What / Why / Result）

### What

- Fix/Clipboard：从 HTML 的 `<annotation encoding="application/x-tex">` 提取 LaTeX，生成 `$...$`/`$$...$$` 形式的可粘贴纯文本。
- Fix/Clipboard：当剪贴板同时包含 RTF/HTML 且 plain text 被拆字时，RTF 仍保留为 payload，但 `plainText` 择优使用 HTML 的 TeX 版本。
- Dev/Release：发布后保持 `Casks/scopy.rb` 与 release 版本/sha 一致（作为 `Suehn/homebrew-scopy` 的同步源），避免 Homebrew 被同步回滚到旧版本。

### Why

- Safari/ChatGPT 网页复制公式时，剪贴板经常产生“碎片化”的 plain text（大量 1-2 字符换行），直接粘贴会出现公式拆字、重复、换行错乱。
- Typora 等编辑器之所以能粘贴出正确格式，是因为它们会从富文本/HTML 中识别并抽取可渲染的 LaTeX；Scopy 需要在 ingest 阶段把可用的 TeX 纯文本稳定保留下来。

### Result

- 从 ChatGPT 网页复制含公式内容后，直接粘贴到 Typora 可得到可渲染的 `$...$`/`$$...$$` 公式文本，避免“拆字/错乱”。

---

## 📂 核心改动

- `Scopy/Services/ClipboardMonitor.swift`（KaTeX/MathML → LaTeX 纯文本提取；RTF+HTML 择优）
- `ScopyTests/ClipboardMonitorTests.swift`（新增 KaTeX 拷贝场景回归测试）

---

## ✅ 测试

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`：Executed 280 tests, 25 skipped, 0 failures（2026-01-02）

