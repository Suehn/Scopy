# v0.56

> 状态：✅
> 说明：Release：文件条目预览（Quick Look + Markdown 读盘渲染）+ 文件备注可搜 + 元数据显示真实文件大小；并补齐性能/稳定性硬化（避免主线程读盘、预览缓存 TTL、有界并发）。

## 📌 一页纸总结（What / Why / Result）

### What

- Feat/Files：文件条目 hover 预览接入 Quick Look（PDF 可滚动、视频可播放），Markdown 文件读取并渲染 Markdown。
- Feat/Files：文件备注可编辑（右键编辑/清空）并纳入搜索（FTS + fuzzy）。
- Feat/Files：文件元数据展示真实文件大小（`fileSizeBytes`），并持久化避免重复扫盘。
- Perf/Stability：文件相关读盘从主线程移除；预览缓存引入 3h TTL；缩略图生成与文件大小计算均为有界并发。

### Why

- 新增文件预览/备注/真实大小后，最容易出现的回归是：主线程 IO 导致卡顿、hover 触发 IO 风暴、列表刷新重复扫盘。
- 需要把“读盘语义”明确为可控的刷新策略（避免每次 hover 都重读）。

### Result

- 文件条目新功能保持不变，同时显著降低主线程卡顿与 IO 风暴风险。
- Markdown 文件预览在 TTL 内可复用缓存，过期后按需刷新（每 3 小时最多刷新一次）。

---

## 📂 核心改动

- `Scopy/Application/ClipboardService.swift`（fileSizeBytes 后台计算/持久化、缩略图生成有界并发）
- `Scopy/Services/ClipboardMonitor.swift`（移除主线程 fileSizeKey 扫盘）
- `Scopy/Utilities/FilePreviewSupport.swift`（读盘与路径解析降载）
- `Scopy/Views/History/HistoryItemView.swift` / `Scopy/Views/History/MarkdownPreviewCache.swift`（Markdown 文件预览 TTL 缓存）
- `Scopy/Presentation/ClipboardItemDisplayText.swift`（文件条目 title/metadata 低分配计算）
- `Scopy/Services/StorageService.swift` / `Scopy/Infrastructure/Persistence/SQLiteClipboardRepository.swift`（file_size_bytes 写回）

---

## ✅ 测试

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`：Executed 278 tests, 25 skipped, 0 failures（2025-12-28）

---

## 🔮 遗留与后续

- 手动回归建议（网络盘/大量文件）：
  - 大量文件复制/滚动/hover 预览是否仍流畅；
  - Markdown 文件内容在磁盘变化后：TTL 过期后预览是否更新；
  - fileSizeBytes/thumbnail 后台补齐后列表是否稳定刷新（无抖动/无重复 IO）。

