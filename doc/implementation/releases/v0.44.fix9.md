# v0.44.fix9

## 📌 一页纸总结（What / Why / Result）

### What

- UX/Preview：hover 文本预览（尤其 Markdown/LaTeX）做“更宽更稳”的尺寸策略，并让滚动条只在滚动时出现。

### Why

- 现有 hover 预览在部分 Markdown/LaTeX 文档（长段落、宽数学块、宽表格等）里会出现：
  - **宽度差一点不够**：右侧轻微裁切，看起来像“少几个像素就能完全显示”；
  - **横向滚动条常驻**：即使多数内容不需要横向滚动，系统“总是显示滚动条”时仍会出现底部滚动条，影响观感；
  - **滚动条不符合预期**：用户希望“滚动时显示、停止滚动时隐藏”。

### Result

- 预览宽度上限更大，且按屏幕可视区域自适应，减少右侧裁切与不必要的横向滚动。
- Markdown 渲染侧上报 `{width,height,overflowX}`，并将“横向滚动需求”作为显式信号传回 SwiftUI（不再靠猜）。
- 将横向溢出尽量局部化（KaTeX display block 独立横向滚动），并默认关闭外层水平滚动条；仅在确实存在全局横向溢出时才启用。
- 对 hover 预览的 scroll view 强制做滚动条 show/hide：滚动时显示、静止后自动隐藏。

---

## 🏗️ 实现要点（避免影响功能/准确性）

- 所有改动仅影响 hover 预览的尺寸与滚动条呈现，不改变内容、搜索、或渲染语义。
- 通过“局部横向滚动”降低全局 overflow 概率，避免整页被撑宽导致的底部滚动条。

---

## 📂 核心改动

- `Scopy/Design/ScopySize.swift`：hover 预览最大宽度上调。
- `Scopy/Views/History/HoverPreviewScreenMetrics.swift`：新增 `maxPopoverWidthPoints()`，按当前屏幕可视区域做宽度上限。
- `Scopy/Views/History/MarkdownHTMLRenderer.swift`：
  - CSS：`.katex-display` 局部横向滚动；table 布局更保守，尽量不撑宽父容器；
  - JS：尺寸上报改为 `{ width, height, overflowX }`。
- `Scopy/Views/History/MarkdownPreviewWebView.swift`：
  - 增加 `MarkdownContentMetrics`（size + overflowX）；
  - 默认不启用水平滚动条；只有 overflowX 才开启；
  - 新增 `ScrollbarAutoHider`：对 hover 预览强制实现“滚动时显示、静止隐藏”。
- `Scopy/Views/History/HistoryItemView.swift` / `HistoryItemTextPreviewView.swift`：
  - measurer 使用屏幕自适应宽度；
  - 若存在横向溢出信号，优先使用最大宽度，减少右侧裁切。
- `ScopyTests/KaTeXRenderToStringTests.swift`：更新尺寸上报字符串断言（仍确保不引入 `devicePixelRatio`）。

---

## ✅ 测试

- `xcodebuild test -scheme Scopy -destination 'platform=macOS' -only-testing:ScopyTests`：Executed 229 tests, 7 skipped, 0 failures

