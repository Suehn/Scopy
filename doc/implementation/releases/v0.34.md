# v0.34 - vNext 重构：缓存入口收口（IconService/ThumbnailCache）+ perf 用例稳定性

**日期**: 2025-12-13

---

## 一页纸总结

### What

- 新增缓存入口：
  - `Scopy/Infrastructure/Caching/IconService.swift`：应用图标/名称的单一缓存入口
  - `Scopy/Infrastructure/Caching/ThumbnailCache.swift`：缩略图内存缓存入口（NSCache）
- Presentation 侧去重：
  - `HistoryItemView` 移除静态 `NSCache`（icon/thumbnail）
  - `AppState` 图标预加载与 `HistoryItemView` 图标/名称读取统一切换到 `IconService`
- 删除旧实现：移除 `Scopy/Services/IconCache.swift`（`IconCacheSync/IconCache` 双套缓存实现）
- perf 用例稳定性：`ScopyTests/PerformanceTests.swift` 的 `testMixedContentIndexingOnDisk` 增加 warmup 查询，降低偶发抖动误报

### Why

- 缓存入口分散（View 静态缓存 + IconCacheSync + 其他缓存）导致维护成本高、行为不一致、难以统一清理策略。
- perf 用例存在一次性冷启动/抖动导致的偶发失败，需要更可预测的测量方式。

### Result

- `rg -n "static let (iconCache|thumbnailCache): NSCache" Scopy/Views` 为 0
- `rg -n "IconCacheSync\\.shared" Scopy` 为 0
- `make test-unit` 通过（53 tests passed，1 skipped）
- `make test-perf` 通过（22 tests passed，6 skipped；heavy 场景需 `RUN_HEAVY_PERF_TESTS=1`）

---

## 核心实现

### IconService（单一入口）

- `Scopy/Infrastructure/Caching/IconService.swift`
  - `icon(bundleID:)`：命中缓存直接返回；未命中时同步通过 `NSWorkspace` 获取并写入缓存
  - `appName(bundleID:)`：名称缓存（NSCache）

### ThumbnailCache（单一入口）

- `Scopy/Infrastructure/Caching/ThumbnailCache.swift`
  - `cachedImage(path:)`：仅内存命中
  - `loadImage(path:) async`：后台读文件 + 主线程构造 `NSImage`，写回缓存

### View 侧迁移

- `Scopy/Views/HistoryListView.swift`
  - `HistoryItemView` 不再持有静态 `NSCache`
  - 缩略图加载逻辑改为复用 `ThumbnailCache`
  - icon/name 读取改为使用 `IconService`

---

## 修改文件列表（核心）

- 新增：`Scopy/Infrastructure/Caching/IconService.swift`
- 新增：`Scopy/Infrastructure/Caching/ThumbnailCache.swift`
- 修改：`Scopy/Observables/AppState.swift`
- 修改：`Scopy/Views/HistoryListView.swift`
- 删除：`Scopy/Services/IconCache.swift`
- 修改：`ScopyTests/PerformanceTests.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit` **53 tests passed** (1 skipped)
- AppState：`xcodebuild test -only-testing:ScopyTests/AppStateTests -only-testing:ScopyTests/AppStateFallbackTests` **46 tests passed**
- 性能测试：`make test-perf` **22 tests passed** (6 skipped)

### 性能（Debug / `make test-perf`）

- 环境：Apple M3 / macOS 15.7.2（24G325）/ arm64 / 2025-12-13
- 关键结果：
  - Fuzzy 5k items P95 ≈ 8.48ms
  - Fuzzy 10k items P95 ≈ 77.49ms
  - Disk 25k fuzzy P95 ≈ 106.20ms
  - Mixed content disk search（single run, after warmup）≈ 7.56ms

---

## 遗留与后续

- Phase 5 继续：拆分 `HistoryListView.swift`（列表/Row/Thumbnail/HoverPreview 分文件）
- （可选）拆分 `AppState`（History/Settings ViewModel）

