# v0.43.32（Preview：括号内下标/上标公式更鲁棒）

日期：2025-12-16

## 背景

部分内容（常见于论文/笔记的“可复算”段落）使用 `(...)` 包裹公式，但公式内部只有 `T_{io}` / `T_{step}^{base}` 这类 TeX 下标/上标写法，并不包含 `\mathcal` 等反斜杠命令。

此前 hover 预览的 “loose LaTeX” 识别主要依赖反斜杠命令信号，导致这类 `(...)` 片段未被补齐 `$...$` delimiter，KaTeX 不会渲染。

## 变更

- **公式识别增强**：当文本包含 `_`/`^` 且满足较强数学信号（如包含 `{`、数字、或 `=`）时，也会启用括号公式包裹逻辑。
  - 例：`(T_{io}=12.4)ms` → `$\\left(T_{io}=12.4\\right)$ms`
- **防误判**：对类似 `(foo_bar)` 的普通标识符（无 `{}`、无数字、无 `=`）不进行包裹，降低误触发概率。

## 测试

- 新增回归用例：覆盖 `(T_{io}=12.4)ms` / `(T_{aug}=47.8)ms` / `(T_{data}=60.2)ms` 这类无反斜杠的下标/上标公式。
- 新增负向用例：`(foo_bar)` 不应被包裹为数学公式。

## 修改文件

- `Scopy/Views/History/MathNormalizer.swift`
- `ScopyTests/MarkdownMathRenderingTests.swift`
- `doc/implementation/README.md`
- `doc/implementation/CHANGELOG.md`

