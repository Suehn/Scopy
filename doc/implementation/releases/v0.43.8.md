# v0.43.8 - Fix/UX：悬浮预览首帧不正确 + 不刷新（图片/文本）

**日期**: 2025-12-14

---

## 一页纸总结

### What

- **修复 hover 图片预览“先出现小缩略图/转圈，且经常要移开再悬停才变正常预览”的体验问题**。
- **修复 hover 文本预览“第一次总是显示 (Empty)，第二次才正常”的问题**。

### Why

- SwiftUI 的 `.popover(isPresented:)` 在部分场景下会更像“展示时快照”：当内容依赖父视图的 `@State` 值在展示后变化时，popover 内容未必会即时刷新，导致：
  - 图片：popover 首帧只能拿到缩略图占位，后续 preview 数据到达但 UI 不更新 → 需要“重悬停”才能看到正常预览。
  - 文本：popover 首帧拿到 `nil` → 显示 `(Empty)`，后续生成的内容未刷新。
- 同时，图片预览视图之前对“小图（缩略图）”采取“按原始像素展示不缩放”的策略，导致占位图在 popover 中看起来非常小。

### Result

- 引入 `HoverPreviewModel`（`ObservableObject`）作为 row ↔ popover 的共享预览状态源，popover 在展示期间也能订阅更新，实现“首帧占位 → 数据就绪后原地无缝替换”。
- 图片预览统一按预览区域 `fit` 渲染：即使首帧是缩略图占位，也会按 popover 尺寸显示，不再出现“小缩略图当预览”的体感。
- 文本预览 `nil` 期间显示 `ProgressView`，避免误报 `(Empty)`。
- 回归通过：
  - `make test-unit`：**57 passed**, 1 skipped（58 total）
  - `make test-perf`：**16 passed**, 6 skipped（22 total）
  - `make test-tsan`：**137 passed**, 1 skipped（138 total）
  - `make test-strict`：**165 passed**, 7 skipped（172 total）

---

## 实现路线

1. 新增 `HoverPreviewModel`：用 `@Published` 承载图片/文本预览内容，确保 popover 可订阅更新。
2. `HistoryItemView`：hover 预览产物写入 `previewModel`，并在退出/滚动/消失时清理；图片预取在 delay 期间完成后提前写入 `previewModel.imageData`，让 popover 首帧更容易直接显示预览图。
3. `HistoryItemImagePreviewView`：改为订阅 `previewModel.imageData`（避免依赖 popover 展示时值快照），并统一按预览区域 `fit` 显示（缩略图占位也会放大显示）。
4. `HistoryItemTextPreviewView`：订阅 `previewModel.text`；`nil` 时展示 `ProgressView`，避免首帧误显示 `(Empty)`。

---

## 核心改动

- `Scopy/Views/History/HoverPreviewModel.swift`
- `Scopy/Views/History/HistoryItemView.swift`
- `Scopy/Views/History/HistoryItemImagePreviewView.swift`
- `Scopy/Views/History/HistoryItemTextPreviewView.swift`

---

## 关键指标

### 测试

- 单元测试：`make test-unit`（57 passed, 1 skipped）
- 性能测试：`make test-perf`（16 passed, 6 skipped；heavy 需 `RUN_HEAVY_PERF_TESTS=1`）
- Thread Sanitizer：`make test-tsan`（137 passed, 1 skipped）
- Strict Concurrency：`make test-strict`（165 passed, 7 skipped）

### 性能（Debug / `make test-perf` 单次运行）

- 环境：MacBook Air（Apple M3, 24 GB）/ macOS 15.7.2（24G325）/ arm64 / 2025-12-14
- 电源：Low Power Mode enabled（`pmset -g` 显示 `lowpowermode 1`）
- 关键结果：
  - Fuzzy 5k items P95 ≈ 8.40ms
  - Fuzzy 10k items P95 ≈ 76.10ms（Samples: 50；Low Power Mode 下测试阈值放宽至 300ms）
  - Disk 25k fuzzy P95 ≈ 103.79ms（Samples: 50；Low Power Mode enabled）
  - Bulk insert 1000 items ≈ 83.63ms（≈11,957 items/s；Low Power Mode enabled）
  - Fetch recent (50 items) avg ≈ 0.11ms
  - Regex 20k items P95 ≈ 5.26ms
  - Mixed content disk search（single run）≈ 7.47ms

---

## 当前状态（快速检查）

- ✅ `make test-unit`
- ✅ `make test-perf`
- ✅ `make test-tsan`
- ✅ `make test-strict`

---

## 遗留与后续

- 预览的 `maxHeight` 当前为视图内常量（400pt）；若后续希望与设置项/屏幕大小联动，可将其收敛到 `ScopySize` 常量并按屏幕自适应。

