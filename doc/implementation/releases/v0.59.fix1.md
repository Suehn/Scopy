# v0.59.fix1

## 📌 一页纸总结（What / Why / Result）

### What

- Correctness/Robustness：fullIndex 磁盘缓存 hardening（DB/WAL/SHM fingerprint + `*.sha256`）+ `mutation_seq` change token 兜底，保证“full-history 不漏项”。
- Perf/Search：upsert tombstone 衰退兜底（触发 stale + 后台重建）、deep paging bounded top-K 缓存、shortQueryIndex tombstone 比例触发重建、close 写盘后台化。
- Test：补齐磁盘缓存/外部写入/队列清理/衰退阈值等回归覆盖。

### Why

- 磁盘缓存是 best-effort 的冷启动提速手段，但需要对“截断/损坏/越界 postings”等情况更鲁棒，且必须做到校验失败时 **自动回退重建**。
- 实际运行中存在“漏回调/外部写入/清理事务”等可能导致 SearchEngine 的内存索引缺项；需要有可比较的 change token 来保证 full-history correctness。
- 增量更新长期运行会积累 tombstone；以及 deep paging 容易引入无界内存/重复扫描，需要成本上界。

### Result

- 冷启动对照（本地，DEBUG，真实 DB `~/Library/Application Support/Scopy/clipboard.db` ≈ 145.9MB；`make test-real-db` 输出；`hw.model=Mac15,12`；macOS 26.3（25D5101c）；Xcode 26.2（17C52）；2026-01-19）：
  - prefilter：~2.06ms
  - prefilter + 后台预热后 refine：~18.09ms
  - 冷启动直接 refine（无预热）：~3105.86ms
  - 冷启动重建 refine（无缓存）：~2274.50ms
  - 磁盘缓存加载 refine：~905.25ms（缓存文件 `clipboard.db.fullindex.v3.plist` ≈ 39.1MB，旁路校验 `*.sha256`）
- 测试：`make test-unit` / `make test-strict` / `make test-real-db` ✅（见下方“当前状态”）

---

## 🏗️ 实现路线

1. DB 侧新增 `scopy_meta.mutation_seq`（commit counter，user_version=5）。
2. 写事务统一收口并在 commit 后 bump `mutation_seq`，使 change token 单调可比。
3. SearchEngine 使用 change token 在搜索/回调路径做“未观测提交”检测，触发时丢弃内存索引并回退 SQL 扫描/重建。
4. fullIndex 磁盘缓存升级 v3：加入 DB/WAL/SHM fingerprint + `*.sha256`，并做轻量 postings 结构校验；加载失败自动回退重建；写盘改后台任务（close 仅做 time budget 等待）。
5. 增加回归/硬化测试：checksum、postings 越界、pending 清理、tombstone 阈值、外部写入兜底等。

---

## 📂 核心改动

- `Scopy/Infrastructure/Search/SearchEngineImpl.swift`
  - fullIndex disk cache v3（fingerprint + `*.sha256` + postings 校验）
  - `mutation_seq` change token：外部写入/漏回调检测并回退重建
  - upsert tombstone stale + 后台重建；deep paging bounded top-K；close 写盘后台化
- `Scopy/Infrastructure/Persistence/SQLiteMigrations.swift`
  - 新增 `scopy_meta`（`mutation_seq`），user_version=5
- `Scopy/Infrastructure/Persistence/SQLiteClipboardRepository.swift`
  - 写事务统一收口 + commit bump `mutation_seq`
- `ScopyTests/*`
  - `FullIndexDiskCacheHardeningTests` / `KnownDataVersionExternalWriteTests` / `FullIndexPendingEventsCleanupTests` / `FullIndexTombstoneUpsertStaleTests`
  - `SearchServiceTests`：短词 index tombstone 重建回归

---

## 🎯 关键指标

- `make test-unit`：Executed 266 tests, 1 skipped, 0 failures（2026-01-19）
- `make test-strict`：Executed 266 tests, 1 skipped, 0 failures（2026-01-19）
- `make test-real-db`：Executed 2 tests, 0 failures（2026-01-19）

---

## 📊 当前状态

- 构建：`make build` ✅（2026-01-19）
- 单测：`make test-unit` ✅（Executed 266 tests, 1 skipped, 0 failures，2026-01-19）
- Strict Concurrency：`make test-strict` ✅（Executed 266 tests, 1 skipped, 0 failures，2026-01-19）
- 真实 DB 对照回归：`make test-real-db` ✅（Executed 2 tests, 0 failures，2026-01-19）

---

## 🔮 后续 TODO

- [ ] deep paging：明确超深 offset（>50k）语义与兜底策略（限制 offset / fallback 全量排序 / 分段扫描），避免“空页但 hasMore=true”类边界问题。
- [ ] 写锁竞争：评估是否需要为写连接加 `busy_timeout` 或重试策略（多实例/外部写入场景）。
- [ ] 冷启动进一步压缩：探索更紧凑的自定义二进制格式 + mmap（只优化序列化/反序列化，不改语义）。
- [ ] 磁盘缓存写入节流：避免频繁写 40MB 级文件（合并/节流/仅在 idle 持久化）。
