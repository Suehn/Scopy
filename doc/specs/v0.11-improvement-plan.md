# v0.11 改进计划 - 性能/稳定性/测试

## 概述

基于 v0.10.8 深度代码审核的发现，本文档整理后续需要改进的点，按优先级分类。

**更新日期**: 2025-11-29
**实施状态**: Phase 1-3 核心任务已完成

---

## 一、性能优化 (Performance)

### P1 - 高优先级

#### 1.1 清理性能验证 ✅ 已完成
**现状**: v0.10.8 已优化批量删除，但未验证是否达到 ≤500ms 目标
**计划**:
- [x] 添加清理性能基准测试 `testInlineCleanupPerformance10k` (P95 < 300ms)
- [x] 添加清理性能基准测试 `testExternalCleanupPerformance10k` (P95 < 800ms)
- [x] 添加清理性能基准测试 `testCleanupPerformance50k` (P95 < 1500ms)

**文件**: `ScopyTests/PerformanceTests.swift`

#### 1.2 FTS5 COUNT 缓存实际应用 ✅ 已完成
**现状**: v0.10.8 添加了缓存辅助方法，但未在搜索中实际使用
**计划**:
- [x] 在 `searchWithFTS` 中使用 `getCachedTotal`
- [x] 在 `searchAllWithFilters` 中使用缓存
- [ ] 添加缓存命中率监控 (延后)

**文件**: `Scopy/Services/SearchService.swift`

```swift
// 示例改动
private func searchWithFTS(...) async throws -> SearchResult {
    // 先检查缓存
    var total = getCachedTotal(for: request, query: query)

    if total == nil {
        // 缓存未命中，执行 COUNT 查询
        let countSQL = "SELECT COUNT(*) FROM (\(sql))"
        // ...
        cacheTotal(total!, for: request, query: query)
    }
    // ...
}
```

### P2 - 中优先级

#### 1.3 图片指纹碰撞优化
**现状**: 四角像素指纹可能碰撞（两张不同图片相同尺寸+四角像素）
**计划**:
- [ ] 添加中心像素采样
- [ ] 添加中间四象限采样
- [ ] 降低碰撞率从 ~1-2% 到 <0.1%

**文件**: `Scopy/Services/ClipboardMonitor.swift:507-520`

```swift
// 改进方案
nonisolated static func computeImageFingerprint(_ imageData: Data) -> String? {
    // 采样：四角 + 中心 + 中间四个象限
    let corners = extractCornerPixelsHash(...)
    let center = extractCenterPixelsHash(...)

    return "img:\(width)x\(height):\(corners):\(center)"
}
```

#### 1.4 App 图标后台预加载
**现状**: 首次显示新 app 图标时可能卡顿（NSWorkspace 调用）
**计划**:
- [ ] 启动时后台预加载常用 app 图标
- [ ] 基于 `recentApps` 列表预加载
- [ ] 添加预加载完成回调

**文件**: `Scopy/Views/HistoryListView.swift`

#### 1.5 搜索结果原子性更新
**现状**: 搜索结果状态更新非原子，UI 可能读取中间状态
**计划**:
- [ ] 使用结构体包装搜索状态
- [ ] 原子更新整个状态

**文件**: `Scopy/Observables/AppState.swift`

```swift
// 改进方案
struct SearchState {
    var items: [ClipboardItemDTO]
    var totalCount: Int
    var loadedCount: Int
    var canLoadMore: Bool
}

// 原子更新
searchState = SearchState(
    items: result.items,
    totalCount: result.total,
    loadedCount: result.items.count,
    canLoadMore: result.hasMore
)
```

---

## 二、稳定性改进 (Stability)

### P1 - 高优先级

#### 2.1 搜索超时实际应用 ✅ 已完成
**现状**: v0.10.8 添加了 `runOnQueueWithTimeout`，但未在搜索中使用
**计划**:
- [x] 在 `searchWithFTS` 中使用超时版本
- [x] 在 `searchAllWithFilters` 中使用超时版本
- [ ] 添加超时错误处理 UI (延后)

**文件**: `Scopy/Services/SearchService.swift`

#### 2.2 数据库连接健壮性 ✅ 已完成
**现状**: `open()` 中途失败可能导致半打开状态
**计划**:
- [x] 使用临时变量存储连接
- [x] 失败时确保清理
- [x] 添加 WAL 检查点管理 (`performWALCheckpoint()`)

**文件**: `Scopy/Services/StorageService.swift:108-168`

```swift
// 改进方案
func open() throws {
    guard db == nil else { return }

    var tempDb: OpaquePointer?
    if sqlite3_open(dbPath, &tempDb) != SQLITE_OK {
        if let db = tempDb {
            sqlite3_close(db)
        }
        throw StorageError.queryFailed("Failed to open database")
    }

    self.db = tempDb

    do {
        try execute("PRAGMA journal_mode = WAL")
        // ...
    } catch {
        sqlite3_close(self.db)
        self.db = nil
        throw error
    }
}
```

### P2 - 中优先级

#### 2.3 HotKeyService 日志轮转 ✅ 已完成
**现状**: 日志文件无限增长，无轮转机制
**计划**:
- [x] 添加文件锁保护 (`logLock`)
- [x] 实现 10MB 日志轮转
- [x] 保留最近 2 个日志文件 (`.log` 和 `.log.old`)

**文件**: `Scopy/Services/HotKeyService.swift:4-42`

#### 2.4 图片处理内存管理 ✅ 已完成
**现状**: CGContext 创建的内存在函数结束时释放，大图片可能导致内存峰值
**计划**:
- [x] 使用 `autoreleasepool` 管理内存
- [ ] 考虑内存池复用 (延后)

**文件**: `Scopy/Services/ClipboardMonitor.swift:544-653`

#### 2.5 Timer 线程安全 ⏭️ 跳过
**现状**: `pollingInterval` 可能被其他线程修改
**审查结论**: `ClipboardMonitor` 已是 `@MainActor` 隔离，所有属性访问都在主线程，不需要额外的 NSLock

**文件**: `Scopy/Services/ClipboardMonitor.swift:111-117`

---

## 三、测试补充 (Testing)

### P1 - 高优先级

#### 3.1 性能测试补充 ✅ 已完成

**新增测试** (`ScopyTests/PerformanceTests.swift`):
- [x] `testInlineCleanupPerformance10k` - 内联存储清理 (P95 < 300ms)
- [x] `testExternalCleanupPerformance10k` - 外部存储清理 (P95 < 800ms)
- [x] `testCleanupPerformance50k` - 大规模清理 (P95 < 1500ms)

#### 3.2 并发测试补充 ✅ 已完成

**新增测试** (`ScopyTests/ConcurrencyTests.swift`):
- [x] `testConcurrentSearchStress` - 10 个并发搜索请求
- [x] `testSearchResultConsistency` - 相同查询结果一致性
- [x] `testSearchTimeout` - 搜索超时机制验证
- [x] `testConcurrentCleanupAndSearch` - 并发清理和搜索安全性

### P2 - 中优先级

#### 3.3 功能测试补充 ✅ 已完成

**新增测试** (`ScopyTests/AppStateTests.swift`):
- [x] `testHighlightNextOnEmptyListDoesNotCrash` - 空列表导航
- [x] `testHighlightPreviousOnEmptyListDoesNotCrash` - 空列表导航
- [x] `testHighlightNextOnSingleItem` - 单项列表导航
- [x] `testHighlightPreviousOnSingleItem` - 单项列表导航
- [x] `testNavigationAfterSelectedItemDeleted` - 删除后导航
- [x] `testRapidNavigationDoesNotCrash` - 快速连续导航
- [x] `testDeleteSelectedItemSelectsNext` - 删除选中项后选中下一项
- [x] `testDeleteLastItemSelectsPrevious` - 删除最后一项时选中前一项
- [x] `testDeleteOnlyItemClearsSelection` - 删除唯一项后选中为空

#### 3.4 内存泄漏测试

```swift
// ScopyTests/ResourceCleanupTests.swift

// 1. 长时间运行内存测试
func testMemoryStabilityLongRunning() async throws {
    // 模拟 1000 次操作
    // 验证内存增长 < 50MB
}

// 2. 图标缓存溢出测试
func testIconCacheLRUEviction() {
    // 创建 100+ 个不同 app 的项目
    // 验证缓存大小 <= 50
}

// 3. 服务启动/停止循环测试
func testServiceStartStopCycle() async throws {
    // 启动/停止 100 次
    // 验证没有内存泄漏
}
```

---

## 四、实施计划

### Phase 1: 核心功能修复 ✅ 已完成

| 任务 | 优先级 | 状态 |
|------|--------|------|
| FTS5 COUNT 缓存应用 | P0 | ✅ 完成 |
| 搜索超时实际应用 | P0 | ✅ 完成 |
| 数据库连接健壮性 | P0 | ✅ 完成 |
| WAL 检查点管理 | P1 | ✅ 完成 |

### Phase 2: 测试补充 ✅ 已完成

| 任务 | 优先级 | 状态 |
|------|--------|------|
| 清理性能基准测试 (10k/50k) | P1 | ✅ 完成 |
| 并发搜索压力测试 | P1 | ✅ 完成 |
| 搜索结果一致性测试 | P1 | ✅ 完成 |
| 键盘导航边界测试 | P1 | ✅ 完成 |

### Phase 3: 稳定性改进 ✅ 已完成

| 任务 | 优先级 | 状态 |
|------|--------|------|
| HotKeyService 日志轮转 | P1 | ✅ 完成 |
| 图片处理内存管理 | P2 | ✅ 完成 |
| Timer 线程安全 | P2 | ⏭️ 跳过 (已有 @MainActor 保护) |

### 延后任务

| 任务 | 优先级 | 原因 |
|------|--------|------|
| 图片指纹碰撞优化 | P2 | 影响有限，可后续优化 |
| 搜索结果原子性更新 | P2 | 当前实现可接受 |
| App 图标后台预加载 | P3 | 优化体验，非必须 |
| 缓存命中率监控 | P3 | 可后续添加 |
| 超时错误处理 UI | P3 | 可后续添加 |
| 内存泄漏测试 | P2 | 可后续添加 |

---

## 五、验收标准

### 性能指标

| 场景 | 目标 |
|------|------|
| 清理 10k 项 | P95 < 500ms |
| 清理 50k 项 | P95 < 1000ms |
| 搜索 100k 项 | P95 < 300ms |
| 图片指纹碰撞率 | < 0.1% |

### 测试覆盖

| 类型 | 目标 |
|------|------|
| 单元测试通过率 | 100% (排除边界性能测试) |
| 性能测试覆盖 | 5k/10k/25k/50k/75k/100k |
| 并发测试覆盖 | 10+ 并发场景 |
| 内存泄漏测试 | 1000+ 操作无泄漏 |

### 稳定性指标

| 场景 | 目标 |
|------|------|
| 搜索超时保护 | 5s 超时 |
| 数据库连接恢复 | 失败后自动清理 |
| 日志文件大小 | < 10MB |

---

## 六、风险与依赖

### 风险

1. **100k 搜索性能** - 可能需要分片或增量索引
2. **图片指纹改动** - 可能影响现有去重逻辑
3. **并发测试稳定性** - CI 环境可能不稳定

### 依赖

1. 需要先完成测试补充，再进行性能优化
2. 数据库连接改动需要充分测试

---

## 七、v0.11 实施总结

### 核心改动文件

| 文件 | 改动内容 |
|------|----------|
| `Scopy/Services/SearchService.swift` | FTS5 COUNT 缓存应用、搜索超时、缓存失效方法 |
| `Scopy/Services/StorageService.swift` | 数据库连接健壮性、WAL 检查点管理 |
| `Scopy/Services/HotKeyService.swift` | 日志轮转（10MB 限制、线程安全） |
| `Scopy/Services/ClipboardMonitor.swift` | 图片处理 autoreleasepool |
| `ScopyTests/PerformanceTests.swift` | 清理性能基准测试 (10k/50k) |
| `ScopyTests/ConcurrencyTests.swift` | 并发搜索压力测试、超时测试 |
| `ScopyTests/AppStateTests.swift` | 键盘导航边界测试 |

### 新增测试用例

- `testInlineCleanupPerformance10k`
- `testExternalCleanupPerformance10k`
- `testCleanupPerformance50k`
- `testConcurrentSearchStress`
- `testSearchResultConsistency`
- `testSearchTimeout`
- `testConcurrentCleanupAndSearch`
- `testHighlightNextOnEmptyListDoesNotCrash`
- `testHighlightPreviousOnEmptyListDoesNotCrash`
- `testHighlightNextOnSingleItem`
- `testHighlightPreviousOnSingleItem`
- `testNavigationAfterSelectedItemDeleted`
- `testRapidNavigationDoesNotCrash`
- `testDeleteSelectedItemSelectsNext`
- `testDeleteLastItemSelectsPrevious`
- `testDeleteOnlyItemClearsSelection`

---

**创建日期**: 2025-11-28
**更新日期**: 2025-11-29
**维护者**: Claude Code
**关联版本**: v0.10.8 → v0.11
**实施状态**: Phase 1-3 核心任务已完成
