# Profile: v0.50.fix7 → v0.50.fix8

> 目标：建立滚动性能基线与分层瓶颈画像（frame time / drop ratio / scroll speed）。

## ✅ 改动摘要

- 增加滚动采样（frame interval + drop ratio + scroll speed）。
- 增加文本/图片/hover 耗时桶。
- Mock 数据规模可配置，支持场景矩阵。

## 🧪 测试环境

- 硬件：Apple M3，24GB
- 系统：macOS 15.7.2（24G325）
- Xcode：16.3（16E140）
- 构建：Debug

## 📊 基线场景矩阵（建议）

| 场景 | 环境变量 | 目的 |
|------|----------|------|
| Text-only | `SCOPY_MOCK_ITEM_COUNT=10000` `SCOPY_MOCK_IMAGE_COUNT=0` | 基础文本滚动 |
| Images on | `SCOPY_MOCK_IMAGE_COUNT=2000` `SCOPY_MOCK_SHOW_THUMBNAILS=1` | 图像缩略图影响 |
| Long text | `SCOPY_MOCK_TEXT_LENGTH=4096` | 布局/文本处理压力 |
| Accessibility on | `SCOPY_PROFILE_ACCESSIBILITY=1` | 辅助功能树影响 |

## 🧾 采样输出

- 输出文件：`/tmp/scopy_scroll_profile.json`（UI test 会使用 `/tmp/scopy_scroll_profile_<uuid>.json`）
- 字段：
  - `profile_scenario`
  - `frame_ms`: count/min/avg/p50/p95/max
  - `drop_ratio`
  - `scroll_speed_px_per_sec`: p50/p95
  - `buckets_ms`: text/title, text/metadata, image/thumbnail, hover/preview, hover/markdown
  - 可选基准：`SCOPY_PROFILE_EXPECTED_FRAME_MS=16.7`（60fps 目标）

## 🧪 运行方式（示例）

```bash
touch /tmp/scopy_run_profile_ui_tests
SCOPY_SCROLL_PROFILE=1 \
SCOPY_PROFILE_OUTPUT=/tmp/scopy_scroll_profile.json \
SCOPY_PROFILE_DURATION_SEC=6 \
SCOPY_PROFILE_MIN_SAMPLES=180 \
SCOPY_MOCK_ITEM_COUNT=10000 \
SCOPY_MOCK_IMAGE_COUNT=2000 \
SCOPY_MOCK_TEXT_LENGTH=512 \
SCOPY_MOCK_SHOW_THUMBNAILS=1 \
SCOPY_PROFILE_SCENARIO=baseline-image-accessibility \
SCOPY_RUN_PROFILE_UI_TESTS=1 xcodebuild test -scheme Scopy -destination 'platform=macOS' \
  -only-testing:ScopyUITests/HistoryListUITests
```

## 📈 结果记录

- baseline-image-accessibility
  - 输出文件：`/tmp/scopy_scroll_profile_baseline-image-accessibility_9753D6C6-F64B-4711-84DE-DA01F5B8AD23.json`
  - 帧间隔（ms）：count 316, min 8.33, avg 19.01, p50 16.67, p95 16.67, max 341.67
  - drop_ratio：0.01899（≈1.90%）
  - scroll_speed_px_per_sec（样本数 2）：p50 30.00, p95 30.00, avg 27.00, min 24.00, max 30.00
  - buckets_ms：
    - text.title_ms：p50 0.0020, p95 0.0110, avg 0.0036（count 11）
    - text.metadata_ms：p50 0.0249, p95 0.2110, avg 0.0358（count 20）
    - image.thumbnail_decode_ms：p50 18.15, p95 18.32, avg 17.96（count 39）
- image-heavy-no-accessibility
  - 输出文件：`/tmp/scopy_scroll_profile_image-heavy-no-accessibility_B3ACE135-1112-429B-A466-C24FE0D55F37.json`
  - 帧间隔（ms）：count 311, min 8.33, avg 19.35, p50 16.67, p95 25.00, max 325.00
  - drop_ratio：0.02251（≈2.25%）
  - scroll_speed_px_per_sec（样本数 2）：p50 34.29, p95 34.29, avg 27.14, min 20.00, max 34.29
  - buckets_ms：
    - text.title_ms：p50 0.0031, p95 0.0100, avg 0.0044（count 11）
    - text.metadata_ms：p50 0.0260, p95 0.2041, avg 0.0368（count 20）
    - image.thumbnail_decode_ms：p50 6.48, p95 6.49, avg 6.44（count 39）
- text-only
  - 输出文件：`/tmp/scopy_scroll_profile_text-only_9A7CFFCF-385A-41CC-9C8F-4B6131D8A183.json`
  - 帧间隔（ms）：count 309, min 8.33, avg 19.44, p50 16.67, p95 25.00, max 350.00
  - drop_ratio：0.02265（≈2.27%）
  - scroll_speed_px_per_sec（样本数 2）：p50 30.00, p95 30.00, avg 27.00, min 24.00, max 30.00
  - buckets_ms：
    - text.title_ms：p50 0.0030, p95 0.0060, avg 0.0031（count 20）
    - text.metadata_ms：p50 0.1900, p95 0.8340, avg 0.3702（count 20）

> 说明：scroll speed 样本数偏少（UI 测试滚动次数有限），仅作趋势参考；本次 scroll 使用 window swipe 兜底以稳定命中滚动区域。

## 🔎 结论

- 已建立滚动基线与场景对比，frame P50≈16.7ms，P95≈16.7–25.0ms；存在少量长尾卡顿（max≈350ms）。
- text-only 场景 metadata 计算耗时上升（p95≈0.83ms），适合作为文本路径压力基线。
- image-heavy 场景缩略图解码约 6–18ms/次，仍是可见耗时项之一。
