# v0.59.fix3 - Performance Profile

日期：2026-01-29

环境：
- `hw.model=Mac15,12`
- macOS 26.3（25D5112c）
- Xcode 26.2（17C52）
- 快照库：`perf-db/clipboard.db`（6421 items；≈ 148.6MB）

## 结论（摘要）

- **短词（≤2 chars）更稳**：候选分页由全量排序改为 top‑K heap（O(k log k) → O(k log K)），在 k 较大/深分页时更稳定。
- **消除周期性 O(n) 聚合抖动**：corpus metrics 不再按时间刷新，只在 stale/force 时计算，避免无变更时的交互抖动。
- **统计读侧 O(1)**：`item_count/total_size_bytes` 等通过 `scopy_meta` 精确维护，避免大库下 COUNT/SUM 成为固定成本。

## 指标

### ScopyBench（release，SearchEngine 直测，warmup=20 / iters=30）

数据：`logs/perf-audit-2026-01-29_03-22-58/scopybench.jsonl`

| query | mode | sort | P95 (ms) | avg (ms) |
|------|------|------|----------|----------|
| `cm` | fuzzyPlus | relevance | 5.58 | 5.17 |
| `数学` | fuzzyPlus | relevance | 9.15 | 8.73 |
| `cmd` | fuzzyPlus | relevance | 0.14 | 0.11 |
| `cm` | fuzzyPlus | relevance（forceFullFuzzy） | 5.43 | 5.20 |

### ScopyBench（release，ClipboardService 端到端）

数据：`logs/perf-audit-2026-01-29_03-22-58/scopybench.service.jsonl`

| query | mode | sort | P95 (ms) | avg (ms) |
|------|------|------|----------|----------|
| `cm` | fuzzyPlus | relevance | 5.62 | 5.14 |
| `数学` | fuzzyPlus | relevance | 9.47 | 8.88 |
| `cmd` | fuzzyPlus | relevance | 0.12 | 0.11 |

### PerformanceTests（`make test-perf`）

数据：`logs/test-perf.log`

- 5k（fuzzyPlus）：P95 4.81ms；cold 82.11ms
- 10k（fuzzyPlus）：P95 25.15ms；cold 191.60ms
- Disk 25k（fuzzyPlus）：P95 52.74ms；cold 795.69ms
- Service Disk 10k（fuzzyPlus）：P95 22.06ms；cold 287.59ms

## 复现命令

```bash
make test-perf
bash scripts/perf-audit.sh --skip-tests --bench-metrics
```

