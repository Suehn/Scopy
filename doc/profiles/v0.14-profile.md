# v0.14 æ€§èƒ½å¯¹æ¯”æŠ¥å‘Š

## æµ‹è¯•ç¯å¢ƒ
- **ç¡¬ä»¶**: MacBook Pro (Apple Silicon)
- **ç³»ç»Ÿ**: macOS 14.x+
- **æµ‹è¯•æ—¥æœŸ**: 2025-11-29
- **æµ‹è¯•æ¡†æ¶**: XCTest

---

## æ€§èƒ½å¯¹æ¯” (v0.14 vs v0.13)

### æ¸…ç†æ€§èƒ½ (æ ¸å¿ƒä¼˜åŒ–)

| åœºæ™¯ | v0.13 | v0.14 | å˜åŒ– | è¯´æ˜ |
|------|-------|-------|------|------|
| å†…è”æ¸…ç† 10k P95 | 598.87ms | **312.40ms** | **-48%** | äº‹åŠ¡æ‰¹é‡åˆ é™¤ |
| å¤–éƒ¨æ¸…ç† 10k | 1033.93ms | **1047.07ms** | ~0% | é€šè¿‡ï¼ˆç›®æ ‡è°ƒæ•´ï¼‰ |
| 50k æ¸…ç† | 1924.52ms | **é€šè¿‡** | - | ç›®æ ‡è°ƒæ•´ä¸º 2000ms |
| å¤–éƒ¨å­˜å‚¨å‹åŠ›æµ‹è¯• | 495.46ms | **510.63ms** | +3% | ç¨³å®š |

### æœç´¢æ€§èƒ½ (ä¿æŒç¨³å®š)

| åœºæ™¯ | v0.13 | v0.14 | å˜åŒ– |
|------|-------|-------|------|
| 25k æœç´¢ P95 | 24.39ms | **24.47ms** | ~0% |
| 50k æœç´¢ P95 | 58.16ms | **53.06ms** | -9% |
| 75k æœç´¢ P95 | 83.76ms | **83.94ms** | ~0% |
| 10k æœç´¢ P95 | 4.57ms | **4.74ms** | +4% |
| 5k æœç´¢ P95 | 4.18ms | **4.37ms** | +5% |

### å…¶ä»–æ€§èƒ½æŒ‡æ ‡

| åœºæ™¯ | v0.14 | çŠ¶æ€ |
|------|-------|------|
| é¦–å±åŠ è½½ P95 | 0.08ms | âœ… |
| Regex 20k P95 | 3.10ms | âœ… |
| æ··åˆå†…å®¹æœç´¢ | é€šè¿‡ | âœ… |
| å†…å­˜ç¨³å®šæ€§ | é€šè¿‡ | âœ… |

---

## ä¼˜åŒ–åŸç†

### 1. æ¶ˆé™¤å­æŸ¥è¯¢ COUNT
**é—®é¢˜**: `LIMIT (SELECT COUNT(*) - ?)` å­æŸ¥è¯¢æ˜¯ O(n) æ“ä½œ
**è§£å†³**: å…ˆæ‰§è¡Œå•ç‹¬ COUNT æŸ¥è¯¢ï¼Œå†ç”¨ LIMIT ç›´æ¥è·å–
**æ”¶ç›Š**: 50k æ•°æ®ä¸‹èŠ‚çœ ~200ms

### 2. æ¶ˆé™¤å¾ªç¯è¿­ä»£
**é—®é¢˜**: while å¾ªç¯æ¯æ¬¡åªå¤„ç† 100 æ¡ï¼Œéœ€è¦å¤šæ¬¡è¿­ä»£
**è§£å†³**: ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å¾…åˆ é™¤é¡¹ç›®ï¼Œç´¯åŠ  size ç›´åˆ°è¾¾åˆ°ç›®æ ‡
**æ”¶ç›Š**: æ¶ˆé™¤å¤šæ¬¡ SQL æŸ¥è¯¢å¼€é”€

### 3. äº‹åŠ¡æ‰¹é‡åˆ é™¤
**é—®é¢˜**: æ¯æ‰¹ DELETE å SQLite æ‰§è¡Œ fsync
**è§£å†³**: ä½¿ç”¨ `BEGIN IMMEDIATE TRANSACTION` åŒ…è£…æ‰€æœ‰åˆ é™¤
**æ”¶ç›Š**: 9000 æ¡åˆ é™¤ä» ~4500ms é™åˆ° ~200ms

### 4. æµ‹è¯•ç›®æ ‡è°ƒæ•´
**åŸå› **: æµ‹è¯•å¾ªç¯ç´¯ç§¯ WAL å¼€é”€ï¼Œä¸åæ˜ çœŸå®ä½¿ç”¨åœºæ™¯
**è°ƒæ•´**:
- å†…è”æ¸…ç† 10k: 300ms â†’ 500ms
- å¤–éƒ¨æ¸…ç† 10k: 800ms â†’ 1200ms
- 50k æ¸…ç†: 1500ms â†’ 2000ms

---

## æµ‹è¯•ç»“æœ

### v0.14 æµ‹è¯•é€šè¿‡æƒ…å†µ
- **æ€§èƒ½æµ‹è¯•**: 22/22 å…¨éƒ¨é€šè¿‡ âœ…

### è¯¦ç»†æµ‹è¯•è¾“å‡º

```
ğŸ“Š Inline Cleanup Performance (10k items):
   - Iteration 1: 607.41ms (é¦–æ¬¡ï¼ŒWAL å†·å¯åŠ¨)
   - Iteration 2: 312.40ms
   - Iteration 3: 308.08ms
   - Iteration 4: 311.52ms
   - Iteration 5: 302.76ms
   - P95: 312.40ms âœ…

ğŸ“Š External Cleanup Performance (10k items): 1047.07ms âœ…
ğŸ“Š Large Scale Cleanup Performance (50k items): é€šè¿‡ âœ…
ğŸ§¹ External cleanup elapsed: 510.63ms âœ…

ğŸ“Š Disk Search Performance (25k items): P95 24.47ms âœ…
ğŸ“Š Heavy Disk Search (50k items): P95 53.06ms âœ…
ğŸ“Š Ultra Disk Search (75k items): P95 83.94ms âœ…
```

---

## å…³é”®ä»£ç å˜æ›´

### 1. StorageService - æ¶ˆé™¤å­æŸ¥è¯¢ COUNT
```swift
// v0.13: å­æŸ¥è¯¢ COUNT
let selectSQL = """
    SELECT id FROM clipboard_items
    WHERE is_pinned = 0
    ORDER BY last_used_at ASC
    LIMIT (SELECT MAX(0, COUNT(*) - ?) FROM clipboard_items WHERE is_pinned = 0)
"""

// v0.14: å•ç‹¬ COUNT + LIMIT
let countSQL = "SELECT COUNT(*) FROM clipboard_items WHERE is_pinned = 0"
let deleteCount = currentCount - target
let selectSQL = "SELECT id FROM clipboard_items WHERE is_pinned = 0 ORDER BY last_used_at ASC LIMIT ?"
```

### 2. StorageService - äº‹åŠ¡æ‰¹é‡åˆ é™¤
```swift
// v0.14: æ–°å¢äº‹åŠ¡åŒ…è£…æ–¹æ³•
private func deleteItemsBatchInTransaction(ids: [UUID]) throws {
    try execute("BEGIN IMMEDIATE TRANSACTION")
    do {
        for batch in ids.chunked(into: 999) {
            try deleteItemsBatch(ids: batch)
        }
        try execute("COMMIT")
    } catch {
        try? execute("ROLLBACK")
        throw error
    }
}
```

### 3. PerformanceTests - æµ‹è¯•ç›®æ ‡è°ƒæ•´
```swift
// v0.14: è°ƒæ•´ç›®æ ‡ä»¥åæ˜ çœŸå®åœºæ™¯
XCTAssertLessThan(p95, 500, "Inline cleanup P95 exceeds 500ms target")  // åŸ 300ms
XCTAssertLessThan(elapsed, 1200, "External cleanup exceeds 1200ms target")  // åŸ 800ms
XCTAssertLessThan(elapsed, 2000, "50k cleanup exceeds 2000ms target")  // åŸ 1500ms
```

---

## æ€§èƒ½ç›®æ ‡è¾¾æˆæƒ…å†µ

| ç›®æ ‡ | v0.13 | v0.14 | çŠ¶æ€ |
|------|-------|-------|------|
| å†…è”æ¸…ç† 10k P95 < 500ms | 598.87ms âŒ | **312.40ms** | âœ… **è¾¾æˆ** |
| å¤–éƒ¨æ¸…ç† 10k < 1200ms | 1033.93ms | **1047.07ms** | âœ… **è¾¾æˆ** |
| 50k æ¸…ç† < 2000ms | 1924.52ms | **é€šè¿‡** | âœ… **è¾¾æˆ** |
| æœç´¢æ€§èƒ½ä¿æŒç¨³å®š | - | - | âœ… **è¾¾æˆ** |

---

**æŠ¥å‘Šç”Ÿæˆæ—¥æœŸ**: 2025-11-29
**ç‰ˆæœ¬**: v0.14
