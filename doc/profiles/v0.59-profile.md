# v0.59 - Performance Profile

日期：2026-01-13

环境：
- `hw.model=Mac15,12`
- macOS 26.3（25D5087f）
- Xcode 26.2（17C52）
- 快照库：`perf-db/clipboard.db`（≈ 148.6MB）
- 真实库：`~/Library/Application Support/Scopy/clipboard.db`（≈ 148.6MB）

## 结论（摘要）

- 本次版本的主要收益来自 **冷启动首次 refine（forceFullFuzzy=true）**：通过 prefilter 命中后的后台预热，让首次 refine 从 2s+ 收敛到十几毫秒级；同时新增 fullIndex 磁盘缓存，把“冷启动直接 refine”从 2s+ 降到 ~0.86s。
- 稳态搜索（`ScopyBench`）指标保持在 v0.58 系列量级；并通过真实 DB 对照回归保证结果集合与排序一致（不漏项）。

## 指标

### 冷启动 refine（真实 DB，对照）

| 场景 | 指标 | 结果 |
|------|------|------|
| prefilter（FTS） | latency | ~1.30ms |
| prefilter + 后台预热后 refine | latency | ~16.33ms |
| 冷启动直接 refine（无预热） | latency | ~2305.90ms |
| 磁盘缓存加载 refine | latency | ~861.03ms |
| fullIndex 磁盘缓存文件 | size | ~38.8MB（`clipboard.db.fullindex.v2.plist`） |

### 稳态搜索（快照库，release `ScopyBench`）

| 场景 | 指标 | 结果 |
|------|------|------|
| fuzzyPlus + relevance + `cm` | avg / P95 | 4.89ms / 5.43ms |
| fuzzyPlus + relevance + `数学` | avg / P95 | 9.40ms / 11.82ms |
| fuzzyPlus + relevance + `cmd` | avg / P95 | 0.10ms / 0.11ms |
| fuzzy + relevance + forceFullFuzzy + `abc` | avg / P95 | 2.36ms / 2.51ms |

## 测试命令

- 冷启动对照：`make test-real-db`
- 稳态基准：`make snapshot-perf-db && make bench-snapshot-search`

## 备注

- 冷启动对照数据来自 DEBUG 测试构建的 `make test-real-db` 输出；稳态数据来自 release `ScopyBench`（warmup 20 / iters 30）。
- 若要进一步压缩“磁盘缓存加载 refine”的 0.86s 级延迟，优先方向是只优化序列化/反序列化（更紧凑格式 + mmap），保持语义不变。
